From 4b4cd5115e33d0ef2059a7d9868b0a280867cdf9 Mon Sep 17 00:00:00 2001
From: Kai Sommerfeld <kai.sommerfeld@gmx.com>
Date: Fri, 10 Aug 2018 18:35:25 +0200
Subject: [PATCH] Fix CApplicationPlayer::GetPercentage() to use new method
 CDataCacheCore::GetPercentage, which operates on consistent data

---
 xbmc/ApplicationPlayer.cpp   |  7 ++-----
 xbmc/cores/DataCacheCore.cpp | 15 +++++++++++++++
 xbmc/cores/DataCacheCore.h   |  7 +++++++
 3 files changed, 24 insertions(+), 5 deletions(-)

diff --git a/xbmc/ApplicationPlayer.cpp b/xbmc/ApplicationPlayer.cpp
index 99bfe4d71f91..65b7d46a1bd1 100644
--- a/xbmc/ApplicationPlayer.cpp
+++ b/xbmc/ApplicationPlayer.cpp
@@ -486,11 +486,8 @@ float CApplicationPlayer::GetPercentage() const
   std::shared_ptr<IPlayer> player = GetInternal();
   if (player)
   {
-    int64_t iTotalTime = GetTotalTime();
-
-    if (!iTotalTime)
-      return 0.0f;
-    return GetTime() * 100 / static_cast<float>(iTotalTime);
+    float fPercent = CDataCacheCore::GetInstance().GetPlayPercentage();
+    return std::max(0.0f, std::min(fPercent, 100.0f));
   }
   else
     return 0.0;
diff --git a/xbmc/cores/DataCacheCore.cpp b/xbmc/cores/DataCacheCore.cpp
index 012d1ff9a181..24be1ef681de 100644
--- a/xbmc/cores/DataCacheCore.cpp
+++ b/xbmc/cores/DataCacheCore.cpp
@@ -363,3 +363,18 @@ int64_t CDataCacheCore::GetMaxTime()
   CSingleLock lock(m_stateSection);
   return m_timeInfo.m_timeMax;
 }
+
+float CDataCacheCore::GetPlayPercentage()
+{
+  CSingleLock lock(m_stateSection);
+
+  // Note: To calculate accurate percentage, all time data must be consistent,
+  //       which is the case for data cache core. Calculation can not be done
+  //       outside of data cache core or a possibility to lock the data cache
+  //       core from outside would be needed.
+  int64_t iTotalTime = m_timeInfo.m_timeMax - m_timeInfo.m_timeMin;
+  if (iTotalTime <= 0)
+    return 0;
+
+  return m_timeInfo.m_time * 100 / static_cast<float>(iTotalTime);
+}
diff --git a/xbmc/cores/DataCacheCore.h b/xbmc/cores/DataCacheCore.h
index 622789c236fd..4eec17d0483d 100644
--- a/xbmc/cores/DataCacheCore.h
+++ b/xbmc/cores/DataCacheCore.h
@@ -85,6 +85,13 @@ class CDataCacheCore
    */
   int64_t GetPlayTime();
 
+  /*!
+   * \brief Get the current percentage of playback if a playback buffer is available.
+   *
+   *  If there is no playback buffer, percentage will be 0.
+   */
+  float GetPlayPercentage();
+
   /*!
    * \brief Get the minumum time
    *
