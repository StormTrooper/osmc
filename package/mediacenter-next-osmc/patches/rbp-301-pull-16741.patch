From d918226c3141a96905071240872e12eb4d774786 Mon Sep 17 00:00:00 2001
From: Maven85 <janis.semper@googlemail.com>
Date: Wed, 9 Oct 2019 10:20:22 +0200
Subject: [PATCH] [Android] added more program information for android tv
 channels

---
 .../packaging/xbmc/src/XBMCJsonRPC.java.in    | 37 +++++++++++-----
 .../channels/SyncProgramsJobService.java.in   | 36 +++++++++++++--
 .../packaging/xbmc/src/model/Movie.java.in    | 21 ++++++---
 .../xbmc/src/model/TVEpisode.java.in          | 44 +++++++++++++++++++
 .../packaging/xbmc/src/model/TVShow.java.in   | 22 ++++++++++
 5 files changed, 140 insertions(+), 20 deletions(-)

diff --git a/tools/android/packaging/xbmc/src/XBMCJsonRPC.java.in b/tools/android/packaging/xbmc/src/XBMCJsonRPC.java.in
index d84039bf20e3..9e3efa983ef9 100644
--- a/tools/android/packaging/xbmc/src/XBMCJsonRPC.java.in
+++ b/tools/android/packaging/xbmc/src/XBMCJsonRPC.java.in
@@ -103,13 +103,13 @@ public class XBMCJsonRPC
                  "{\"jsonrpc\": \"2.0\", \"method\": \"AudioLibrary.GetArtists\", \"params\": {\"filter\":{%s},\"limits\": { \"start\" : 0, \"end\": 10}, \"properties\" : [\"description\", \"thumbnail\", \"fanart\"], \"sort\": { \"order\": \"descending\", \"method\": \"dateadded\", \"ignorearticle\": true } }, \"id\": \"%s\"}";
 
   private String RETRIEVE_MOVIE_DETAILS =
-          "{ \"jsonrpc\": \"2.0\", \"method\": \"VideoLibrary.GetMovieDetails\", \"params\": { \"movieid\" : %s, \"properties\" : [\"imdbnumber\", \"title\", \"tagline\", \"thumbnail\", \"fanart\", \"year\", \"runtime\", \"file\", \"plot\", \"trailer\"] }, \"id\": \"%s\" }";
+          "{ \"jsonrpc\": \"2.0\", \"method\": \"VideoLibrary.GetMovieDetails\", \"params\": { \"movieid\" : %s, \"properties\" : [\"imdbnumber\", \"title\", \"tagline\", \"thumbnail\", \"fanart\", \"year\", \"runtime\", \"file\", \"plot\", \"trailer\", \"rating\"] }, \"id\": \"%s\" }";
 
   private String RETRIEVE_EPISODE_DETAILS =
-          "{ \"jsonrpc\": \"2.0\", \"method\": \"VideoLibrary.GetEpisodeDetails\", \"params\": { \"episodeid\" : %s, \"properties\" : [\"title\", \"tvshowid\", \"showtitle\", \"season\", \"episode\", \"thumbnail\", \"fanart\", \"file\"] }, \"id\": \"%s\" }";
+          "{ \"jsonrpc\": \"2.0\", \"method\": \"VideoLibrary.GetEpisodeDetails\", \"params\": { \"episodeid\" : %s, \"properties\" : [\"title\", \"tvshowid\", \"showtitle\", \"season\", \"episode\", \"thumbnail\", \"fanart\", \"file\", \"plot\", \"rating\", \"runtime\", \"firstaired\"] }, \"id\": \"%s\" }";
 
   private String RETRIEVE_TVSHOW_DETAILS =
-          "{ \"jsonrpc\": \"2.0\", \"method\": \"VideoLibrary.GetTVShowDetails\", \"params\": { \"tvshowid\" : %s, \"properties\" : [\"title\", \"studio\", \"thumbnail\", \"fanart\"] }, \"id\": \"%s\" }";
+          "{ \"jsonrpc\": \"2.0\", \"method\": \"VideoLibrary.GetTVShowDetails\", \"params\": { \"tvshowid\" : %s, \"properties\" : [\"title\", \"studio\", \"thumbnail\", \"fanart\", \"plot\", \"year\", \"rating\"] }, \"id\": \"%s\" }";
 
   private String RETRIEVE_ALBUM_DETAILS =
           "{ \"jsonrpc\": \"2.0\", \"method\": \"AudioLibrary.GetAlbumDetails\", \"params\": { \"albumid\" : %s, \"properties\" : [\"title\", \"displayartist\", \"thumbnail\", \"fanart\",  \"artistid\"] }, \"id\": \"%s\" }";
@@ -796,18 +796,18 @@ public class XBMCJsonRPC
     {
       med.setId(details.get("movieid").getAsInt());
       med.setTitle(details.get("title").getAsString());
-      med.setDescription(details.get("tagline").getAsString());
+      med.setDescription(details.get("plot").getAsString());
       if (details.has("thumbnail") && !details.get("thumbnail").getAsString().isEmpty())
       {
         String url = getDownloadUrl(details.get("thumbnail").getAsString());
-        if (url != null && url != null && !url.isEmpty())
+        if (url != null && !url.isEmpty())
           med.setCardImageUrl(XBMCFileContentProvider.buildUri(url).toString());
       }
       med.setCardImageAspectRatio("2:3");
       if (details.has("fanart") && !details.get("fanart").getAsString().isEmpty())
       {
         String url = getDownloadUrl(details.get("fanart").getAsString());
-        if (url != null && url != null && !url.isEmpty())
+        if (url != null && !url.isEmpty())
           med.setBackgroundImageUrl(XBMCFileContentProvider.buildUri(url).toString());
       }
       med.setXbmcUrl("videodb://movies/titles/" + details.get("movieid").getAsString() + "?showinfo=true");
@@ -836,7 +836,8 @@ public class XBMCJsonRPC
       med.setCategory(Media.MEDIA_TYPE_MOVIE);
 
       med.setYear(details.get("year").getAsString());
-      med.setPlot(details.get("plot").getAsString());
+      med.setRating(convertRating(details.get("rating").getAsDouble()));
+      med.setDuration(details.get("runtime").getAsInt() * 1000);
     }
     catch (Exception e)
     {
@@ -854,9 +855,7 @@ public class XBMCJsonRPC
     {
       med.setId(details.get("tvshowid").getAsInt());
       med.setTitle(details.get("title").getAsString());
-      JsonArray ja = details.get("studio").getAsJsonArray();
-      if (ja.size() > 0)
-        med.setDescription(ja.get(0).getAsString());
+      med.setDescription(details.get("plot").getAsString());
       if (details.has("thumbnail") && !details.get("thumbnail").getAsString().isEmpty())
       {
         String url = getDownloadUrl(details.get("thumbnail").getAsString());
@@ -872,6 +871,9 @@ public class XBMCJsonRPC
       }
       med.setXbmcUrl("videodb://tvshows/titles/" + details.get("tvshowid").getAsInt() + "/");
       med.setCategory(Media.MEDIA_TYPE_TVSHOW);
+
+      med.setYear(details.get("year").getAsString());
+      med.setRating(convertRating(details.get("rating").getAsDouble()));
     }
     catch (Exception e)
     {
@@ -889,7 +891,7 @@ public class XBMCJsonRPC
     {
       med.setId(details.get("episodeid").getAsInt());
       med.setTitle(details.get("title").getAsString());
-      med.setDescription(details.get("showtitle").getAsString());
+      med.setDescription(details.get("plot").getAsString());
       if (details.has("thumbnail") && !details.get("thumbnail").getAsString().isEmpty())
       {
         String url = getDownloadUrl(details.get("thumbnail").getAsString());
@@ -911,8 +913,12 @@ public class XBMCJsonRPC
 */
       med.setCategory(Media.MEDIA_TYPE_TVEPISODE);
 
+      med.setShowTitle(details.get("showtitle").getAsString());
       med.setSeason(details.get("season").getAsInt());
       med.setEpisode(details.get("episode").getAsInt());
+      med.setRating(convertRating(details.get("rating").getAsDouble()));
+      med.setDuration(details.get("runtime").getAsInt() * 1000);
+      med.setFirstaired(details.get("firstaired").getAsString());
     }
     catch (Exception e)
     {
@@ -1259,4 +1265,13 @@ public class XBMCJsonRPC
 
     return medias;
   }
+
+  private String convertRating(Double rating)
+  {
+    if(rating == null || rating.doubleValue() <= 0.0)
+      return null;
+        
+    return String.valueOf(rating / 2.0);
+  }
+
 }
diff --git a/tools/android/packaging/xbmc/src/channels/SyncProgramsJobService.java.in b/tools/android/packaging/xbmc/src/channels/SyncProgramsJobService.java.in
index 58778f0d36ec..36c477e9c1b0 100644
--- a/tools/android/packaging/xbmc/src/channels/SyncProgramsJobService.java.in
+++ b/tools/android/packaging/xbmc/src/channels/SyncProgramsJobService.java.in
@@ -31,6 +31,7 @@ import android.util.Log;
 import @APP_PACKAGE@.Splash;
 import @APP_PACKAGE@.XBMCJsonRPC;
 import @APP_PACKAGE@.model.Movie;
+import @APP_PACKAGE@.model.TVShow;
 import @APP_PACKAGE@.model.TVEpisode;
 import @APP_PACKAGE@.model.File;
 import @APP_PACKAGE@.model.Media;
@@ -254,7 +255,7 @@ public class SyncProgramsJobService extends JobService
               .setIntent(detailsIntent);
 
       if(media.getCategory().equals(Media.MEDIA_TYPE_MOVIE))
-        builder.setType(TvContractCompat.PreviewProgramColumns.TYPE_CLIP);
+        builder.setType(TvContractCompat.PreviewProgramColumns.TYPE_MOVIE);
       else if(media.getCategory().equals(Media.MEDIA_TYPE_TVSHOW))
         builder.setType(TvContractCompat.PreviewProgramColumns.TYPE_TV_SERIES);
       else if(media.getCategory().equals(Media.MEDIA_TYPE_TVEPISODE))
@@ -286,12 +287,39 @@ public class SyncProgramsJobService extends JobService
 
       if (media instanceof Movie)
       {
-        builder.setLongDescription(((Movie)media).getPlot());
+        Movie movie = Movie.class.cast(media);
+        builder.setReleaseDate(movie.getYear());
+        builder.setDurationMillis(movie.getDuration());
+        if (movie.getRating() != null)
+        {
+          builder.setReviewRating(movie.getRating());
+          builder.setReviewRatingStyle(TvContractCompat.Programs.REVIEW_RATING_STYLE_STARS);
+        }
+      }
+      if (media instanceof TVShow)
+      {
+        TVShow tvshow = TVShow.class.cast(media);
+        builder.setReleaseDate(tvshow.getYear());
+        if (tvshow.getRating() != null)
+        {
+          builder.setReviewRating(tvshow.getRating());
+          builder.setReviewRatingStyle(TvContractCompat.Programs.REVIEW_RATING_STYLE_STARS);
+        }
       }
       if (media instanceof TVEpisode)
       {
-        builder.setSeasonNumber(((TVEpisode)media).getSeason());
-        builder.setEpisodeNumber(((TVEpisode)media).getEpisode());
+        TVEpisode tvepisode = TVEpisode.class.cast(media);
+        builder.setTitle(tvepisode.getShowTitle());
+        builder.setEpisodeTitle(tvepisode.getTitle());
+        builder.setSeasonNumber(tvepisode.getSeason());
+        builder.setEpisodeNumber(tvepisode.getEpisode());
+        builder.setDurationMillis(tvepisode.getDuration());
+        builder.setReleaseDate(tvepisode.getFirstaired());
+        if (tvepisode.getRating() != null)
+        {
+          builder.setReviewRating(tvepisode.getRating());
+          builder.setReviewRatingStyle(TvContractCompat.Programs.REVIEW_RATING_STYLE_STARS);
+        }
       }
 
       return builder.build();
diff --git a/tools/android/packaging/xbmc/src/model/Movie.java.in b/tools/android/packaging/xbmc/src/model/Movie.java.in
index d8ec1ddb2bff..ca510afabc56 100644
--- a/tools/android/packaging/xbmc/src/model/Movie.java.in
+++ b/tools/android/packaging/xbmc/src/model/Movie.java.in
@@ -9,7 +9,8 @@ import @APP_PACKAGE@.model.Media;
 public class Movie extends Media
 {
   private String year;
-  private String plot;
+  private String rating;
+  private int duration;
 
   public String getYear()
   {
@@ -21,13 +22,23 @@ public class Movie extends Media
     this.year = year;
   }
 
-  public String getPlot()
+  public String getRating()
   {
-    return plot;
+    return rating;
   }
 
-  public void setPlot(String plot)
+  public void setRating(String rating)
   {
-    this.plot = plot;
+    this.rating = rating;
+  }
+
+  public int getDuration()
+  {
+    return duration;
+  }
+
+  public void setDuration(int duration)
+  {
+    this.duration = duration;
   }
 }
diff --git a/tools/android/packaging/xbmc/src/model/TVEpisode.java.in b/tools/android/packaging/xbmc/src/model/TVEpisode.java.in
index fb73b88817fa..46315b3cf175 100644
--- a/tools/android/packaging/xbmc/src/model/TVEpisode.java.in
+++ b/tools/android/packaging/xbmc/src/model/TVEpisode.java.in
@@ -8,8 +8,22 @@ import @APP_PACKAGE@.model.Media;
 
 public class TVEpisode extends Media
 {
+  private String showtitle;
   private int season;
   private int episode;
+  private String rating;
+  private int duration;
+  private String firstaired;
+
+  public String getShowTitle()
+  {
+    return showtitle;
+  }
+
+  public void setShowTitle(String showtitle)
+  {
+    this.showtitle = showtitle;
+  }
 
   public int getSeason()
   {
@@ -30,4 +44,34 @@ public class TVEpisode extends Media
   {
     this.episode = episode;
   }
+
+  public String getRating()
+  {
+    return rating;
+  }
+
+  public void setRating(String rating)
+  {
+    this.rating = rating;
+  }
+
+  public int getDuration()
+  {
+    return duration;
+  }
+
+  public void setDuration(int duration)
+  {
+    this.duration = duration;
+  }
+
+  public String getFirstaired()
+  {
+    return firstaired;
+  }
+
+  public void setFirstaired(String firstaired)
+  {
+    this.firstaired = firstaired;
+  }
 }
diff --git a/tools/android/packaging/xbmc/src/model/TVShow.java.in b/tools/android/packaging/xbmc/src/model/TVShow.java.in
index 534993c78f5d..24ed4ce6b95e 100644
--- a/tools/android/packaging/xbmc/src/model/TVShow.java.in
+++ b/tools/android/packaging/xbmc/src/model/TVShow.java.in
@@ -8,4 +8,26 @@ import @APP_PACKAGE@.model.Media;
 
 public class TVShow extends Media
 {
+  private String year;
+  private String rating;
+
+  public String getYear()
+  {
+    return year;
+  }
+
+  public void setYear(String year)
+  {
+    this.year = year;
+  }
+
+  public String getRating()
+  {
+    return rating;
+  }
+
+  public void setRating(String rating)
+  {
+    this.rating = rating;
+  }  
 }
