From 4414154df1ece5a5097e12a7aeff5545f3b77c80 Mon Sep 17 00:00:00 2001
From: xbmc <fernetmenta@online.de>
Date: Sun, 22 Jul 2018 12:06:14 +0200
Subject: [PATCH] X11: implement GetFrameLatencyAdjustment

---
 xbmc/windowing/X11/GLContext.h               |  1 +
 xbmc/windowing/X11/GLContextEGL.cpp          | 23 +++++++++++++++++++++++
 xbmc/windowing/X11/GLContextEGL.h            |  2 ++
 xbmc/windowing/X11/WinSystemX11GLContext.cpp | 10 ++++++++++
 xbmc/windowing/X11/WinSystemX11GLContext.h   |  1 +
 5 files changed, 37 insertions(+)

diff --git a/xbmc/windowing/X11/GLContext.h b/xbmc/windowing/X11/GLContext.h
index 31d06cfcc223..660833892fb0 100644
--- a/xbmc/windowing/X11/GLContext.h
+++ b/xbmc/windowing/X11/GLContext.h
@@ -37,6 +37,7 @@ class CGLContext
   virtual void SetVSync(bool enable) = 0;
   virtual void SwapBuffers() = 0;
   virtual void QueryExtensions() = 0;
+  virtual uint64_t GetFrameLatencyAdjustment() { return 0; };
   bool IsExtSupported(const char* extension) const;
 
   std::string ExtPrefix(){ return m_extPrefix; };
diff --git a/xbmc/windowing/X11/GLContextEGL.cpp b/xbmc/windowing/X11/GLContextEGL.cpp
index ca1c595f4fe7..ae84ea53f0cb 100644
--- a/xbmc/windowing/X11/GLContextEGL.cpp
+++ b/xbmc/windowing/X11/GLContextEGL.cpp
@@ -404,7 +404,30 @@ void CGLContextEGL::SwapBuffers()
   m_sync.msc1 = msc1;
   m_sync.msc2 = msc2;
   m_sync.sbc2 = sbc2;
+}
+
+uint64_t CGLContextEGL::GetFrameLatencyAdjustment()
+{
+  struct timespec nowTs;
+  uint64_t now;
+  clock_gettime(CLOCK_MONOTONIC, &nowTs);
+  now = nowTs.tv_sec * 1000000000 + nowTs.tv_nsec;
+  now /= 1000;
+
+  uint64_t interval = (m_sync.cont > 5) ? m_sync.interval : m_sync.ust2 - m_sync.ust1;
+  if (interval == 0)
+    return 0;
+
+  if (now < m_sync.ust2)
+  {
+    return 0;
+  }
+
+  uint64_t ret = now - m_sync.ust2;
+  while (ret > interval)
+    ret -= interval;
 
+  return ret;
 }
 
 void CGLContextEGL::QueryExtensions()
diff --git a/xbmc/windowing/X11/GLContextEGL.h b/xbmc/windowing/X11/GLContextEGL.h
index bc2d044773f8..e16ae3dc9403 100644
--- a/xbmc/windowing/X11/GLContextEGL.h
+++ b/xbmc/windowing/X11/GLContextEGL.h
@@ -36,6 +36,8 @@ class CGLContextEGL : public CGLContext
   void SetVSync(bool enable) override;
   void SwapBuffers() override;
   void QueryExtensions() override;
+  uint64_t GetFrameLatencyAdjustment() override;
+
   EGLDisplay m_eglDisplay;
   EGLSurface m_eglSurface;
   EGLContext m_eglContext;
diff --git a/xbmc/windowing/X11/WinSystemX11GLContext.cpp b/xbmc/windowing/X11/WinSystemX11GLContext.cpp
index 53b131842e9b..6d4b0f3d784f 100644
--- a/xbmc/windowing/X11/WinSystemX11GLContext.cpp
+++ b/xbmc/windowing/X11/WinSystemX11GLContext.cpp
@@ -333,6 +333,16 @@ std::unique_ptr<CVideoSync> CWinSystemX11GLContext::GetVideoSync(void *clock)
   return pVSync;
 }
 
+float CWinSystemX11GLContext::GetFrameLatencyAdjustment()
+{
+  if (m_pGLContext)
+  {
+    float micros = m_pGLContext->GetFrameLatencyAdjustment();
+    return micros / 1000;
+  }
+  return 0;
+}
+
 void CWinSystemX11GLContext::delete_CVaapiProxy::operator()(CVaapiProxy *p) const
 {
   X11::VaapiProxyDelete(p);
diff --git a/xbmc/windowing/X11/WinSystemX11GLContext.h b/xbmc/windowing/X11/WinSystemX11GLContext.h
index 441bec8e95e5..c9ac2d8ebe8a 100644
--- a/xbmc/windowing/X11/WinSystemX11GLContext.h
+++ b/xbmc/windowing/X11/WinSystemX11GLContext.h
@@ -49,6 +49,7 @@ class CWinSystemX11GLContext : public CWinSystemX11, public CRenderSystemGL
 
   // videosync
   std::unique_ptr<CVideoSync> GetVideoSync(void *clock) override;
+  float GetFrameLatencyAdjustment() override;
 
   XID GetWindow() const;
   void* GetGlxContext() const;
