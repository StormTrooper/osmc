From bf6b32e3061016b894fa9eaa6d67e394b1036fd0 Mon Sep 17 00:00:00 2001
From: Rechi <Rechi@users.noreply.github.com>
Date: Fri, 19 Jul 2019 17:14:50 +0200
Subject: [PATCH 1/7] [cleanup] combine TARGET_DARWIN_(EMBEDDED|OSX) defines to
 TARGET_DARWIN

---
 xbmc/cores/ExternalPlayer/ExternalPlayer.cpp | 4 ++--
 xbmc/settings/DisplaySettings.cpp            | 2 +-
 xbmc/utils/SystemInfo.cpp                    | 2 +-
 3 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/xbmc/cores/ExternalPlayer/ExternalPlayer.cpp b/xbmc/cores/ExternalPlayer/ExternalPlayer.cpp
index 2e864e5ba7c7..3a5e6502fe63 100644
--- a/xbmc/cores/ExternalPlayer/ExternalPlayer.cpp
+++ b/xbmc/cores/ExternalPlayer/ExternalPlayer.cpp
@@ -310,7 +310,7 @@ void CExternalPlayer::Process()
   ret = ExecuteAppW32(strFName.c_str(),strFArgs.c_str());
 #elif defined(TARGET_ANDROID)
   ret = ExecuteAppAndroid(m_filename.c_str(), mainFile.c_str());
-#elif (defined(TARGET_POSIX) && !defined(TARGET_DARWIN_EMBEDDED)) || defined(TARGET_DARWIN_OSX)
+#elif defined(TARGET_POSIX) && !defined(TARGET_DARWIN_EMBEDDED)
   ret = ExecuteAppLinux(strFArgs.c_str());
 #endif
   int64_t elapsedMillis = XbmcThreads::SystemClockMillis() - m_playbackStartTime;
@@ -447,7 +447,7 @@ bool CExternalPlayer::ExecuteAppW32(const char* strPath, const char* strSwitches
 }
 #endif
 
-#if !defined(TARGET_ANDROID) && !defined(TARGET_DARWIN_EMBEDDED) && (defined(TARGET_POSIX) || defined(TARGET_DARWIN_OSX))
+#if !defined(TARGET_ANDROID) && !defined(TARGET_DARWIN_EMBEDDED) && defined(TARGET_POSIX)
 bool CExternalPlayer::ExecuteAppLinux(const char* strSwitches)
 {
   CLog::Log(LOGNOTICE, "%s: %s", __FUNCTION__, strSwitches);
diff --git a/xbmc/settings/DisplaySettings.cpp b/xbmc/settings/DisplaySettings.cpp
index 47ba899ab0a9..736d7ed84530 100644
--- a/xbmc/settings/DisplaySettings.cpp
+++ b/xbmc/settings/DisplaySettings.cpp
@@ -824,7 +824,7 @@ void CDisplaySettings::SettingOptionsPreferredStereoscopicViewModesFiller(Settin
 
 void CDisplaySettings::SettingOptionsMonitorsFiller(SettingConstPtr setting, std::vector<StringSettingOption> &list, std::string &current, void *data)
 {
-#if defined(HAVE_X11) || defined(TARGET_DARWIN_OSX) || defined(TARGET_DARWIN_EMBEDDED)
+#if defined(HAVE_X11) || defined(TARGET_DARWIN)
   std::vector<std::string> monitors;
 
 #if defined(HAVE_X11)
diff --git a/xbmc/utils/SystemInfo.cpp b/xbmc/utils/SystemInfo.cpp
index d74a5c1f2d3c..518d83fb8482 100644
--- a/xbmc/utils/SystemInfo.cpp
+++ b/xbmc/utils/SystemInfo.cpp
@@ -731,7 +731,7 @@ std::string CSysInfo::GetOsPrettyNameWithVersion(void)
     osNameVer.append(" unknown");
 #elif defined(TARGET_WINDOWS_STORE)
   osNameVer = GetKernelName() + " " + GetOsVersion();
-#elif defined(TARGET_FREEBSD) || defined(TARGET_DARWIN_EMBEDDED) || defined(TARGET_DARWIN_OSX)
+#elif defined(TARGET_FREEBSD) || defined(TARGET_DARWIN)
   osNameVer = GetOsName() + " " + GetOsVersion();
 #elif defined(TARGET_ANDROID)
   osNameVer = GetOsName() + " " + GetOsVersion() + " API level " +   StringUtils::Format("%d", CJNIBuild::SDK_INT);

From 0fb03668ce18892f24c3d66a7c31a8314766fd16 Mon Sep 17 00:00:00 2001
From: Rechi <Rechi@users.noreply.github.com>
Date: Fri, 19 Jul 2019 17:14:50 +0200
Subject: [PATCH 2/7] [cleanup] remove unsed DarwinUtils.h includes

---
 xbmc/cores/AudioEngine/Sinks/AESinkDARWINIOS.mm        | 2 --
 xbmc/cores/VideoPlayer/DVDCodecs/Video/VTB.cpp         | 1 -
 xbmc/guilib/Texture.cpp                                | 1 -
 xbmc/platform/darwin/ios-common/IOSKeyboard.mm         | 1 -
 xbmc/platform/darwin/ios/IOSScreenManager.mm           | 2 --
 xbmc/platform/darwin/storage/DarwinStorageProvider.cpp | 1 -
 xbmc/settings/AdvancedSettings.cpp                     | 4 ----
 xbmc/settings/SettingConditions.cpp                    | 3 ---
 xbmc/windowing/ios/WinSystemIOS.mm                     | 1 -
 9 files changed, 16 deletions(-)

diff --git a/xbmc/cores/AudioEngine/Sinks/AESinkDARWINIOS.mm b/xbmc/cores/AudioEngine/Sinks/AESinkDARWINIOS.mm
index 5c3a5e7fdd37..5f4020103239 100644
--- a/xbmc/cores/AudioEngine/Sinks/AESinkDARWINIOS.mm
+++ b/xbmc/cores/AudioEngine/Sinks/AESinkDARWINIOS.mm
@@ -18,8 +18,6 @@
 #include "utils/log.h"
 #include "windowing/WinSystem.h"
 
-#include "platform/darwin/DarwinUtils.h"
-
 #include <sstream>
 
 #include <AudioToolbox/AudioToolbox.h>
diff --git a/xbmc/cores/VideoPlayer/DVDCodecs/Video/VTB.cpp b/xbmc/cores/VideoPlayer/DVDCodecs/Video/VTB.cpp
index e6246f470e6c..75c833ed8a3f 100644
--- a/xbmc/cores/VideoPlayer/DVDCodecs/Video/VTB.cpp
+++ b/xbmc/cores/VideoPlayer/DVDCodecs/Video/VTB.cpp
@@ -6,7 +6,6 @@
  *  See LICENSES/README.md for more information.
  */
 
-#include "platform/darwin/DarwinUtils.h"
 #include "cores/VideoPlayer/Process/ProcessInfo.h"
 #include "DVDVideoCodec.h"
 #include "DVDCodecs/DVDCodecUtils.h"
diff --git a/xbmc/guilib/Texture.cpp b/xbmc/guilib/Texture.cpp
index 2a52ea7a7e3e..02f8c7e136ba 100644
--- a/xbmc/guilib/Texture.cpp
+++ b/xbmc/guilib/Texture.cpp
@@ -17,7 +17,6 @@
 #if defined(TARGET_DARWIN_EMBEDDED)
 #include <ImageIO/ImageIO.h>
 #include "filesystem/File.h"
-#include "platform/darwin/DarwinUtils.h"
 #endif
 #if defined(TARGET_ANDROID)
 #include "URL.h"
diff --git a/xbmc/platform/darwin/ios-common/IOSKeyboard.mm b/xbmc/platform/darwin/ios-common/IOSKeyboard.mm
index e29525aed5cf..2d6e9f143bce 100644
--- a/xbmc/platform/darwin/ios-common/IOSKeyboard.mm
+++ b/xbmc/platform/darwin/ios-common/IOSKeyboard.mm
@@ -9,7 +9,6 @@
 #include "platform/darwin/ios-common/IOSKeyboard.h"
 
 #import "platform/darwin/AutoPool.h"
-#include "platform/darwin/DarwinUtils.h"
 #include "platform/darwin/NSLogDebugHelpers.h"
 #include "platform/darwin/ios-common/IOSKeyboardView.h"
 #include "platform/darwin/ios/XBMCController.h"
diff --git a/xbmc/platform/darwin/ios/IOSScreenManager.mm b/xbmc/platform/darwin/ios/IOSScreenManager.mm
index 8fe42e6a9440..d84008bb8df9 100644
--- a/xbmc/platform/darwin/ios/IOSScreenManager.mm
+++ b/xbmc/platform/darwin/ios/IOSScreenManager.mm
@@ -20,8 +20,6 @@
 #include "windowing/WinSystem.h"
 #include "windowing/ios/WinSystemIOS.h"
 
-#include "platform/darwin/DarwinUtils.h"
-
 #include <signal.h>
 
 #import <Foundation/Foundation.h>
diff --git a/xbmc/platform/darwin/storage/DarwinStorageProvider.cpp b/xbmc/platform/darwin/storage/DarwinStorageProvider.cpp
index 46f11c8cb8e1..8c16fdc1b562 100644
--- a/xbmc/platform/darwin/storage/DarwinStorageProvider.cpp
+++ b/xbmc/platform/darwin/storage/DarwinStorageProvider.cpp
@@ -17,7 +17,6 @@
 #include <DiskArbitration/DiskArbitration.h>
 #include <IOKit/storage/IOCDMedia.h>
 #include <IOKit/storage/IODVDMedia.h>
-#include "platform/darwin/DarwinUtils.h"
 #include "platform/darwin/osx/CocoaInterface.h"
 #endif
 
diff --git a/xbmc/settings/AdvancedSettings.cpp b/xbmc/settings/AdvancedSettings.cpp
index 0afe521a97b8..48c7399b5672 100644
--- a/xbmc/settings/AdvancedSettings.cpp
+++ b/xbmc/settings/AdvancedSettings.cpp
@@ -36,10 +36,6 @@
 #include "utils/Variant.h"
 #include "utils/XMLUtils.h"
 
-#if defined(TARGET_DARWIN_EMBEDDED)
-#include "platform/darwin/DarwinUtils.h"
-#endif
-
 using namespace ADDON;
 using namespace XFILE;
 
diff --git a/xbmc/settings/SettingConditions.cpp b/xbmc/settings/SettingConditions.cpp
index 5c9bba00389f..bd16c4905902 100644
--- a/xbmc/settings/SettingConditions.cpp
+++ b/xbmc/settings/SettingConditions.cpp
@@ -27,9 +27,6 @@
 #include "settings/SettingAddon.h"
 #include "settings/SettingsComponent.h"
 #include "utils/StringUtils.h"
-#if defined(TARGET_DARWIN_OSX)
-#include "platform/darwin/DarwinUtils.h"
-#endif// defined(TARGET_DARWIN_OSX)
 #include "windowing/WinSystem.h"
 
 bool AddonHasSettings(const std::string &condition, const std::string &value, SettingConstPtr setting, void *data)
diff --git a/xbmc/windowing/ios/WinSystemIOS.mm b/xbmc/windowing/ios/WinSystemIOS.mm
index 1d697f09c1db..cf021a6d5924 100644
--- a/xbmc/windowing/ios/WinSystemIOS.mm
+++ b/xbmc/windowing/ios/WinSystemIOS.mm
@@ -32,7 +32,6 @@
 #include "utils/log.h"
 #include "windowing/GraphicContext.h"
 
-#include "platform/darwin/DarwinUtils.h"
 #import "platform/darwin/ios/IOSScreenManager.h"
 #import "platform/darwin/ios/XBMCController.h"
 

From d26209b9a8cf076189ba28c4bd768152c610721b Mon Sep 17 00:00:00 2001
From: Rechi <Rechi@users.noreply.github.com>
Date: Fri, 19 Jul 2019 17:14:50 +0200
Subject: [PATCH 3/7] [cleanup] remove dummy CDarwinUtils::EnableOSScreenSaver
 function

---
 xbmc/Application.cpp                | 11 -----------
 xbmc/platform/darwin/DarwinUtils.h  |  1 -
 xbmc/platform/darwin/DarwinUtils.mm |  5 -----
 3 files changed, 17 deletions(-)

diff --git a/xbmc/Application.cpp b/xbmc/Application.cpp
index 8bdc6a9f1243..756653f5a092 100644
--- a/xbmc/Application.cpp
+++ b/xbmc/Application.cpp
@@ -3134,10 +3134,6 @@ void CApplication::OnPlayBackStopped()
 {
   CLog::LogF(LOGDEBUG, "CApplication::OnPlayBackStopped");
 
-#if defined(TARGET_DARWIN_EMBEDDED)
-  CDarwinUtils::EnableOSScreenSaver(true);
-#endif
-
   CServiceBroker::GetPVRManager().OnPlaybackStopped(m_itemCurrentFile);
 
   CVariant data(CVariant::VariantTypeObject);
@@ -3162,9 +3158,6 @@ void CApplication::OnPlayBackPaused()
 #ifdef HAS_PYTHON
   g_pythonParser.OnPlayBackPaused();
 #endif
-#if defined(TARGET_DARWIN_EMBEDDED)
-  CDarwinUtils::EnableOSScreenSaver(true);
-#endif
 
   CVariant param;
   param["player"]["speed"] = 0;
@@ -3177,10 +3170,6 @@ void CApplication::OnPlayBackResumed()
 #ifdef HAS_PYTHON
   g_pythonParser.OnPlayBackResumed();
 #endif
-#if defined(TARGET_DARWIN_EMBEDDED)
-  if (m_appPlayer.IsPlayingVideo())
-    CDarwinUtils::EnableOSScreenSaver(false);
-#endif
 
   CVariant param;
   param["player"]["speed"] = 1;
diff --git a/xbmc/platform/darwin/DarwinUtils.h b/xbmc/platform/darwin/DarwinUtils.h
index ca5d80b24ebc..647b736004d2 100644
--- a/xbmc/platform/darwin/DarwinUtils.h
+++ b/xbmc/platform/darwin/DarwinUtils.h
@@ -30,7 +30,6 @@ class CDarwinUtils
   static bool        IsIosSandboxed(void);
   static bool        HasVideoToolboxDecoder(void);
   static int         BatteryLevel(void);
-  static void        EnableOSScreenSaver(bool enable);
   static void        ResetSystemIdleTimer();
   static void        SetScheduling(bool realtime);
   static void        PrintDebugString(std::string debugString);
diff --git a/xbmc/platform/darwin/DarwinUtils.mm b/xbmc/platform/darwin/DarwinUtils.mm
index 66506da8bd0b..c1b9522d1aaf 100644
--- a/xbmc/platform/darwin/DarwinUtils.mm
+++ b/xbmc/platform/darwin/DarwinUtils.mm
@@ -448,11 +448,6 @@ enum iosPlatform getIosPlatform()
   return batteryLevel * 100;
 }
 
-void CDarwinUtils::EnableOSScreenSaver(bool enable)
-{
-
-}
-
 void CDarwinUtils::ResetSystemIdleTimer()
 {
 

From 12ce55ff73fe9370bea322d1242e4650782184b0 Mon Sep 17 00:00:00 2001
From: Rechi <Rechi@users.noreply.github.com>
Date: Fri, 19 Jul 2019 17:14:50 +0200
Subject: [PATCH 4/7] [cleanup] remove dummy CDarwinUtils::ResetSystemIdleTimer
 function

---
 xbmc/Application.cpp                | 3 ---
 xbmc/platform/darwin/DarwinUtils.h  | 1 -
 xbmc/platform/darwin/DarwinUtils.mm | 5 -----
 3 files changed, 9 deletions(-)

diff --git a/xbmc/Application.cpp b/xbmc/Application.cpp
index 756653f5a092..a1919b80d902 100644
--- a/xbmc/Application.cpp
+++ b/xbmc/Application.cpp
@@ -3313,9 +3313,6 @@ void CApplication::ResetSystemIdleTimer()
 {
   // reset system idle timer
   m_idleTimer.StartZero();
-#if defined(TARGET_DARWIN_EMBEDDED)
-  CDarwinUtils::ResetSystemIdleTimer();
-#endif
 }
 
 void CApplication::ResetScreenSaver()
diff --git a/xbmc/platform/darwin/DarwinUtils.h b/xbmc/platform/darwin/DarwinUtils.h
index 647b736004d2..2a6ca0f32871 100644
--- a/xbmc/platform/darwin/DarwinUtils.h
+++ b/xbmc/platform/darwin/DarwinUtils.h
@@ -30,7 +30,6 @@ class CDarwinUtils
   static bool        IsIosSandboxed(void);
   static bool        HasVideoToolboxDecoder(void);
   static int         BatteryLevel(void);
-  static void        ResetSystemIdleTimer();
   static void        SetScheduling(bool realtime);
   static void        PrintDebugString(std::string debugString);
   static bool        CFStringRefToString(CFStringRef source, std::string& destination);
diff --git a/xbmc/platform/darwin/DarwinUtils.mm b/xbmc/platform/darwin/DarwinUtils.mm
index c1b9522d1aaf..139e74bcffa4 100644
--- a/xbmc/platform/darwin/DarwinUtils.mm
+++ b/xbmc/platform/darwin/DarwinUtils.mm
@@ -448,11 +448,6 @@ enum iosPlatform getIosPlatform()
   return batteryLevel * 100;
 }
 
-void CDarwinUtils::ResetSystemIdleTimer()
-{
-
-}
-
 void CDarwinUtils::SetScheduling(bool realtime)
 {
   int policy;

From 4e736519436e87efdfbc63bc2324d5b8b41da55f Mon Sep 17 00:00:00 2001
From: Rechi <Rechi@users.noreply.github.com>
Date: Fri, 19 Jul 2019 17:14:50 +0200
Subject: [PATCH 5/7] [cleanup] remove unused CSysInfo::HasVideoToolBoxDecoder
 function

---
 xbmc/platform/darwin/DarwinUtils.h | 1 -
 xbmc/utils/SystemInfo.cpp          | 9 ---------
 xbmc/utils/SystemInfo.h            | 1 -
 xbmc/utils/test/TestSystemInfo.cpp | 7 -------
 4 files changed, 18 deletions(-)

diff --git a/xbmc/platform/darwin/DarwinUtils.h b/xbmc/platform/darwin/DarwinUtils.h
index 2a6ca0f32871..fe88afb0bae0 100644
--- a/xbmc/platform/darwin/DarwinUtils.h
+++ b/xbmc/platform/darwin/DarwinUtils.h
@@ -28,7 +28,6 @@ class CDarwinUtils
   static int         GetExecutablePath(char* path, size_t *pathsize);
   static const char *GetAppRootFolder(void);
   static bool        IsIosSandboxed(void);
-  static bool        HasVideoToolboxDecoder(void);
   static int         BatteryLevel(void);
   static void        SetScheduling(bool realtime);
   static void        PrintDebugString(std::string debugString);
diff --git a/xbmc/utils/SystemInfo.cpp b/xbmc/utils/SystemInfo.cpp
index 518d83fb8482..83f6d3299284 100644
--- a/xbmc/utils/SystemInfo.cpp
+++ b/xbmc/utils/SystemInfo.cpp
@@ -1247,15 +1247,6 @@ std::string CSysInfo::GetBuildDate()
   return CCompileInfo::GetBuildDate();
 }
 
-bool CSysInfo::HasVideoToolBoxDecoder()
-{
-#if defined(HAVE_VIDEOTOOLBOXDECODER)
-  return CDarwinUtils::HasVideoToolboxDecoder();
-#else
-  return false;
-#endif
-}
-
 std::string CSysInfo::GetBuildTargetPlatformName(void)
 {
 #if defined(TARGET_DARWIN_OSX)
diff --git a/xbmc/utils/SystemInfo.h b/xbmc/utils/SystemInfo.h
index e2b8838db275..812873442b6c 100644
--- a/xbmc/utils/SystemInfo.h
+++ b/xbmc/utils/SystemInfo.h
@@ -113,7 +113,6 @@ class CSysInfo : public CInfoLoader, public ISubSettings
   static std::string GetBuildDate();
 
   bool HasInternet();
-  bool HasVideoToolBoxDecoder();
   bool IsAeroDisabled();
   static bool IsWindowsVersion(WindowsVersion ver);
   static bool IsWindowsVersionAtLeast(WindowsVersion ver);
diff --git a/xbmc/utils/test/TestSystemInfo.cpp b/xbmc/utils/test/TestSystemInfo.cpp
index c36cb0508dba..a42a68c5960f 100644
--- a/xbmc/utils/test/TestSystemInfo.cpp
+++ b/xbmc/utils/test/TestSystemInfo.cpp
@@ -238,13 +238,6 @@ TEST_F(TestSystemInfo, GetUserAgent)
   EXPECT_NE(std::string::npos, g_sysinfo.GetUserAgent().find(" Version/")) << "'GetUserAgent()' must contain ' Version/'";
 }
 
-#ifndef TARGET_DARWIN
-TEST_F(TestSystemInfo, HasVideoToolBoxDecoder)
-{
-  EXPECT_FALSE(g_sysinfo.HasVideoToolBoxDecoder()) << "'HasVideoToolBoxDecoder()' must return 'false'";
-}
-#endif
-
 TEST_F(TestSystemInfo, GetBuildTargetPlatformName)
 {
   EXPECT_EQ(std::string::npos, g_sysinfo.GetBuildTargetPlatformName().find("Unknown")) << "'GetBuildTargetPlatformName()' must not contain 'Unknown', actual value: '" << g_sysinfo.GetBuildTargetPlatformName() << "'";

From 3f3aff61b8bd8ed70c5050890504e72a154ac237 Mon Sep 17 00:00:00 2001
From: Rechi <Rechi@users.noreply.github.com>
Date: Fri, 19 Jul 2019 17:14:50 +0200
Subject: [PATCH 6/7] [darwin] rename CDarwinUtils::Get(IOS|OSX)VersionString
 to CDarwinUtils::GetVersionString

---
 xbmc/platform/darwin/DarwinUtils.h  |  3 +--
 xbmc/platform/darwin/DarwinUtils.mm | 26 +++++++-------------------
 xbmc/utils/SystemInfo.cpp           |  6 ++----
 3 files changed, 10 insertions(+), 25 deletions(-)

diff --git a/xbmc/platform/darwin/DarwinUtils.h b/xbmc/platform/darwin/DarwinUtils.h
index fe88afb0bae0..1c30c8f49a3b 100644
--- a/xbmc/platform/darwin/DarwinUtils.h
+++ b/xbmc/platform/darwin/DarwinUtils.h
@@ -22,8 +22,7 @@ class CDarwinUtils
   static bool        DeviceHasRetina(double &scale);
   static const char *GetOSReleaseString(void);
   static const char *GetOSVersionString(void);
-  static const char *GetIOSVersionString(void);
-  static const char *GetOSXVersionString(void);
+  static const char* GetVersionString();
   static std::string GetFrameworkPath(bool forPython);
   static int         GetExecutablePath(char* path, size_t *pathsize);
   static const char *GetAppRootFolder(void);
diff --git a/xbmc/platform/darwin/DarwinUtils.mm b/xbmc/platform/darwin/DarwinUtils.mm
index 139e74bcffa4..ef96e48fdd7d 100644
--- a/xbmc/platform/darwin/DarwinUtils.mm
+++ b/xbmc/platform/darwin/DarwinUtils.mm
@@ -283,35 +283,23 @@ enum iosPlatform getIosPlatform()
   return [[[NSProcessInfo processInfo] operatingSystemVersionString] UTF8String];
 }
 
-const char *CDarwinUtils::GetIOSVersionString(void)
+const char* CDarwinUtils::GetVersionString()
 {
-#if defined(TARGET_DARWIN_EMBEDDED)
-  static std::string iOSVersionString;
+  static std::string versionString;
   static std::once_flag flag;
+#if defined(TARGET_DARWIN_EMBEDDED)
   std::call_once(flag, []
   {
-    iOSVersionString.assign([[[UIDevice currentDevice] systemVersion] UTF8String]);
+    versionString.assign([[[UIDevice currentDevice] systemVersion] UTF8String]);
   });
-  return iOSVersionString.c_str();
 #else
-  return "0.0";
-#endif
-}
-
-const char *CDarwinUtils::GetOSXVersionString(void)
-{
-#if defined(TARGET_DARWIN_OSX)
-  static std::string OSXVersionString;
-  static std::once_flag flag;
   std::call_once(flag, []
   {
-    OSXVersionString.assign([[[NSDictionary dictionaryWithContentsOfFile:
-                               @"/System/Library/CoreServices/SystemVersion.plist"] objectForKey:@"ProductVersion"] UTF8String]);
+    versionString.assign([[[NSDictionary dictionaryWithContentsOfFile:
+                            @"/System/Library/CoreServices/SystemVersion.plist"] objectForKey:@"ProductVersion"] UTF8String]);
   });
-  return OSXVersionString.c_str();
-#else
-  return "0.0";
 #endif
+  return versionString.c_str();
 }
 
 std::string CDarwinUtils::GetFrameworkPath(bool forPython)
diff --git a/xbmc/utils/SystemInfo.cpp b/xbmc/utils/SystemInfo.cpp
index 83f6d3299284..877df825bd56 100644
--- a/xbmc/utils/SystemInfo.cpp
+++ b/xbmc/utils/SystemInfo.cpp
@@ -639,10 +639,8 @@ std::string CSysInfo::GetOsVersion(void)
 
 #if defined(TARGET_WINDOWS) || defined(TARGET_FREEBSD)
   osVersion = GetKernelVersion(); // FIXME: for Win32 and FreeBSD OS version is a kernel version
-#elif defined(TARGET_DARWIN_EMBEDDED)
-  osVersion = CDarwinUtils::GetIOSVersionString();
-#elif defined(TARGET_DARWIN_OSX)
-  osVersion = CDarwinUtils::GetOSXVersionString();
+#elif defined(TARGET_DARWIN)
+  osVersion = CDarwinUtils::GetVersionString();
 #elif defined(TARGET_ANDROID)
   char versionCStr[PROP_VALUE_MAX];
   int propLen = __system_property_get("ro.build.version.release", versionCStr);

From c5a91e2f787e2f2eba0ee9750074994434ce3dab Mon Sep 17 00:00:00 2001
From: Rechi <Rechi@users.noreply.github.com>
Date: Fri, 19 Jul 2019 17:14:50 +0200
Subject: [PATCH 7/7] [darwin] move BatteryLevel to powermanagement

---
 xbmc/platform/darwin/DarwinUtils.h            |  1 -
 xbmc/platform/darwin/DarwinUtils.mm           | 38 -------------------
 .../osx/powermanagement/CocoaPowerSyscall.cpp | 26 +++++++++++--
 3 files changed, 23 insertions(+), 42 deletions(-)

diff --git a/xbmc/platform/darwin/DarwinUtils.h b/xbmc/platform/darwin/DarwinUtils.h
index 1c30c8f49a3b..8f3934fc4dbb 100644
--- a/xbmc/platform/darwin/DarwinUtils.h
+++ b/xbmc/platform/darwin/DarwinUtils.h
@@ -27,7 +27,6 @@ class CDarwinUtils
   static int         GetExecutablePath(char* path, size_t *pathsize);
   static const char *GetAppRootFolder(void);
   static bool        IsIosSandboxed(void);
-  static int         BatteryLevel(void);
   static void        SetScheduling(bool realtime);
   static void        PrintDebugString(std::string debugString);
   static bool        CFStringRefToString(CFStringRef source, std::string& destination);
diff --git a/xbmc/platform/darwin/DarwinUtils.mm b/xbmc/platform/darwin/DarwinUtils.mm
index ef96e48fdd7d..a61c70e802d6 100644
--- a/xbmc/platform/darwin/DarwinUtils.mm
+++ b/xbmc/platform/darwin/DarwinUtils.mm
@@ -22,8 +22,6 @@
   #import <Cocoa/Cocoa.h>
   #import <CoreFoundation/CoreFoundation.h>
   #import <IOKit/IOKitLib.h>
-  #import <IOKit/ps/IOPowerSources.h>
-  #import <IOKit/ps/IOPSKeys.h>
 #endif
 
 #import "AutoPool.h"
@@ -400,42 +398,6 @@ enum iosPlatform getIosPlatform()
   return ret;
 }
 
-int CDarwinUtils::BatteryLevel(void)
-{
-  float batteryLevel = 0;
-#if defined(TARGET_DARWIN_IOS)
-  batteryLevel = [[UIDevice currentDevice] batteryLevel];
-#else
-  CFTypeRef powerSourceInfo = IOPSCopyPowerSourcesInfo();
-  CFArrayRef powerSources = IOPSCopyPowerSourcesList(powerSourceInfo);
-
-  CFDictionaryRef powerSource = NULL;
-  const void *powerSourceVal;
-
-  for (int i = 0 ; i < CFArrayGetCount(powerSources) ; i++)
-  {
-    powerSource = IOPSGetPowerSourceDescription(powerSourceInfo, CFArrayGetValueAtIndex(powerSources, i));
-    if (!powerSource) break;
-
-    powerSourceVal = (CFStringRef)CFDictionaryGetValue(powerSource, CFSTR(kIOPSNameKey));
-
-    int curLevel = 0;
-    int maxLevel = 0;
-
-    powerSourceVal = CFDictionaryGetValue(powerSource, CFSTR(kIOPSCurrentCapacityKey));
-    CFNumberGetValue((CFNumberRef)powerSourceVal, kCFNumberSInt32Type, &curLevel);
-
-    powerSourceVal = CFDictionaryGetValue(powerSource, CFSTR(kIOPSMaxCapacityKey));
-    CFNumberGetValue((CFNumberRef)powerSourceVal, kCFNumberSInt32Type, &maxLevel);
-
-    batteryLevel = (double)curLevel/(double)maxLevel;
-  }
-  CFRelease(powerSources);
-  CFRelease(powerSourceInfo);
-#endif
-  return batteryLevel * 100;
-}
-
 void CDarwinUtils::SetScheduling(bool realtime)
 {
   int policy;
diff --git a/xbmc/platform/darwin/osx/powermanagement/CocoaPowerSyscall.cpp b/xbmc/platform/darwin/osx/powermanagement/CocoaPowerSyscall.cpp
index 5780fe8761dd..d29f74747abc 100644
--- a/xbmc/platform/darwin/osx/powermanagement/CocoaPowerSyscall.cpp
+++ b/xbmc/platform/darwin/osx/powermanagement/CocoaPowerSyscall.cpp
@@ -21,8 +21,6 @@ typedef unsigned char BYTE;
   #include <IOKit/ps/IOPSKeys.h>
   #include <ApplicationServices/ApplicationServices.h>
 
-#include "platform/darwin/DarwinUtils.h"
-
 #include "platform/darwin/osx/CocoaInterface.h"
 
 IPowerSyscall* CCocoaPowerSyscall::CreateInstance()
@@ -185,7 +183,29 @@ bool CCocoaPowerSyscall::HasBattery(void)
 
 int CCocoaPowerSyscall::BatteryLevel(void)
 {
-  return CDarwinUtils::BatteryLevel();
+  double batteryLevel = 0;
+  CFTypeRef powerSourceInfo = IOPSCopyPowerSourcesInfo();
+  CFArrayRef powerSources = IOPSCopyPowerSourcesList(powerSourceInfo);
+
+  for (CFIndex i = 0; i < CFArrayGetCount(powerSources); i++)
+  {
+    CFDictionaryRef powerSource = IOPSGetPowerSourceDescription(powerSourceInfo, CFArrayGetValueAtIndex(powerSources, i));
+    if (!powerSource)
+      break;
+
+    int curLevel = 0;
+    const void* powerSourceVal = CFDictionaryGetValue(powerSource, CFSTR(kIOPSCurrentCapacityKey));
+    CFNumberGetValue(static_cast<CFNumberRef>(powerSourceVal), kCFNumberSInt32Type, &curLevel);
+
+    int maxLevel = 0;
+    powerSourceVal = CFDictionaryGetValue(powerSource, CFSTR(kIOPSMaxCapacityKey));
+    CFNumberGetValue(static_cast<CFNumberRef>(powerSourceVal), kCFNumberSInt32Type, &maxLevel);
+
+    batteryLevel = static_cast<double>(curLevel) / static_cast<double>(maxLevel);
+  }
+  CFRelease(powerSources);
+  CFRelease(powerSourceInfo);
+  return batteryLevel * 100;
 }
 
 bool CCocoaPowerSyscall::PumpPowerEvents(IPowerEventsCallback *callback)
