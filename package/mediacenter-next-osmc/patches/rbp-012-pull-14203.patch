From 3ebe3f0faf163dfdd58932955725aa19e4eb4f05 Mon Sep 17 00:00:00 2001
From: GTechAlpha <31323818+GTechAlpha@users.noreply.github.com>
Date: Tue, 10 Jul 2018 23:21:37 -0500
Subject: [PATCH] [RetroPlayer] Configure renderer sooner

---
 xbmc/cores/RetroPlayer/rendering/RPRenderManager.cpp | 19 +++++++++++++------
 1 file changed, 13 insertions(+), 6 deletions(-)

diff --git a/xbmc/cores/RetroPlayer/rendering/RPRenderManager.cpp b/xbmc/cores/RetroPlayer/rendering/RPRenderManager.cpp
index 146a9abe47c2..4a8e0767797d 100644
--- a/xbmc/cores/RetroPlayer/rendering/RPRenderManager.cpp
+++ b/xbmc/cores/RetroPlayer/rendering/RPRenderManager.cpp
@@ -95,6 +95,8 @@ bool CRPRenderManager::Configure(AVPixelFormat format, unsigned int nominalWidth
             maxWidth,
             maxHeight);
 
+  CSingleLock lock(m_stateMutex);
+
   // Immutable parameters
   m_format = format;
   m_maxWidth = maxWidth;
@@ -104,11 +106,9 @@ bool CRPRenderManager::Configure(AVPixelFormat format, unsigned int nominalWidth
   m_width = nominalWidth;
   m_height = nominalHeight;
 
-  CSingleLock lock(m_stateMutex);
-
   if (m_state == RENDER_STATE::UNCONFIGURED)
     m_state = RENDER_STATE::CONFIGURING;
-  else
+  else if (m_state != RENDER_STATE::CONFIGURING)
   {
     Flush();
     m_state = RENDER_STATE::RECONFIGURING;
@@ -119,13 +119,20 @@ bool CRPRenderManager::Configure(AVPixelFormat format, unsigned int nominalWidth
 
 bool CRPRenderManager::GetVideoBuffer(unsigned int width, unsigned int height, AVPixelFormat &format, uint8_t *&data, size_t &size)
 {
-  if (m_bFlush || m_state != RENDER_STATE::CONFIGURED)
-    return false;
-
   for (IRenderBuffer *buffer : m_pendingBuffers)
     buffer->Release();
   m_pendingBuffers.clear();
 
+  if (m_bFlush || m_state != RENDER_STATE::CONFIGURED)
+    return false;
+
+  if (width != m_width || height != m_height)
+  {
+    // Reconfigure
+    Configure(m_format, width, height, m_maxWidth, m_maxHeight);
+    return false;
+  }
+
   // Get buffers from visible renderers
   for (IRenderBufferPool *bufferPool : m_processInfo.GetBufferManager().GetBufferPools())
   {
