From cbf93310b0c5fc12638c066c25e92bfd37b9ea6b Mon Sep 17 00:00:00 2001
From: Jim Carroll <jim@dontcallme.com>
Date: Sun, 19 Apr 2020 17:25:20 -0400
Subject: [PATCH 1/3] Fix minor warning.

---
 xbmc/interfaces/generic/ScriptInvocationManager.h | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/xbmc/interfaces/generic/ScriptInvocationManager.h b/xbmc/interfaces/generic/ScriptInvocationManager.h
index 02c593cfc227..605e387d6016 100644
--- a/xbmc/interfaces/generic/ScriptInvocationManager.h
+++ b/xbmc/interfaces/generic/ScriptInvocationManager.h
@@ -142,7 +142,7 @@ class CScriptInvocationManager
   LanguageInvocationHandlerMap m_invocationHandlers;
   LanguageInvokerThreadMap m_scripts;
   CLanguageInvokerThreadPtr m_lastInvokerThread;
-  int m_lastPluginHandle;
+  int m_lastPluginHandle = -1;
 
   std::map<std::string, int> m_scriptPaths;
   int m_nextId = 0;

From e9c98c7e6976d0ebfea9a6ae1217360a76f9de68 Mon Sep 17 00:00:00 2001
From: Jim Carroll <jim@dontcallme.com>
Date: Sun, 19 Apr 2020 17:25:42 -0400
Subject: [PATCH 2/3] Remove deprecated onAbortRequested python callback.

---
 .../generic/ILanguageInvocationHandler.h        |  2 +-
 xbmc/interfaces/generic/ILanguageInvoker.cpp    |  4 ++--
 xbmc/interfaces/generic/ILanguageInvoker.h      |  6 +++++-
 xbmc/interfaces/legacy/Monitor.cpp              |  3 +--
 xbmc/interfaces/legacy/Monitor.h                | 17 ++++-------------
 xbmc/interfaces/python/PythonInvoker.cpp        |  2 +-
 xbmc/interfaces/python/XBPython.cpp             |  4 ++--
 xbmc/interfaces/python/XBPython.h               |  2 +-
 8 files changed, 17 insertions(+), 23 deletions(-)

diff --git a/xbmc/interfaces/generic/ILanguageInvocationHandler.h b/xbmc/interfaces/generic/ILanguageInvocationHandler.h
index 69bfc8b99427..233e20dc6693 100644
--- a/xbmc/interfaces/generic/ILanguageInvocationHandler.h
+++ b/xbmc/interfaces/generic/ILanguageInvocationHandler.h
@@ -23,7 +23,7 @@ class ILanguageInvocationHandler
 
   virtual bool OnScriptInitialized(ILanguageInvoker *invoker) { return true; }
   virtual void OnScriptStarted(ILanguageInvoker *invoker) { }
-  virtual void OnScriptAbortRequested(ILanguageInvoker *invoker) { }
+  virtual void NotifyScriptAborting(ILanguageInvoker *invoker) { }
   virtual void OnExecutionEnded(ILanguageInvoker* invoker) {}
   virtual void OnScriptFinalized(ILanguageInvoker *invoker) { }
 
diff --git a/xbmc/interfaces/generic/ILanguageInvoker.cpp b/xbmc/interfaces/generic/ILanguageInvoker.cpp
index 9918c583ac5e..df1193ed2532 100644
--- a/xbmc/interfaces/generic/ILanguageInvoker.cpp
+++ b/xbmc/interfaces/generic/ILanguageInvoker.cpp
@@ -63,10 +63,10 @@ bool ILanguageInvoker::onExecutionInitialized()
   return m_invocationHandler->OnScriptInitialized(this);
 }
 
-void ILanguageInvoker::onAbortRequested()
+void ILanguageInvoker::AbortNotification()
 {
   if (m_invocationHandler)
-    m_invocationHandler->OnScriptAbortRequested(this);
+    m_invocationHandler->NotifyScriptAborting(this);
 }
 
 void ILanguageInvoker::onExecutionFailed()
diff --git a/xbmc/interfaces/generic/ILanguageInvoker.h b/xbmc/interfaces/generic/ILanguageInvoker.h
index 3881487db50e..296ec6e72716 100644
--- a/xbmc/interfaces/generic/ILanguageInvoker.h
+++ b/xbmc/interfaces/generic/ILanguageInvoker.h
@@ -50,12 +50,16 @@ class ILanguageInvoker
 protected:
   friend class CLanguageInvokerThread;
 
+  /**
+   * Called to notify the script is aborting.
+   */
+  virtual void AbortNotification();
+
   virtual bool execute(const std::string &script, const std::vector<std::string> &arguments) = 0;
   virtual bool stop(bool abort) = 0;
 
   virtual void pulseGlobalEvent();
   virtual bool onExecutionInitialized();
-  virtual void onAbortRequested();
   virtual void onExecutionFailed();
   virtual void onExecutionDone();
   virtual void onExecutionFinalized();
diff --git a/xbmc/interfaces/legacy/Monitor.cpp b/xbmc/interfaces/legacy/Monitor.cpp
index a64f038d207d..56a72dc838c7 100644
--- a/xbmc/interfaces/legacy/Monitor.cpp
+++ b/xbmc/interfaces/legacy/Monitor.cpp
@@ -26,11 +26,10 @@ namespace XBMCAddon
       }
     }
 
-    void Monitor::OnAbortRequested()
+    void Monitor::AbortNotify()
     {
       XBMC_TRACE;
       abortEvent.Set();
-      invokeCallback(new CallbackFunction<Monitor>(this,&Monitor::onAbortRequested));
     }
 
     bool Monitor::waitForAbort(double timeout)
diff --git a/xbmc/interfaces/legacy/Monitor.h b/xbmc/interfaces/legacy/Monitor.h
index 49762025d555..6f3cf826c291 100644
--- a/xbmc/interfaces/legacy/Monitor.h
+++ b/xbmc/interfaces/legacy/Monitor.h
@@ -57,7 +57,10 @@ namespace XBMCAddon
       inline const String& GetId() { return Id; }
       inline long GetInvokerId() { return invokerId; }
 
-      void OnAbortRequested();
+      /**
+       * Called from XBPython to notify registered monitors that a script is aborting/ending.
+       */
+      void AbortNotify();
 #endif
 
 #ifdef DOXYGEN_SHOULD_USE_THIS
@@ -218,18 +221,6 @@ namespace XBMCAddon
       virtual void onCleanFinished(const String library) { XBMC_TRACE; }
 #endif
 
-#ifdef DOXYGEN_SHOULD_USE_THIS
-      ///
-      /// \ingroup python_monitor
-      /// @brief \python_func{ onAbortRequested() }
-      ///-----------------------------------------------------------------------
-      /// @python_v14 Deprecated. Use **waitForAbort()** to be notified about this event.
-      ///
-      onAbortRequested();
-#else
-      virtual void    onAbortRequested() { XBMC_TRACE; }
-#endif
-
 #ifdef DOXYGEN_SHOULD_USE_THIS
       ///
       /// \ingroup python_monitor
diff --git a/xbmc/interfaces/python/PythonInvoker.cpp b/xbmc/interfaces/python/PythonInvoker.cpp
index 76f24cd4429f..f9896a302da4 100644
--- a/xbmc/interfaces/python/PythonInvoker.cpp
+++ b/xbmc/interfaces/python/PythonInvoker.cpp
@@ -496,7 +496,7 @@ bool CPythonInvoker::stop(bool abort)
       {
         CLog::Log(LOGDEBUG, "CPythonInvoker(%d, %s): trigger Monitor abort request", GetId(),
                   m_sourceFile.c_str());
-        onAbortRequested();
+        AbortNotification();
       }
 
       PyObject* m;
diff --git a/xbmc/interfaces/python/XBPython.cpp b/xbmc/interfaces/python/XBPython.cpp
index 1cde60c0b38b..199e5254eb45 100644
--- a/xbmc/interfaces/python/XBPython.cpp
+++ b/xbmc/interfaces/python/XBPython.cpp
@@ -628,7 +628,7 @@ void XBPython::OnScriptStarted(ILanguageInvoker *invoker)
   m_vecPyList.push_back(inf);
 }
 
-void XBPython::OnScriptAbortRequested(ILanguageInvoker *invoker)
+void XBPython::NotifyScriptAborting(ILanguageInvoker *invoker)
 {
   XBMC_TRACE;
 
@@ -642,7 +642,7 @@ void XBPython::OnScriptAbortRequested(ILanguageInvoker *invoker)
     if (CHECK_FOR_ENTRY(m_vecMonitorCallbackList, it))
     {
       if (invokerId < 0 || it->GetInvokerId() == invokerId)
-        it->OnAbortRequested();
+        it->AbortNotify();
     }
   }
 }
diff --git a/xbmc/interfaces/python/XBPython.h b/xbmc/interfaces/python/XBPython.h
index c236cb215621..6e06b8e2a57f 100644
--- a/xbmc/interfaces/python/XBPython.h
+++ b/xbmc/interfaces/python/XBPython.h
@@ -90,7 +90,7 @@ class XBPython :
   void Uninitialize() override;
   bool OnScriptInitialized(ILanguageInvoker *invoker) override;
   void OnScriptStarted(ILanguageInvoker *invoker) override;
-  void OnScriptAbortRequested(ILanguageInvoker *invoker) override;
+  void NotifyScriptAborting(ILanguageInvoker *invoker) override;
   void OnExecutionEnded(ILanguageInvoker* invoker) override;
   void OnScriptFinalized(ILanguageInvoker *invoker) override;
   ILanguageInvoker* CreateInvoker() override;

From 49d0e89538160545b6b1c688451785a66a466929 Mon Sep 17 00:00:00 2001
From: Jim Carroll <jim@dontcallme.com>
Date: Sun, 19 Apr 2020 21:45:23 -0400
Subject: [PATCH 3/3] Document removed python callback
 Monitor.onAbortRequested.

---
 .../kodi-addon-dev-kit/doxygen/Modules/modules_python.dox    | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/xbmc/addons/kodi-addon-dev-kit/doxygen/Modules/modules_python.dox b/xbmc/addons/kodi-addon-dev-kit/doxygen/Modules/modules_python.dox
index 6f0e6a144b76..27fdf47900ea 100644
--- a/xbmc/addons/kodi-addon-dev-kit/doxygen/Modules/modules_python.dox
+++ b/xbmc/addons/kodi-addon-dev-kit/doxygen/Modules/modules_python.dox
@@ -158,6 +158,11 @@ web applications or frameworks for the Python programming language.
       "",
       <b>xbmc.monitor().onDatabaseScanStarted()</b> function was removed completely.
 }
+\python_removed_function{
+      onAbortRequested,
+      "",
+      <b>xbmc.monitor().onAbortRequested()</b> function was removed completely.
+}
 \python_removed_function{
       create,
       "",
