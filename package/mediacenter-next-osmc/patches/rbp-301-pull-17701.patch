From e2aa0cf5ae551917bd8592bca2279c190c5b702c Mon Sep 17 00:00:00 2001
From: Matt Huisman <me@matthuisman.nz>
Date: Sun, 19 Apr 2020 18:18:06 +1200
Subject: [PATCH 1/3] Fix addon search showing same addon multiple times for
 same addon ids

---
 xbmc/addons/AddonDatabase.cpp | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/xbmc/addons/AddonDatabase.cpp b/xbmc/addons/AddonDatabase.cpp
index c460547d3b24..886d90507054 100644
--- a/xbmc/addons/AddonDatabase.cpp
+++ b/xbmc/addons/AddonDatabase.cpp
@@ -836,7 +836,9 @@ bool CAddonDatabase::Search(const std::string& search, VECADDONS& addons)
       return false;
 
     std::string strSQL;
-    strSQL=PrepareSQL("SELECT addonID FROM addons WHERE name LIKE '%%%s%%' OR summary LIKE '%%%s%%' OR description LIKE '%%%s%%'", search.c_str(), search.c_str(), search.c_str());
+    strSQL = PrepareSQL("SELECT id FROM addons WHERE name LIKE '%%%s%%' OR summary LIKE '%%%s%%' "
+                  "OR description LIKE '%%%s%%'", search.c_str(), search.c_str(), search.c_str());
+
     CLog::Log(LOGDEBUG, "%s query: %s", __FUNCTION__, strSQL.c_str());
 
     if (!m_pDS->query(strSQL)) return false;
@@ -845,7 +847,7 @@ bool CAddonDatabase::Search(const std::string& search, VECADDONS& addons)
     while (!m_pDS->eof())
     {
       AddonPtr addon;
-      GetAddon(m_pDS->fv(0).get_asString(),addon);
+      GetAddon(m_pDS->fv(0).get_asInt(), addon);
       if (addon->Type() >= ADDON_UNKNOWN+1 && addon->Type() < ADDON_SCRAPER_LIBRARY)
         addons.push_back(addon);
       m_pDS->next();

From 07ed5259e8506a62d0ca0ea9def6c9e3dcf435bc Mon Sep 17 00:00:00 2001
From: Matt Huisman <me@matthuisman.nz>
Date: Sun, 19 Apr 2020 19:51:47 +1200
Subject: [PATCH 2/3] Must close database before returning

---
 xbmc/addons/AddonInstaller.cpp | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/xbmc/addons/AddonInstaller.cpp b/xbmc/addons/AddonInstaller.cpp
index b73a9aef5766..98ebab52fe03 100644
--- a/xbmc/addons/AddonInstaller.cpp
+++ b/xbmc/addons/AddonInstaller.cpp
@@ -334,7 +334,10 @@ bool CAddonInstaller::CheckDependencies(const AddonPtr &addon,
     // need to enable the dependency
     if (dep && CServiceBroker::GetAddonMgr().IsAddonDisabled(addonID))
       if (!CServiceBroker::GetAddonMgr().EnableAddon(addonID))
+      {
+        database.Close();
         return false;
+      }
 
     // at this point we have our dep, or the dep is optional (and we don't have it) so check that it's OK as well
     //! @todo should we assume that installed deps are OK?

From 75e15e1395b985e41015bc7355e0a8c8d261eb31 Mon Sep 17 00:00:00 2001
From: Matt Huisman <me@matthuisman.nz>
Date: Mon, 20 Apr 2020 00:42:26 +1200
Subject: [PATCH 3/3] Fix ClearFile if directory passed to it

---
 xbmc/filesystem/DirectoryCache.cpp | 1 +
 1 file changed, 1 insertion(+)

diff --git a/xbmc/filesystem/DirectoryCache.cpp b/xbmc/filesystem/DirectoryCache.cpp
index 0c74ad96fcfe..9d45519b0678 100644
--- a/xbmc/filesystem/DirectoryCache.cpp
+++ b/xbmc/filesystem/DirectoryCache.cpp
@@ -116,6 +116,7 @@ void CDirectoryCache::ClearFile(const std::string& strFile)
 {
   // Get rid of any URL options, else the compare may be wrong
   std::string strFile2 = CURL(strFile).GetWithoutOptions();
+  URIUtils::RemoveSlashAtEnd(strFile2);
 
   ClearDirectory(URIUtils::GetDirectory(strFile2));
 }
