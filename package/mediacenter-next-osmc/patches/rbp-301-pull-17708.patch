From 172737a27aaa7f20fb9b9a1e149379f1a13b4e2e Mon Sep 17 00:00:00 2001
From: Montellese <sascha.montellese@gmail.com>
Date: Mon, 20 Apr 2020 13:44:56 +0200
Subject: [PATCH 1/3] [depends] patch spdlog to require at least fmt 5.3.0

---
 cmake/modules/FindSpdlog.cmake                        |  1 +
 .../target/libspdlog/0001-fix_fmt_version.patch       | 11 +++++++++++
 tools/depends/target/libspdlog/Makefile               |  3 ++-
 3 files changed, 14 insertions(+), 1 deletion(-)
 create mode 100644 tools/depends/target/libspdlog/0001-fix_fmt_version.patch

diff --git a/cmake/modules/FindSpdlog.cmake b/cmake/modules/FindSpdlog.cmake
index d8d5d017a3db..1e8e2911e1af 100644
--- a/cmake/modules/FindSpdlog.cmake
+++ b/cmake/modules/FindSpdlog.cmake
@@ -38,6 +38,7 @@ if(ENABLE_INTERNAL_SPDLOG)
   externalproject_add(spdlog
                       URL ${SPDLOG_URL}
                       DOWNLOAD_DIR ${CMAKE_BINARY_DIR}/${CORE_BUILD_DIR}/download
+                      PATCH_COMMAND patch -p1 -i ${CMAKE_SOURCE_DIR}/tools/depends/target/libspdlog/0001-fix_fmt_version.patch
                       PREFIX ${CORE_BUILD_DIR}/spdlog
                       CMAKE_ARGS -DCMAKE_INSTALL_PREFIX=${CMAKE_BINARY_DIR}/${CORE_BUILD_DIR}
                                  -DCMAKE_CXX_EXTENSIONS=${CMAKE_CXX_EXTENSIONS}
diff --git a/tools/depends/target/libspdlog/0001-fix_fmt_version.patch b/tools/depends/target/libspdlog/0001-fix_fmt_version.patch
new file mode 100644
index 000000000000..1c7b86c3277d
--- /dev/null
+++ b/tools/depends/target/libspdlog/0001-fix_fmt_version.patch
@@ -0,0 +1,11 @@
+--- a/CMakeLists.txt
++++ b/CMakeLists.txt
+@@ -147,7 +147,7 @@
+ #---------------------------------------------------------------------------------------
+ if(SPDLOG_FMT_EXTERNAL OR SPDLOG_FMT_EXTERNAL_HO)
+     if (NOT TARGET fmt::fmt)
+-        find_package(fmt REQUIRED)
++        find_package(fmt 5.3.0 REQUIRED)
+     endif ()
+     target_compile_definitions(spdlog PUBLIC SPDLOG_FMT_EXTERNAL)
+     target_compile_definitions(spdlog_header_only INTERFACE SPDLOG_FMT_EXTERNAL)
diff --git a/tools/depends/target/libspdlog/Makefile b/tools/depends/target/libspdlog/Makefile
index 69a396f87623..7de6e9567aef 100644
--- a/tools/depends/target/libspdlog/Makefile
+++ b/tools/depends/target/libspdlog/Makefile
@@ -1,5 +1,5 @@
 -include ../../Makefile.include
-DEPS = Makefile
+DEPS = Makefile 0001-fix_fmt_version.patch
 
 # lib name, version
 LIBNAME=spdlog
@@ -52,6 +52,7 @@ endif
 	rm -rf $(PLATFORM); mkdir -p $(PLATFORM)
 	cd $(PLATFORM); $(ARCHIVE_TOOL) $(ARCHIVE_TOOL_FLAGS) $(TARBALLS_LOCATION)/$(ARCHIVE)
 	cd $(PLATFORM); rm -rf build; mkdir -p build
+	cd $(PLATFORM); patch -p1 -i ../0001-fix_fmt_version.patch
 	cd $(PLATFORM)/build; $(CMAKE) $(CMAKE_OPTIONS) ..
 
 $(LIBDYLIB): $(PLATFORM)

From 8c859667bdf3a3fa4ed4d2a074f29496df5c1f32 Mon Sep 17 00:00:00 2001
From: Montellese <sascha.montellese@gmail.com>
Date: Tue, 21 Apr 2020 00:08:28 +0200
Subject: [PATCH 2/3] [cmake] FindSpdlog.cmake: point CMAKE_PREFIX_PATH to
 internally built libraries

---
 cmake/modules/FindSpdlog.cmake | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/cmake/modules/FindSpdlog.cmake b/cmake/modules/FindSpdlog.cmake
index 1e8e2911e1af..270e486a137c 100644
--- a/cmake/modules/FindSpdlog.cmake
+++ b/cmake/modules/FindSpdlog.cmake
@@ -35,6 +35,7 @@ if(ENABLE_INTERNAL_SPDLOG)
 
   set(SPDLOG_LIBRARY ${CMAKE_BINARY_DIR}/${CORE_BUILD_DIR}/lib/libspdlog.a)
   set(SPDLOG_INCLUDE_DIR ${CMAKE_BINARY_DIR}/${CORE_BUILD_DIR}/include)
+
   externalproject_add(spdlog
                       URL ${SPDLOG_URL}
                       DOWNLOAD_DIR ${CMAKE_BINARY_DIR}/${CORE_BUILD_DIR}/download
@@ -49,6 +50,7 @@ if(ENABLE_INTERNAL_SPDLOG)
                                  -DSPDLOG_BUILD_TESTS=OFF
                                  -DSPDLOG_BUILD_BENCH=OFF
                                  -DSPDLOG_FMT_EXTERNAL=ON
+                                 -DCMAKE_PREFIX_PATH=${CMAKE_BINARY_DIR}/${CORE_BUILD_DIR}
                                  "${EXTRA_ARGS}"
                       BUILD_BYPRODUCTS ${SPDLOG_LIBRARY})
   set_target_properties(spdlog PROPERTIES FOLDER "External Projects")

From dda1b33208c750a4a597c64cceb223334eefd1c0 Mon Sep 17 00:00:00 2001
From: Montellese <sascha.montellese@gmail.com>
Date: Tue, 21 Apr 2020 15:07:52 +0200
Subject: [PATCH 3/3] [depends] libspdlog: point CMAKE_PREFIX_PATH to the
 provided prefix

---
 tools/depends/target/libspdlog/Makefile | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/tools/depends/target/libspdlog/Makefile b/tools/depends/target/libspdlog/Makefile
index 7de6e9567aef..9bbecbf461f1 100644
--- a/tools/depends/target/libspdlog/Makefile
+++ b/tools/depends/target/libspdlog/Makefile
@@ -28,7 +28,7 @@ else
     RETRIEVE_TOOL_FLAGS := -Ls --create-dirs -f -O
     ARCHIVE_TOOL := tar
     ARCHIVE_TOOL_FLAGS := --strip-components=1 -xf
-    CMAKE := cmake -DCMAKE_INSTALL_PREFIX=$(PREFIX)
+    CMAKE := cmake -DCMAKE_INSTALL_PREFIX=$(PREFIX) -DCMAKE_PREFIX_PATH=$(PREFIX)
   endif
 endif
 
