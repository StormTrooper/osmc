From 82f2b2186d5dc492343442db6ffb57ae4503082d Mon Sep 17 00:00:00 2001
From: Henrik Johnson <henrik@henrik.org>
Date: Tue, 5 May 2020 16:00:29 +0100
Subject: [PATCH] Event server keyboard events dont work for keys that have
 long press defined

---
 xbmc/input/InputManager.cpp | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/xbmc/input/InputManager.cpp b/xbmc/input/InputManager.cpp
index 6d84d1b7b746..f3e665e1007e 100644
--- a/xbmc/input/InputManager.cpp
+++ b/xbmc/input/InputManager.cpp
@@ -234,6 +234,7 @@ bool CInputManager::ProcessEventServer(int windowId, float frameTime)
       if (wKeyID & ES_FLAG_UNICODE)
       {
         key = CKey(0u, 0u, static_cast<wchar_t>(wKeyID & ~ES_FLAG_UNICODE), 0, 0, 0, 0);
+        key.SetFromService(true);
         return OnKey(key);
       }
 
@@ -461,7 +462,11 @@ bool CInputManager::OnKey(const CKey& key)
     }
     else
     {
-      if (!m_buttonTranslator->HasLongpressMapping(CServiceBroker::GetGUI()->GetWindowManager().GetActiveWindowOrDialog(), key))
+      // Event server keyboard doesn't give normal key up and key down, so don't
+      // process for long press if that is the source
+      if (key.GetFromService() ||
+          !m_buttonTranslator->HasLongpressMapping(
+              CServiceBroker::GetGUI()->GetWindowManager().GetActiveWindowOrDialog(), key))
       {
         m_LastKey.Reset();
         bHandled = HandleKey(key);
