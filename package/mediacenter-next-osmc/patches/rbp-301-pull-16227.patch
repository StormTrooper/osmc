From 9a1830bc8a5e37ce737aa39161c27de246d1b531 Mon Sep 17 00:00:00 2001
From: Kai Sommerfeld <kai.sommerfeld@gmx.com>
Date: Sat, 1 Jun 2019 07:27:45 +0200
Subject: [PATCH] [PVR] Reminders: Add settings to control reminder popup
 auto-close behavior.

---
 .../resources/strings.po                      | 39 +++++++++++++++++--
 system/settings/settings.xml                  | 21 ++++++++++
 xbmc/pvr/PVRGUIActions.cpp                    | 11 ++++--
 xbmc/settings/Settings.cpp                    |  2 +
 xbmc/settings/Settings.h                      |  2 +
 5 files changed, 67 insertions(+), 8 deletions(-)

diff --git a/addons/resource.language.en_gb/resources/strings.po b/addons/resource.language.en_gb/resources/strings.po
index 42d5a0ceed05..1b814e18d87b 100644
--- a/addons/resource.language.en_gb/resources/strings.po
+++ b/addons/resource.language.en_gb/resources/strings.po
@@ -10361,7 +10361,11 @@ msgctxt "#19214"
 msgid "Enter a valid URL for the new channel"
 msgstr ""
 
-#empty string with id 19215
+#. pvr settings "reminders" category label
+#: system/settings/settings.xml
+msgctxt "#19215"
+msgid "Reminders"
+msgstr ""
 
 #. used by several skins
 msgctxt "#19216"
@@ -10938,7 +10942,19 @@ msgctxt "#19312"
 msgid "PVR reminder"
 msgstr ""
 
-#empty strings from id 19313 to 19498
+#. pvr settings "reminder auto close delay" setting label
+#: system/settings/settings.xml
+msgctxt "#19313"
+msgid "Automatically close reminder popup after"
+msgstr ""
+
+#. pvr settings "schedule recording on reminder auto-close" setting label
+#: system/settings/settings.xml
+msgctxt "#19314"
+msgid "Schedule recording when auto-closing the reminder popup"
+msgstr ""
+
+#empty strings from id 19315 to 19498
 
 #. label for epg genre value
 #: xbmc/pvr/epg/Epg.cpp
@@ -18660,7 +18676,7 @@ msgstr ""
 
 #: system/settings/settings.xml
 msgctxt "#36233"
-msgid "This category contains the default recording duration settings."
+msgid "This category contains settings for recordings."
 msgstr ""
 
 #: system/settings/settings.xml
@@ -19014,7 +19030,22 @@ msgctxt "#36295"
 msgid "Set the the subtitle opacity."
 msgstr ""
 
-#empty strings from id 36296 to 36301
+#: system/settings/settings.xml
+msgctxt "#36296"
+msgid "This category contains settings for reminders."
+msgstr ""
+
+#: system/settings/settings.xml
+msgctxt "#36297"
+msgid "Choose a time in seconds after which PVR reminder popups will be automatically closed."
+msgstr ""
+
+#: system/settings/settings.xml
+msgctxt "#36298"
+msgid "If enabled, a recording for the programme to remind will be scheduled when auto-closing the reminder popup, if supported by the PVR add-on and backend."
+msgstr ""
+
+#empty strings from id 36299 to 36301
 
 #: system/settings/settings.xml
 msgctxt "#36302"
diff --git a/system/settings/settings.xml b/system/settings/settings.xml
index 7441f8c80703..efe97977d3d3 100755
--- a/system/settings/settings.xml
+++ b/system/settings/settings.xml
@@ -1543,6 +1543,27 @@
         </setting>
       </group>
     </category>
+    <category id="pvrreminders" label="19215" help="36296">
+      <group id="1" label="128">
+        <setting id="pvrreminders.autoclosedelay" type="integer" label="19313" help="36297">
+          <level>1</level>
+          <default>10</default>
+          <constraints>
+            <minimum>1</minimum>
+            <step>1</step>
+            <maximum>60</maximum>
+          </constraints>
+          <control type="spinner" format="string">
+            <formatlabel>14045</formatlabel>
+          </control>
+        </setting>
+        <setting id="pvrreminders.autorecord" type="boolean" label="19314" help="36298">
+          <level>1</level>
+          <default>true</default>
+          <control type="toggle" />
+        </setting>
+      </group>
+    </category>
     <category id="pvrpowermanagement" label="14095" help="36240">
       <group id="1" label="128">
         <setting id="pvrpowermanagement.enabled" type="boolean" label="305" help="36241">
diff --git a/xbmc/pvr/PVRGUIActions.cpp b/xbmc/pvr/PVRGUIActions.cpp
index 2d1d667b7b94..8ea79c1c6dc9 100644
--- a/xbmc/pvr/PVRGUIActions.cpp
+++ b/xbmc/pvr/PVRGUIActions.cpp
@@ -209,7 +209,9 @@ namespace PVR
       CSettings::SETTING_PVRPARENTAL_PIN,
       CSettings::SETTING_PVRPARENTAL_ENABLED,
       CSettings::SETTING_PVRPOWERMANAGEMENT_DAILYWAKEUPTIME,
-      CSettings::SETTING_PVRPOWERMANAGEMENT_BACKENDIDLETIME
+      CSettings::SETTING_PVRPOWERMANAGEMENT_BACKENDIDLETIME,
+      CSettings::SETTING_PVRREMINDERS_AUTOCLOSEDELAY,
+      CSettings::SETTING_PVRREMINDERS_AUTORECORD
     })
   {
   }
@@ -1958,7 +1960,7 @@ namespace PVR
 
     dialog->Reset();
     dialog->SetHeading(CVariant{19312}); // "PVR reminder"
-    dialog->SetAutoClose(10000);
+    dialog->SetAutoClose(m_settings.GetIntValue(CSettings::SETTING_PVRREMINDERS_AUTOCLOSEDELAY) * 1000);
     dialog->SetChoice(0, CVariant{19165}); // no: "Switch"
 
     std::string text = GetAnnouncerText(timer, 19307, 19308); // Reminder for ...
@@ -1971,7 +1973,8 @@ namespace PVR
       dialog->SetChoice(1, CVariant{264}); // yes: "Record"
       dialog->SetChoice(2, CVariant{222}); // custom: "Cancel"
 
-      text += "\n\n" + g_localizeStrings.Get(19309); // (Auto-close of this reminder will schedule a recording...)
+      if (m_settings.GetBoolValue(CSettings::SETTING_PVRREMINDERS_AUTORECORD))
+        text += "\n\n" + g_localizeStrings.Get(19309); // (Auto-close of this reminder will schedule a recording...)
     }
     else
     {
@@ -1984,7 +1987,7 @@ namespace PVR
     int iResult = dialog->GetResult();
     if (dialog->IsAutoClosed())
     {
-      if (bCanRecord)
+      if (bCanRecord && m_settings.GetBoolValue(CSettings::SETTING_PVRREMINDERS_AUTORECORD))
         iResult = 1; // YES -> schedule recording
       else
         iResult = -1; // CANCELLED -> do nothing
diff --git a/xbmc/settings/Settings.cpp b/xbmc/settings/Settings.cpp
index e1ed680a4701..f2a68289b253 100644
--- a/xbmc/settings/Settings.cpp
+++ b/xbmc/settings/Settings.cpp
@@ -220,6 +220,8 @@ const std::string CSettings::SETTING_PVRRECORD_MARGINSTART = "pvrrecord.marginst
 const std::string CSettings::SETTING_PVRRECORD_MARGINEND = "pvrrecord.marginend";
 const std::string CSettings::SETTING_PVRRECORD_TIMERNOTIFICATIONS = "pvrrecord.timernotifications";
 const std::string CSettings::SETTING_PVRRECORD_GROUPRECORDINGS = "pvrrecord.grouprecordings";
+const std::string CSettings::SETTING_PVRREMINDERS_AUTOCLOSEDELAY = "pvrreminders.autoclosedelay";
+const std::string CSettings::SETTING_PVRREMINDERS_AUTORECORD = "pvrreminders.autorecord";
 const std::string CSettings::SETTING_PVRPOWERMANAGEMENT_ENABLED = "pvrpowermanagement.enabled";
 const std::string CSettings::SETTING_PVRPOWERMANAGEMENT_BACKENDIDLETIME = "pvrpowermanagement.backendidletime";
 const std::string CSettings::SETTING_PVRPOWERMANAGEMENT_SETWAKEUPCMD = "pvrpowermanagement.setwakeupcmd";
diff --git a/xbmc/settings/Settings.h b/xbmc/settings/Settings.h
index 72b01e1de70c..405ea9fec51f 100644
--- a/xbmc/settings/Settings.h
+++ b/xbmc/settings/Settings.h
@@ -183,6 +183,8 @@ class CSettings : public CSettingsBase, public CSettingCreator, public CSettingC
   static const std::string SETTING_PVRRECORD_MARGINEND;
   static const std::string SETTING_PVRRECORD_TIMERNOTIFICATIONS;
   static const std::string SETTING_PVRRECORD_GROUPRECORDINGS;
+  static const std::string SETTING_PVRREMINDERS_AUTOCLOSEDELAY;
+  static const std::string SETTING_PVRREMINDERS_AUTORECORD;
   static const std::string SETTING_PVRPOWERMANAGEMENT_ENABLED;
   static const std::string SETTING_PVRPOWERMANAGEMENT_BACKENDIDLETIME;
   static const std::string SETTING_PVRPOWERMANAGEMENT_SETWAKEUPCMD;
