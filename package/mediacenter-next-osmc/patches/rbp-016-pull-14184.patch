From 730a871b0136a570c90f1447132f402df966dedd Mon Sep 17 00:00:00 2001
From: fritsch <Peter.Fruehberger@gmail.com>
Date: Sun, 15 Jul 2018 14:21:00 +0200
Subject: [PATCH] AESinkPULSE: Don't deadlock - separate callback handling

---
 xbmc/cores/AudioEngine/Sinks/AESinkPULSE.cpp | 35 +++++++++++++++++-----------
 1 file changed, 22 insertions(+), 13 deletions(-)

diff --git a/xbmc/cores/AudioEngine/Sinks/AESinkPULSE.cpp b/xbmc/cores/AudioEngine/Sinks/AESinkPULSE.cpp
index ec227cd1d491..8bd8ec93e7a4 100644
--- a/xbmc/cores/AudioEngine/Sinks/AESinkPULSE.cpp
+++ b/xbmc/cores/AudioEngine/Sinks/AESinkPULSE.cpp
@@ -226,35 +226,44 @@ static void SinkChangedCallback(pa_context *c, pa_subscription_event_type_t t, u
   CSingleLock lock(p->m_sec);
   if (p->IsInitialized())
   {
-    if ((t & PA_SUBSCRIPTION_EVENT_TYPE_MASK) == PA_SUBSCRIPTION_EVENT_NEW)
-    {
-       CLog::Log(LOGDEBUG, "Sink appeared");
-       CServiceBroker::GetActiveAE()->DeviceChange();
-    }
-    else if ((t & PA_SUBSCRIPTION_EVENT_TYPE_MASK) == PA_SUBSCRIPTION_EVENT_REMOVE)
-    {
-      CLog::Log(LOGDEBUG, "Sink removed");
-      CServiceBroker::GetActiveAE()->DeviceChange();
-    }
-    else if ((t & PA_SUBSCRIPTION_EVENT_TYPE_MASK) == PA_SUBSCRIPTION_EVENT_CHANGE)
+    if ((t & PA_SUBSCRIPTION_EVENT_FACILITY_MASK) == PA_SUBSCRIPTION_EVENT_SINK_INPUT)
     {
       // when we get a sink input event volume might have changed
-      if (t & PA_SUBSCRIPTION_EVENT_SINK_INPUT)
+      if ((t & PA_SUBSCRIPTION_EVENT_TYPE_MASK) == PA_SUBSCRIPTION_EVENT_CHANGE)
       {
         if (idx != pa_stream_get_index(p->GetInternalStream()))
           return;
 
+        // we need to leave the lock as we trigger a second callback
+        CSingleExit exitlock(p->m_sec);
         pa_operation* op = pa_context_get_sink_input_info(c, idx, SinkInputInfoCallback, p);
         if (op == NULL)
           CLog::Log(LOGERROR, "PulseAudio: Failed to sync volume");
         else
           pa_operation_unref(op);
       }
-      else // legacy just for tracking
+    }
+    else if ((t & PA_SUBSCRIPTION_EVENT_FACILITY_MASK) == PA_SUBSCRIPTION_EVENT_SINK)
+    {
+      if ((t & PA_SUBSCRIPTION_EVENT_TYPE_MASK) == PA_SUBSCRIPTION_EVENT_NEW)
+      {
+        CLog::Log(LOGDEBUG, "Sink appeared");
+        CServiceBroker::GetActiveAE()->DeviceChange();
+      }
+      else if ((t & PA_SUBSCRIPTION_EVENT_TYPE_MASK) == PA_SUBSCRIPTION_EVENT_REMOVE)
+      {
+        CLog::Log(LOGDEBUG, "Sink removed");
+        CServiceBroker::GetActiveAE()->DeviceChange();
+      }
+      else if ((t & PA_SUBSCRIPTION_EVENT_TYPE_MASK) == PA_SUBSCRIPTION_EVENT_CHANGE)
       {
         CLog::Log(LOGDEBUG, "Sink changed");
       }
     }
+    else
+    {
+      CLog::Log(LOGDEBUG, "Not subscribed to Event: %d", static_cast<int>(t));
+    }
   }
 }
 
