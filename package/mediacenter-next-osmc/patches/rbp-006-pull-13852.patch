From e8c85cf12abc713ae7ca040be9a8259a6544d7aa Mon Sep 17 00:00:00 2001
From: Rechi <Rechi@users.noreply.github.com>
Date: Fri, 4 May 2018 20:00:00 +0200
Subject: [PATCH] [fix][json-rpc] execute GUI.ActivateWindow asynchronous

---
 xbmc/interfaces/json-rpc/GUIOperations.cpp | 20 ++++++++++++--------
 1 file changed, 12 insertions(+), 8 deletions(-)

diff --git a/xbmc/interfaces/json-rpc/GUIOperations.cpp b/xbmc/interfaces/json-rpc/GUIOperations.cpp
index 341a8a9d8e3d..8305bc60e2fa 100644
--- a/xbmc/interfaces/json-rpc/GUIOperations.cpp
+++ b/xbmc/interfaces/json-rpc/GUIOperations.cpp
@@ -26,6 +26,7 @@
 #include "guilib/GUIComponent.h"
 #include "guilib/GUIWindowManager.h"
 #include "input/Key.h"
+#include "input/WindowTranslator.h"
 #include "interfaces/builtins/Builtins.h"
 #include "dialogs/GUIDialogKaiToast.h"
 #include "addons/AddonManager.h"
@@ -59,17 +60,20 @@ JSONRPC_STATUS CGUIOperations::GetProperties(const std::string &method, ITranspo
 
 JSONRPC_STATUS CGUIOperations::ActivateWindow(const std::string &method, ITransportLayer *transport, IClient *client, const CVariant &parameterObject, CVariant &result)
 {
-  CVariant params = parameterObject["parameters"];
-  std::string cmd = "ActivateWindow(" + parameterObject["window"].asString();
-  for (CVariant::iterator_array param = params.begin_array(); param != params.end_array(); param++)
+  int iWindow = CWindowTranslator::TranslateWindow(parameterObject["window"].asString());
+  if (iWindow != WINDOW_INVALID)
   {
-    if (param->isString() && !param->empty())
-      cmd += "," + param->asString();
+    std::vector<std::string> params;
+    for (CVariant::const_iterator_array param = parameterObject["parameters"].begin_array(); param != parameterObject["parameters"].end_array(); param++)
+    {
+      if (param->isString() && !param->empty())
+        params.push_back(param->asString());
+    }
+    CApplicationMessenger::GetInstance().PostMsg(TMSG_GUI_ACTIVATE_WINDOW, iWindow, 0, nullptr, "", params);
+    return ACK;
   }
-  cmd += ")";
-  CBuiltins::GetInstance().Execute(cmd);
 
-  return ACK;
+  return InvalidParams;
 }
 
 JSONRPC_STATUS CGUIOperations::ShowNotification(const std::string &method, ITransportLayer *transport, IClient *client, const CVariant &parameterObject, CVariant &result)
