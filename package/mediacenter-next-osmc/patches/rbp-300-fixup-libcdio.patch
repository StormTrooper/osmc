From f3486f2e019d5f731a70b97b84da59bd4a875817 Mon Sep 17 00:00:00 2001
From: Rechi <Rechi@users.noreply.github.com>
Date: Wed, 28 Feb 2018 10:00:00 +0100
Subject: [PATCH] [fix] add back libcdio 0.83 compatibility after 98565c188b

Ubuntu 16.04 (Xenial) has libcdio 0.83
---
 cmake/modules/FindCdio.cmake               |  2 +-
 xbmc/music/tags/MusicInfoTagLoaderCDDA.cpp |  7 +++++++
 xbmc/storage/cdioSupport.cpp               | 13 +++++++++++++
 3 files changed, 21 insertions(+), 1 deletion(-)

diff --git a/cmake/modules/FindCdio.cmake b/cmake/modules/FindCdio.cmake
index f4e65cc5bf55..cce7f2ace902 100644
--- a/cmake/modules/FindCdio.cmake
+++ b/cmake/modules/FindCdio.cmake
@@ -14,7 +14,7 @@
 #   CDIO::CDIO - The cdio library
 
 if(PKG_CONFIG_FOUND)
-  pkg_check_modules(PC_CDIO libcdio>=0.84 libiso9660 QUIET)
+  pkg_check_modules(PC_CDIO libcdio>=0.78 libiso9660 QUIET)
 endif()
 
 find_path(CDIO_INCLUDE_DIR NAMES cdio/cdio.h
diff --git a/xbmc/music/tags/MusicInfoTagLoaderCDDA.cpp b/xbmc/music/tags/MusicInfoTagLoaderCDDA.cpp
index 7605e28dc7cc..fc6b8bde7a1d 100644
--- a/xbmc/music/tags/MusicInfoTagLoaderCDDA.cpp
+++ b/xbmc/music/tags/MusicInfoTagLoaderCDDA.cpp
@@ -33,6 +33,13 @@ using namespace MEDIA_DETECT;
 using namespace CDDB;
 #endif
 
+//! @todo - remove after Ubuntu 16.04 (Xenial) is EOL
+#if !defined(LIBCDIO_VERSION_NUM) || (LIBCDIO_VERSION_NUM <= 83)
+#define CDTEXT_FIELD_TITLE CDTEXT_TITLE
+#define CDTEXT_FIELD_PERFORMER CDTEXT_PERFORMER
+#define CDTEXT_FIELD_GENRE CDTEXT_GENRE
+#endif
+
 CMusicInfoTagLoaderCDDA::CMusicInfoTagLoaderCDDA(void) = default;
 
 CMusicInfoTagLoaderCDDA::~CMusicInfoTagLoaderCDDA() = default;
diff --git a/xbmc/storage/cdioSupport.cpp b/xbmc/storage/cdioSupport.cpp
index b50cc5f6756a..fdac25d915ff 100644
--- a/xbmc/storage/cdioSupport.cpp
+++ b/xbmc/storage/cdioSupport.cpp
@@ -637,14 +637,27 @@ void CCdIoSupport::GetCdTextInfo(xbmc_cdtext_t &xcdt, int trackNum)
   CSingleLock lock(*m_cdio);
 
   // Get the CD-Text , if any
+#if defined(LIBCDIO_VERSION_NUM) && (LIBCDIO_VERSION_NUM >= 84)
   cdtext_t *pcdtext = static_cast<cdtext_t*>( cdio_get_cdtext(cdio) );
+#else
+  //! @todo - remove after Ubuntu 16.04 (Xenial) is EOL
+  cdtext_t *pcdtext = (cdtext_t *)::cdio_get_cdtext(cdio, trackNum);
+#endif 
   
   if (pcdtext == NULL)
     return ;
 
+#if defined(LIBCDIO_VERSION_NUM) && (LIBCDIO_VERSION_NUM >= 84)
   for (int i=0; i < MAX_CDTEXT_FIELDS; i++) 
     if (cdtext_get_const(pcdtext, (cdtext_field_t)i, trackNum))
       xcdt[(cdtext_field_t)i] = cdtext_field2str((cdtext_field_t)i);
+#else
+  //! @todo - remove after Ubuntu 16.04 (Xenial) is EOL
+  // Same ids used in libcdio and for our structure + the ids are consecutive make this copy loop safe.
+  for (int i = 0; i < MAX_CDTEXT_FIELDS; i++)
+    if (pcdtext->field[i])
+      xcdt[(cdtext_field_t)i] = pcdtext->field[(cdtext_field_t)i];
+#endif
 #endif // TARGET_WINDOWS
 }
 
