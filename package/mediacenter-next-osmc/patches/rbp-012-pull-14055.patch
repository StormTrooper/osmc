From 1c5b5e81cb600aa1f852b809317c34bdb555d8e9 Mon Sep 17 00:00:00 2001
From: Rainer Hochecker <fernetmenta@online.de>
Date: Fri, 15 Jun 2018 15:59:05 +0200
Subject: [PATCH] PAPlayer: fix advancing playlist on error

---
 xbmc/Application.cpp             | 2 +-
 xbmc/cores/paplayer/PAPlayer.cpp | 3 ++-
 2 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/xbmc/Application.cpp b/xbmc/Application.cpp
index fa1dd103980b..c33a3c1760fe 100644
--- a/xbmc/Application.cpp
+++ b/xbmc/Application.cpp
@@ -4045,7 +4045,7 @@ bool CApplication::OnMessage(CGUIMessage& message)
       if (!m_itemCurrentFile->IsLiveTV())
       {
         CGUIDialogBusy* dialog = CServiceBroker::GetGUI()->GetWindowManager().GetWindow<CGUIDialogBusy>(WINDOW_DIALOG_BUSY);
-        if (dialog)
+        if (dialog && !dialog->IsDialogRunning())
           dialog->WaitOnEvent(m_playerEvent);
       }
 
diff --git a/xbmc/cores/paplayer/PAPlayer.cpp b/xbmc/cores/paplayer/PAPlayer.cpp
index acc4833686e0..527147b395b1 100644
--- a/xbmc/cores/paplayer/PAPlayer.cpp
+++ b/xbmc/cores/paplayer/PAPlayer.cpp
@@ -339,10 +339,11 @@ bool PAPlayer::QueueNextFileEx(const CFileItem &file, bool fadeIn)
   {
     CLog::Log(LOGWARNING, "PAPlayer::QueueNextFileEx - Failed to create the decoder");
 
-    delete si;
     // advance playlist
     AdvancePlaylistOnError(si->m_fileItem);
     m_callback.OnQueueNextItem();
+
+    delete si;
     return false;
   }
 
