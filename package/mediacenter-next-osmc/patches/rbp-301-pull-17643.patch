From 613d3216a66f0c6a11669641ac55f529ee93ffd5 Mon Sep 17 00:00:00 2001
From: Lukas Rusak <lorusak@gmail.com>
Date: Thu, 9 Apr 2020 08:36:26 -0700
Subject: [PATCH 1/4] [windows] add libdav1d to build depends

---
 .../BuildDependencies/scripts/0_package.target-win10-arm.list    | 1 +
 .../BuildDependencies/scripts/0_package.target-win10-win32.list  | 1 +
 .../BuildDependencies/scripts/0_package.target-win10-x64.list    | 1 +
 project/BuildDependencies/scripts/0_package.target-win32.list    | 1 +
 project/BuildDependencies/scripts/0_package.target-x64.list      | 1 +
 5 files changed, 5 insertions(+)

diff --git a/project/BuildDependencies/scripts/0_package.target-win10-arm.list b/project/BuildDependencies/scripts/0_package.target-win10-arm.list
index 97ba9343359c..6909f695333b 100644
--- a/project/BuildDependencies/scripts/0_package.target-win10-arm.list
+++ b/project/BuildDependencies/scripts/0_package.target-win10-arm.list
@@ -8,6 +8,7 @@
 ;PLEASE KEEP THIS LIST IN ALPHABETICAL ORDER!
 crossguid-0.2.2-win10-arm-v141-20200105.7z
 curl-7.67.0-win10-arm-v141-20200105.7z
+dav1d-0.6.0-win10-arm-v141-20200409.7z
 flatbuffers-1.11.0-20200105.7z
 fmt-6.1.2-win10-arm-v141-20200105.7z
 freetype-2.10.1-win10-arm-v141-20200105.7z
diff --git a/project/BuildDependencies/scripts/0_package.target-win10-win32.list b/project/BuildDependencies/scripts/0_package.target-win10-win32.list
index d70422581fc4..8464b14a0f0b 100644
--- a/project/BuildDependencies/scripts/0_package.target-win10-win32.list
+++ b/project/BuildDependencies/scripts/0_package.target-win10-win32.list
@@ -8,6 +8,7 @@
 ;PLEASE KEEP THIS LIST IN ALPHABETICAL ORDER!
 crossguid-0.2.2-win10-win32-v141-20200105.7z
 curl-7.67.0-win10-win32-v141-20200105.7z
+dav1d-0.6.0-win10-win32-v141-20200409.7z
 flatbuffers-1.11.0-20200105.7z
 fmt-6.1.2-win10-win32-v141-20200105.7z
 freetype-2.10.1-win10-win32-v141-20200105.7z
diff --git a/project/BuildDependencies/scripts/0_package.target-win10-x64.list b/project/BuildDependencies/scripts/0_package.target-win10-x64.list
index c4f3053ad34a..99c2439396b5 100644
--- a/project/BuildDependencies/scripts/0_package.target-win10-x64.list
+++ b/project/BuildDependencies/scripts/0_package.target-win10-x64.list
@@ -8,6 +8,7 @@
 ;PLEASE KEEP THIS LIST IN ALPHABETICAL ORDER!
 crossguid-0.2.2-win10-x64-v141-20200105.7z
 curl-7.67.0-win10-x64-v141-20200105.7z
+dav1d-0.6.0-win10-x64-v141-20200409.7z
 flatbuffers-1.11.0-20200105.7z
 fmt-6.1.2-win10-x64-v141-20200105.7z
 freetype-2.10.1-win10-x64-v141-20200105.7z
diff --git a/project/BuildDependencies/scripts/0_package.target-win32.list b/project/BuildDependencies/scripts/0_package.target-win32.list
index 189a1d0a5b78..041e21367e23 100644
--- a/project/BuildDependencies/scripts/0_package.target-win32.list
+++ b/project/BuildDependencies/scripts/0_package.target-win32.list
@@ -8,6 +8,7 @@
 ;PLEASE KEEP THIS LIST IN ALPHABETICAL ORDER!
 crossguid-0.2.2-win32-v141-20200105.7z
 curl-7.67.0-win32-v141-20200105.7z
+dav1d-0.6.0-win32-v141-20200409.7z
 detours-64ec13-win32-v141-20200105.7z
 dnssd-878.260.1-win32-v141-20200105.7z
 flatbuffers-1.11.0-20200105.7z
diff --git a/project/BuildDependencies/scripts/0_package.target-x64.list b/project/BuildDependencies/scripts/0_package.target-x64.list
index e78c50293b31..bea57cfb850c 100644
--- a/project/BuildDependencies/scripts/0_package.target-x64.list
+++ b/project/BuildDependencies/scripts/0_package.target-x64.list
@@ -8,6 +8,7 @@
 ;PLEASE KEEP THIS LIST IN ALPHABETICAL ORDER!
 crossguid-0.2.2-x64-v141-20200105.7z
 curl-7.67.0-x64-v141-20200105.7z
+dav1d-0.6.0-x64-v141-20200409.7z
 detours-64ec13-x64-v141-20200105.7z
 dnssd-878.260.1-x64-v141-20200105.7z
 flatbuffers-1.11.0-20200105.7z

From 23551b162513daecc6d0b5a372c80d2750601d52 Mon Sep 17 00:00:00 2001
From: Lukas Rusak <lorusak@gmail.com>
Date: Sat, 11 Apr 2020 13:08:36 -0700
Subject: [PATCH 2/4] [cmake] look for libdav1d as well

---
 cmake/modules/FindDav1d.cmake | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/cmake/modules/FindDav1d.cmake b/cmake/modules/FindDav1d.cmake
index 789a35e14430..a2b8023f44bd 100644
--- a/cmake/modules/FindDav1d.cmake
+++ b/cmake/modules/FindDav1d.cmake
@@ -13,7 +13,7 @@ if(PKG_CONFIG_FOUND)
   pkg_check_modules(PC_DAV1D dav1d QUIET)
 endif()
 
-find_library(DAV1D_LIBRARY NAMES dav1d
+find_library(DAV1D_LIBRARY NAMES dav1d libdav1d
                            PATHS ${PC_DAV1D_LIBDIR})
 
 find_path(DAV1D_INCLUDE_DIR NAMES dav1d/dav1d.h

From adbd81bc101b689c8cb71b88262da26bf7bbee18 Mon Sep 17 00:00:00 2001
From: Lukas Rusak <lorusak@gmail.com>
Date: Wed, 15 Apr 2020 09:00:25 -0700
Subject: [PATCH 3/4] [cmake] dav1d: make optional for internal build

---
 CMakeLists.txt                 | 1 +
 cmake/modules/FindDav1d.cmake  | 5 -----
 cmake/modules/FindFFMPEG.cmake | 4 +++-
 3 files changed, 4 insertions(+), 6 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index a555ac7803b2..ffd7d310ed81 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -146,6 +146,7 @@ set(optional_deps Alsa
                   CCache
                   CEC
                   ClangFormat
+                  Dav1d
                   DBus
                   Iso9660pp
                   LCMS2
diff --git a/cmake/modules/FindDav1d.cmake b/cmake/modules/FindDav1d.cmake
index a2b8023f44bd..7625afa1d281 100644
--- a/cmake/modules/FindDav1d.cmake
+++ b/cmake/modules/FindDav1d.cmake
@@ -21,11 +21,6 @@ find_path(DAV1D_INCLUDE_DIR NAMES dav1d/dav1d.h
 
 set(DAV1D_VERSION ${PC_DAV1D_VERSION})
 
-if (NOT DAV1D_LIBRARY AND NOT DAV1D_INCLUDE_DIR AND NOT DAV1D_VERSION)
-  set(ENABLE_INTERNAL_DAV1D ON)
-  message(STATUS "libdav1d not found, falling back to internal build")
-endif()
-
 if(ENABLE_INTERNAL_DAV1D)
   include(ExternalProject)
 
diff --git a/cmake/modules/FindFFMPEG.cmake b/cmake/modules/FindFFMPEG.cmake
index 59c6600d95ee..387b3f926f02 100644
--- a/cmake/modules/FindFFMPEG.cmake
+++ b/cmake/modules/FindFFMPEG.cmake
@@ -229,7 +229,9 @@ if(NOT FFMPEG_FOUND)
     message(STATUS "FFMPEG_URL: ${FFMPEG_URL}")
   endif()
 
-  find_package(Dav1d)
+  if (NOT DAV1D_FOUND)
+    message(STATUS "dav1d not found, internal ffmpeg build will be missing AV1 support!")
+  endif()
 
   set(FFMPEG_OPTIONS -DENABLE_CCACHE=${ENABLE_CCACHE}
                      -DCCACHE_PROGRAM=${CCACHE_PROGRAM}

From cde27e6ac73242b9ba0f200454235d6abc2112f6 Mon Sep 17 00:00:00 2001
From: Lukas Rusak <lorusak@gmail.com>
Date: Thu, 9 Apr 2020 08:36:49 -0700
Subject: [PATCH 4/4] [windows] enable libdav1d in the ffmpeg build

---
 tools/buildsteps/windows/ffmpeg_options.txt         |  1 +
 .../windows/patches/0005-ffmpeg-detect-dav1d.patch  | 13 +++++++++++++
 2 files changed, 14 insertions(+)
 create mode 100644 tools/buildsteps/windows/patches/0005-ffmpeg-detect-dav1d.patch

diff --git a/tools/buildsteps/windows/ffmpeg_options.txt b/tools/buildsteps/windows/ffmpeg_options.txt
index 30de94404b25..fbaf4174e847 100644
--- a/tools/buildsteps/windows/ffmpeg_options.txt
+++ b/tools/buildsteps/windows/ffmpeg_options.txt
@@ -16,3 +16,4 @@
 --enable-runtime-cpudetect
 --enable-static
 --enable-zlib
+--enable-libdav1d
diff --git a/tools/buildsteps/windows/patches/0005-ffmpeg-detect-dav1d.patch b/tools/buildsteps/windows/patches/0005-ffmpeg-detect-dav1d.patch
new file mode 100644
index 000000000000..716465ff0f81
--- /dev/null
+++ b/tools/buildsteps/windows/patches/0005-ffmpeg-detect-dav1d.patch
@@ -0,0 +1,13 @@
+diff --git a/configure b/configure
+index 34c2adb4a4..d66d4e8483 100755
+--- a/configure
++++ b/configure
+@@ -6196,7 +6196,7 @@ enabled libcelt           && require libcelt celt/celt.h celt_decode -lcelt0 &&
+                                die "ERROR: libcelt must be installed and version must be >= 0.11.0."; }
+ enabled libcaca           && require_pkg_config libcaca caca caca.h caca_create_canvas
+ enabled libcodec2         && require libcodec2 codec2/codec2.h codec2_create -lcodec2
+-enabled libdav1d          && require_pkg_config libdav1d "dav1d >= 0.2.1" "dav1d/dav1d.h" dav1d_version
++enabled libdav1d          && require libdav1d dav1d/dav1d.h dav1d_version -llibdav1d
+ enabled libdavs2          && require_pkg_config libdavs2 "davs2 >= 1.6.0" davs2.h davs2_decoder_open
+ enabled libdc1394         && require_pkg_config libdc1394 libdc1394-2 dc1394/dc1394.h dc1394_new
+ enabled libdrm            && require_pkg_config libdrm libdrm xf86drm.h drmGetVersion
