From 5c0811603129374523c629026a66d04a02f659d0 Mon Sep 17 00:00:00 2001
From: montellese <montellese@kodi.tv>
Date: Fri, 15 May 2020 23:55:48 +0200
Subject: [PATCH] [windows] BuildSetup.bat: use a platform-specific kodi-build
 directory

---
 .gitignore                                        | 2 +-
 tools/buildsteps/windows/BuildSetup.bat           | 2 +-
 tools/buildsteps/windows/arm-uwp/BuildSetup.bat   | 1 +
 tools/buildsteps/windows/run-tests.bat            | 2 +-
 tools/buildsteps/windows/win32-uwp/BuildSetup.bat | 1 +
 tools/buildsteps/windows/win32/BuildSetup.bat     | 1 +
 tools/buildsteps/windows/win32/run-tests.bat      | 3 +++
 tools/buildsteps/windows/x64-uwp/BuildSetup.bat   | 1 +
 tools/buildsteps/windows/x64/BuildSetup.bat       | 1 +
 tools/buildsteps/windows/x64/run-tests.bat        | 3 +++
 10 files changed, 14 insertions(+), 3 deletions(-)

diff --git a/.gitignore b/.gitignore
index 99c0354eaf59..608d40673dab 100644
--- a/.gitignore
+++ b/.gitignore
@@ -98,7 +98,7 @@ cmake_install.cmake
 /kodi-test
 /kodi-xrandr
 /*.patch
-/kodi-build/
+/kodi-build*/
 /gtestresults.xml
 
 # /addons/
diff --git a/tools/buildsteps/windows/BuildSetup.bat b/tools/buildsteps/windows/BuildSetup.bat
index 4328b234f4db..0c4487c9e332 100644
--- a/tools/buildsteps/windows/BuildSetup.bat
+++ b/tools/buildsteps/windows/BuildSetup.bat
@@ -63,7 +63,7 @@ FOR %%b in (%*) DO (
 
 SET PreferredToolArchitecture=x64
 SET buildconfig=Release
-set WORKSPACE=%base_dir%\kodi-build
+set WORKSPACE=%base_dir%\kodi-build.%TARGET_PLATFORM%
 
 
   :: sets the BRANCH env var
diff --git a/tools/buildsteps/windows/arm-uwp/BuildSetup.bat b/tools/buildsteps/windows/arm-uwp/BuildSetup.bat
index 49bb5961e92e..18b3ecf86c3d 100644
--- a/tools/buildsteps/windows/arm-uwp/BuildSetup.bat
+++ b/tools/buildsteps/windows/arm-uwp/BuildSetup.bat
@@ -11,6 +11,7 @@ IF ERRORLEVEL 1 (
 
 SET cmakeGenerator=Visual Studio %vsver% ARM
 SET TARGET_ARCHITECTURE=arm
+SET TARGET_PLATFORM=%TARGET_ARCHITECTURE%-uwp
 SET cmakeProps=-DCMAKE_SYSTEM_NAME=WindowsStore -DCMAKE_SYSTEM_VERSION=%UCRTVersion%
 
 CALL BuildSetup.bat %*
diff --git a/tools/buildsteps/windows/run-tests.bat b/tools/buildsteps/windows/run-tests.bat
index 04c2f3e7a36c..04ff96836543 100644
--- a/tools/buildsteps/windows/run-tests.bat
+++ b/tools/buildsteps/windows/run-tests.bat
@@ -5,7 +5,7 @@ REM setup all paths
 PUSHD %~dp0\..\..\..
 SET WORKSPACE=%CD%
 POPD
-cd %WORKSPACE%\kodi-build
+cd %WORKSPACE%\kodi-build.%TARGET_PLATFORM%
 SET builddeps_dir=%WORKSPACE%\project\BuildDependencies
 SET msys_dir=%builddeps_dir%\msys64
 IF NOT EXIST %msys_dir% (SET msys_dir=%builddeps_dir%\msys32)
diff --git a/tools/buildsteps/windows/win32-uwp/BuildSetup.bat b/tools/buildsteps/windows/win32-uwp/BuildSetup.bat
index 545f0d7a4851..3aba2378f162 100644
--- a/tools/buildsteps/windows/win32-uwp/BuildSetup.bat
+++ b/tools/buildsteps/windows/win32-uwp/BuildSetup.bat
@@ -10,6 +10,7 @@ IF ERRORLEVEL 1 (
 
 SET cmakeGenerator=Visual Studio %vsver%
 SET TARGET_ARCHITECTURE=x86
+SET TARGET_PLATFORM=win32-uwp
 SET cmakeProps=-DCMAKE_SYSTEM_NAME=WindowsStore -DCMAKE_SYSTEM_VERSION=%UCRTVersion%
 
 CALL BuildSetup.bat %*
diff --git a/tools/buildsteps/windows/win32/BuildSetup.bat b/tools/buildsteps/windows/win32/BuildSetup.bat
index ecfb42ff769c..70764985ba7a 100644
--- a/tools/buildsteps/windows/win32/BuildSetup.bat
+++ b/tools/buildsteps/windows/win32/BuildSetup.bat
@@ -11,6 +11,7 @@ IF ERRORLEVEL 1 (
 
 SET cmakeGenerator=Visual Studio %vsver%
 SET TARGET_ARCHITECTURE=x86
+SET TARGET_PLATFORM=%TARGET_ARCHITECTURE%
 
 CALL BuildSetup.bat %*
 POPD
diff --git a/tools/buildsteps/windows/win32/run-tests.bat b/tools/buildsteps/windows/win32/run-tests.bat
index f93b85d1f40d..4d811fd2001f 100644
--- a/tools/buildsteps/windows/win32/run-tests.bat
+++ b/tools/buildsteps/windows/win32/run-tests.bat
@@ -1,5 +1,8 @@
 @ECHO OFF
 
 PUSHD %~dp0\..
+
+SET TARGET_PLATFORM=x86
+
 CALL run-tests.bat
 POPD
diff --git a/tools/buildsteps/windows/x64-uwp/BuildSetup.bat b/tools/buildsteps/windows/x64-uwp/BuildSetup.bat
index 8ef44c3ade25..037c536b809a 100644
--- a/tools/buildsteps/windows/x64-uwp/BuildSetup.bat
+++ b/tools/buildsteps/windows/x64-uwp/BuildSetup.bat
@@ -10,6 +10,7 @@ IF ERRORLEVEL 1 (
 
 SET cmakeGenerator=Visual Studio %vsver% Win64
 SET TARGET_ARCHITECTURE=x64
+SET TARGET_PLATFORM=%TARGET_ARCHITECTURE%-uwp
 SET cmakeProps=-DCMAKE_SYSTEM_NAME=WindowsStore -DCMAKE_SYSTEM_VERSION=%UCRTVersion%
 
 CALL BuildSetup.bat %*
diff --git a/tools/buildsteps/windows/x64/BuildSetup.bat b/tools/buildsteps/windows/x64/BuildSetup.bat
index 4ff91a889199..6434d3f0c09b 100644
--- a/tools/buildsteps/windows/x64/BuildSetup.bat
+++ b/tools/buildsteps/windows/x64/BuildSetup.bat
@@ -10,6 +10,7 @@ IF ERRORLEVEL 1 (
 
 SET cmakeGenerator=Visual Studio %vsver% Win64
 SET TARGET_ARCHITECTURE=x64
+SET TARGET_PLATFORM=%TARGET_ARCHITECTURE%
 
 CALL BuildSetup.bat %*
 POPD
diff --git a/tools/buildsteps/windows/x64/run-tests.bat b/tools/buildsteps/windows/x64/run-tests.bat
index f93b85d1f40d..0c099b526811 100644
--- a/tools/buildsteps/windows/x64/run-tests.bat
+++ b/tools/buildsteps/windows/x64/run-tests.bat
@@ -1,5 +1,8 @@
 @ECHO OFF
 
 PUSHD %~dp0\..
+
+SET TARGET_PLATFORM=x64
+
 CALL run-tests.bat
 POPD
