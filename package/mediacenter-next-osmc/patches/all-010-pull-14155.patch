From 714b8084ad8ff20b81bc3586325d7aef0489cdc8 Mon Sep 17 00:00:00 2001
From: ace20022 <ace20022@ymail.com>
Date: Mon, 2 Jul 2018 21:58:48 +0200
Subject: [PATCH] [videplayer] Fix a crash when stopping playback while
 teletext is opened.

---
 xbmc/ApplicationPlayer.cpp                   | 2 +-
 xbmc/ApplicationPlayer.h                     | 2 +-
 xbmc/cores/IPlayer.h                         | 3 ++-
 xbmc/cores/VideoPlayer/VideoPlayer.cpp       | 2 +-
 xbmc/cores/VideoPlayer/VideoPlayer.h         | 2 +-
 xbmc/cores/VideoPlayer/VideoPlayerTeletext.h | 2 +-
 xbmc/video/Teletext.h                        | 2 +-
 7 files changed, 8 insertions(+), 7 deletions(-)

diff --git a/xbmc/ApplicationPlayer.cpp b/xbmc/ApplicationPlayer.cpp
index 6e689fdd60fe..f4883ef11f86 100644
--- a/xbmc/ApplicationPlayer.cpp
+++ b/xbmc/ApplicationPlayer.cpp
@@ -475,7 +475,7 @@ bool CApplicationPlayer::CanPause()
   return (player && player->CanPause());
 }
 
-TextCacheStruct_t* CApplicationPlayer::GetTeletextCache()
+std::shared_ptr<TextCacheStruct_t> CApplicationPlayer::GetTeletextCache()
 {
   std::shared_ptr<IPlayer> player = GetInternal();
   if (player)
diff --git a/xbmc/ApplicationPlayer.h b/xbmc/ApplicationPlayer.h
index b077c7c8e6be..396bea83cd81 100644
--- a/xbmc/ApplicationPlayer.h
+++ b/xbmc/ApplicationPlayer.h
@@ -101,7 +101,7 @@ class CApplicationPlayer
   int GetSubtitleCount();
   void GetSubtitleStreamInfo(int index, SubtitleStreamInfo &info);
   bool GetSubtitleVisible();
-  TextCacheStruct_t* GetTeletextCache();
+  std::shared_ptr<TextCacheStruct_t> GetTeletextCache();
   std::string GetRadioText(unsigned int line);
   int64_t GetTime() const;
   int64_t GetMinTime() const;
diff --git a/xbmc/cores/IPlayer.h b/xbmc/cores/IPlayer.h
index 80e80a0d0da4..03ea361c35c8 100644
--- a/xbmc/cores/IPlayer.h
+++ b/xbmc/cores/IPlayer.h
@@ -22,6 +22,7 @@
 
 #include <vector>
 #include <string>
+#include <memory>
 
 #include "IPlayerCallback.h"
 #include "VideoSettings.h"
@@ -152,7 +153,7 @@ class IPlayer
   virtual void SetProgram(int progId) {}
   virtual int GetProgramsCount() { return 0; }
 
-  virtual TextCacheStruct_t* GetTeletextCache() { return NULL; };
+  virtual std::shared_ptr<TextCacheStruct_t> GetTeletextCache() { return NULL; };
   virtual void LoadPage(int p, int sp, unsigned char* buffer) {};
 
   virtual std::string GetRadioText(unsigned int line) { return ""; };
diff --git a/xbmc/cores/VideoPlayer/VideoPlayer.cpp b/xbmc/cores/VideoPlayer/VideoPlayer.cpp
index bc5495daa238..92b0c90f9f84 100644
--- a/xbmc/cores/VideoPlayer/VideoPlayer.cpp
+++ b/xbmc/cores/VideoPlayer/VideoPlayer.cpp
@@ -3379,7 +3379,7 @@ void CVideoPlayer::SetSubtitleVisibleInternal(bool bVisible)
     std::static_pointer_cast<CDVDInputStreamNavigator>(m_pInputStream)->EnableSubtitleStream(bVisible);
 }
 
-TextCacheStruct_t* CVideoPlayer::GetTeletextCache()
+std::shared_ptr<TextCacheStruct_t> CVideoPlayer::GetTeletextCache()
 {
   if (m_CurrentTeletext.id < 0)
     return 0;
diff --git a/xbmc/cores/VideoPlayer/VideoPlayer.h b/xbmc/cores/VideoPlayer/VideoPlayer.h
index 6c884717af99..18afc3ec1278 100644
--- a/xbmc/cores/VideoPlayer/VideoPlayer.h
+++ b/xbmc/cores/VideoPlayer/VideoPlayer.h
@@ -340,7 +340,7 @@ class CVideoPlayer : public IPlayer, public CThread, public IVideoPlayer,
   void SetProgram(int progId) override;
   int GetProgramsCount() override;
 
-  TextCacheStruct_t* GetTeletextCache() override;
+  std::shared_ptr<TextCacheStruct_t> GetTeletextCache() override;
   void LoadPage(int p, int sp, unsigned char* buffer) override;
 
   std::string GetRadioText(unsigned int line) override;
diff --git a/xbmc/cores/VideoPlayer/VideoPlayerTeletext.h b/xbmc/cores/VideoPlayer/VideoPlayerTeletext.h
index ea92d7073b5d..11390cb33ef3 100644
--- a/xbmc/cores/VideoPlayer/VideoPlayerTeletext.h
+++ b/xbmc/cores/VideoPlayer/VideoPlayerTeletext.h
@@ -46,7 +46,7 @@ class CDVDTeletextData : public CThread, public IDVDStreamPlayer
   bool IsInited() const override { return true; }
   bool IsStalled() const override { return true; }
 
-  TextCacheStruct_t* GetTeletextCache() { return &m_TXTCache; }
+  std::shared_ptr<TextCacheStruct_t> GetTeletextCache() { return std::make_shared<TextCacheStruct_t>(m_TXTCache); }
   void LoadPage(int p, int sp, unsigned char* buffer);
 
 protected:
diff --git a/xbmc/video/Teletext.h b/xbmc/video/Teletext.h
index 3e7ff4ea1897..a8a18c8af5e4 100644
--- a/xbmc/video/Teletext.h
+++ b/xbmc/video/Teletext.h
@@ -164,6 +164,6 @@ class CTeletextDecoder
 
   int                 m_TempPage;         /* Temporary page number for number input */
   int                 m_LastPage;         /* Last selected Page */
-  TextCacheStruct_t*  m_txtCache;         /* Text cache generated by the VideoPlayer if Teletext present */
+  std::shared_ptr<TextCacheStruct_t>  m_txtCache;         /* Text cache generated by the VideoPlayer if Teletext present */
   TextRenderInfo_t    m_RenderInfo;       /* Rendering information of displayed Teletext page */
 };
