From 2abeda387655e4266cffb61ce55a53e7aa8cebd8 Mon Sep 17 00:00:00 2001
From: fritsch <Peter.Fruehberger@gmail.com>
Date: Mon, 2 Dec 2019 11:00:42 +0100
Subject: [PATCH 1/2] ProfileManager: Fall back to master profile if
 profile.xml not loadable / parseable

---
 xbmc/profiles/ProfileManager.cpp | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/xbmc/profiles/ProfileManager.cpp b/xbmc/profiles/ProfileManager.cpp
index 0428647f935c..0128682d8705 100644
--- a/xbmc/profiles/ProfileManager.cpp
+++ b/xbmc/profiles/ProfileManager.cpp
@@ -187,6 +187,15 @@ bool CProfileManager::Load()
       ret = false;
     }
   }
+  if (!ret)
+  {
+    CLog::Log(LOGERROR,
+              "Failed to load profile - might be corrupted - falling back to master profile");
+    m_profiles.clear();
+    CFile::Delete(file);
+
+    ret = true;
+  }
 
   if (m_profiles.empty())
   { // add the master user

From c99376e8d768809a2be7df2a8f305ece9e047c53 Mon Sep 17 00:00:00 2001
From: fritsch <Peter.Fruehberger@gmail.com>
Date: Mon, 2 Dec 2019 11:56:15 +0100
Subject: [PATCH 2/2] XBMCTinyXML: Properly Flush when writing xml to disk

---
 xbmc/utils/XBMCTinyXML.cpp | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/xbmc/utils/XBMCTinyXML.cpp b/xbmc/utils/XBMCTinyXML.cpp
index 05d7fba715b5..6180522df163 100644
--- a/xbmc/utils/XBMCTinyXML.cpp
+++ b/xbmc/utils/XBMCTinyXML.cpp
@@ -111,7 +111,11 @@ bool CXBMCTinyXML::SaveFile(const std::string& filename) const
   {
     TiXmlPrinter printer;
     Accept(&printer);
-    return file.Write(printer.CStr(), printer.Size()) == static_cast<ssize_t>(printer.Size());
+    bool suc = file.Write(printer.CStr(), printer.Size()) == static_cast<ssize_t>(printer.Size());
+    if (suc)
+      file.Flush();
+
+    return suc;
   }
   return false;
 }
