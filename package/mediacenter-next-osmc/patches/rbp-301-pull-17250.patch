From 32fd2205a0a4af33bd0dcdd6b75fea85977f8176 Mon Sep 17 00:00:00 2001
From: Kai Sommerfeld <kai.sommerfeld@gmx.com>
Date: Wed, 22 Jan 2020 21:33:00 +0100
Subject: [PATCH] [PVR] Channel Manager: If started via channel's context menu,
 preselect that channel on dialog open.

---
 .../dialogs/GUIDialogPVRChannelManager.cpp    | 23 +++++++++++++++++++
 xbmc/pvr/dialogs/GUIDialogPVRChannelManager.h |  3 +++
 xbmc/pvr/windows/GUIWindowPVRChannels.cpp     |  7 ++++--
 3 files changed, 31 insertions(+), 2 deletions(-)

diff --git a/xbmc/pvr/dialogs/GUIDialogPVRChannelManager.cpp b/xbmc/pvr/dialogs/GUIDialogPVRChannelManager.cpp
index 298e3ff6cda5..a6ac48b2b183 100644
--- a/xbmc/pvr/dialogs/GUIDialogPVRChannelManager.cpp
+++ b/xbmc/pvr/dialogs/GUIDialogPVRChannelManager.cpp
@@ -164,7 +164,24 @@ void CGUIDialogPVRChannelManager::OnInitWindow()
   m_bContainsChanges = false;
   m_bAllowNewChannel = false;
   SetProperty("IsRadio", "");
+
   Update();
+
+  if (m_initialSelection)
+  {
+    // set initial selection
+    const std::shared_ptr<CPVRChannel> channel = m_initialSelection->GetPVRChannelInfoTag();
+    for (int i = 0; i < m_channelItems->Size(); ++i)
+    {
+      if (m_channelItems->Get(i)->GetPVRChannelInfoTag() == channel)
+      {
+        m_iSelected = i;
+        m_viewControl.SetSelectedItem(m_iSelected);
+        break;
+      }
+    }
+    m_initialSelection.reset();
+  }
   SetData(m_iSelected);
 }
 
@@ -175,6 +192,12 @@ void CGUIDialogPVRChannelManager::OnDeinitWindow(int nextWindowID)
   CGUIDialog::OnDeinitWindow(nextWindowID);
 }
 
+void CGUIDialogPVRChannelManager::Open(const std::shared_ptr<CFileItem>& initialSelection)
+{
+  m_initialSelection = initialSelection;
+  CGUIDialog::Open();
+}
+
 bool CGUIDialogPVRChannelManager::OnClickListChannels(CGUIMessage& message)
 {
   if (!m_bMovingMode)
diff --git a/xbmc/pvr/dialogs/GUIDialogPVRChannelManager.h b/xbmc/pvr/dialogs/GUIDialogPVRChannelManager.h
index 5aeee9a5de38..1abe2dd9b471 100644
--- a/xbmc/pvr/dialogs/GUIDialogPVRChannelManager.h
+++ b/xbmc/pvr/dialogs/GUIDialogPVRChannelManager.h
@@ -36,6 +36,8 @@ namespace PVR
     bool HasListItems() const override{ return true; }
     CFileItemPtr GetCurrentListItem(int offset = 0) override;
 
+    void Open(const std::shared_ptr<CFileItem>& initialSelection);
+
   protected:
     void OnInitWindow() override;
     void OnDeinitWindow(int nextWindowID) override;
@@ -74,6 +76,7 @@ namespace PVR
     bool m_bContainsChanges = false;
     bool m_bAllowNewChannel = false;
 
+    std::shared_ptr<CFileItem> m_initialSelection;
     int m_iSelected = 0;
     CFileItemList* m_channelItems;
     CGUIViewControl m_viewControl;
diff --git a/xbmc/pvr/windows/GUIWindowPVRChannels.cpp b/xbmc/pvr/windows/GUIWindowPVRChannels.cpp
index 873a84b97dfc..7b9079950ec7 100644
--- a/xbmc/pvr/windows/GUIWindowPVRChannels.cpp
+++ b/xbmc/pvr/windows/GUIWindowPVRChannels.cpp
@@ -304,8 +304,11 @@ void CGUIWindowPVRChannelsBase::UpdateEpg(const CFileItemPtr& item)
 void CGUIWindowPVRChannelsBase::ShowChannelManager()
 {
   CGUIDialogPVRChannelManager* dialog = CServiceBroker::GetGUI()->GetWindowManager().GetWindow<CGUIDialogPVRChannelManager>(WINDOW_DIALOG_PVR_CHANNEL_MANAGER);
-  if (dialog)
-    dialog->Open();
+  if (!dialog)
+    return;
+
+  const int iItem = m_viewControl.GetSelectedItem();
+  dialog->Open(iItem >= 0 && iItem < m_vecItems->Size() ? m_vecItems->Get(iItem) : nullptr);
 }
 
 void CGUIWindowPVRChannelsBase::ShowGroupManager()
