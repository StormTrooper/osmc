From 42cc61df189381549b31a0006c6ef37411ea1f62 Mon Sep 17 00:00:00 2001
From: Jakob Linskeseder <jakob.linskeseder@gmail.com>
Date: Fri, 24 Apr 2020 18:36:16 +0200
Subject: [PATCH] Add AV1 video-codec flag to skins

Support for AV1 was added in #16933.

Kodi currently gets FFmpeg decoder names as codec
names. This is problematic with AV1 since FFmpeg
returns either "libdav1d" or "libaom-av1" as codec
(decoder) name:
* https://github.com/FFmpeg/FFmpeg/blob/n4.2.2/libavcodec/libdav1d.c#L355-L356
* https://github.com/FFmpeg/FFmpeg/blob/n4.2.2/libavcodec/libaomdec.c#L222-L223

In order to make things simpler for skins, the
FFmpeg helper function `avcodec_get_name()` is
now used, which returns the actual codec name.
---
 addons/skin.estouchy/media/flagging/video/av1.png | Bin 0 -> 723 bytes
 .../skin.estuary/media/flags/videocodec/av1.png   | Bin 0 -> 723 bytes
 xbmc/GUIInfoManager.cpp                           |   1 +
 .../VideoPlayer/DVDDemuxers/DVDDemuxFFmpeg.cpp    |   2 +-
 4 files changed, 2 insertions(+), 1 deletion(-)
 create mode 100644 addons/skin.estouchy/media/flagging/video/av1.png
 create mode 100644 addons/skin.estuary/media/flags/videocodec/av1.png

diff --git a/addons/skin.estouchy/media/flagging/video/av1.png b/addons/skin.estouchy/media/flagging/video/av1.png
new file mode 100644
index 0000000000000000000000000000000000000000..fb6c95f551839f5a8d4bf68358ace7c3140e6e92
GIT binary patch
literal 723
zcmeAS@N?(olHy`uVBq!ia0y~yVB`a`D_EF;<j2X3|A3T1fKP}kkp52!u=Zs!0P5i{
z3GxeODBmsU^6u`LnX8o2j5|UDOQx-5U|@3gba4#Hxc7FJZ;-H~goC?+g!2NUrP&|Z
z4!0G}yu+~C#-XS=;3?xVX#?|y-s~NYF*}b+Pmm4>3=q1Qe%to$<=Cf8Vl{uBRIk?G
z`!d{E-!^z<O4lL{5c>4sfn6Z~*NPgsn|~L`y;=xHi2?m0Up)f*|8L~AwO(_WegBTA
zPmATw&*-e^Nla-^H?huZ+1cB3T&m#VI>tX=R%>r42v&S@k?mQYO^f5+Dz2%r_mrMo
zJia0Mxa|*#MG3Pct(Hz{KWW1CwRW%78sooBQ`|WNSM0y!v)fsdfAUKmKGU-$=hsY8
zlFOCo-B~2h_h7SZ-@>9vA*~(9^}cLd9I*da#<F+Y{+vs(Q7b5sY5k>l^2;1y#r{e8
zH@R>4JKgQNHRa=rf43`Fb6$;*?787|E&1}j&P0({fpb@`IlfN!bI)mktn;Z>6TZ&4
zk^f3_&XI+EzRNbrwc73sTNLnr$7bJai(i-BX~>p;b!T4g{Zw1CyOVRT&Iu1(QM)3=
zHtOr-e+qn8)3jb29=zOQb;@h<$~Eqe4|@5(9!k@Cb@8CEldRG9nO>DG=3nkOiM&z=
zX-PcptY<8r#mF4lUp(X5Wd5&~2}Yt{GS)RMyxNjA<78EdkLcOPZ66lS@@ci1<+FY<
zvt5gq>g$bszw7iC2S}PMGYv0)c5zQ`i}_=#5Ri3@)^+dP7oKae{q!ev#`RBoo;#iW
zJpE$U+1F2h+Ira9yqdU3P7^_#eq881@6Z3Gc|BE2beh{Ck-W%;=O5FaCfgH1zqfY-
PQyPP(tDnm{r-UW|2a#-A

literal 0
HcmV?d00001

diff --git a/addons/skin.estuary/media/flags/videocodec/av1.png b/addons/skin.estuary/media/flags/videocodec/av1.png
new file mode 100644
index 0000000000000000000000000000000000000000..fb6c95f551839f5a8d4bf68358ace7c3140e6e92
GIT binary patch
literal 723
zcmeAS@N?(olHy`uVBq!ia0y~yVB`a`D_EF;<j2X3|A3T1fKP}kkp52!u=Zs!0P5i{
z3GxeODBmsU^6u`LnX8o2j5|UDOQx-5U|@3gba4#Hxc7FJZ;-H~goC?+g!2NUrP&|Z
z4!0G}yu+~C#-XS=;3?xVX#?|y-s~NYF*}b+Pmm4>3=q1Qe%to$<=Cf8Vl{uBRIk?G
z`!d{E-!^z<O4lL{5c>4sfn6Z~*NPgsn|~L`y;=xHi2?m0Up)f*|8L~AwO(_WegBTA
zPmATw&*-e^Nla-^H?huZ+1cB3T&m#VI>tX=R%>r42v&S@k?mQYO^f5+Dz2%r_mrMo
zJia0Mxa|*#MG3Pct(Hz{KWW1CwRW%78sooBQ`|WNSM0y!v)fsdfAUKmKGU-$=hsY8
zlFOCo-B~2h_h7SZ-@>9vA*~(9^}cLd9I*da#<F+Y{+vs(Q7b5sY5k>l^2;1y#r{e8
zH@R>4JKgQNHRa=rf43`Fb6$;*?787|E&1}j&P0({fpb@`IlfN!bI)mktn;Z>6TZ&4
zk^f3_&XI+EzRNbrwc73sTNLnr$7bJai(i-BX~>p;b!T4g{Zw1CyOVRT&Iu1(QM)3=
zHtOr-e+qn8)3jb29=zOQb;@h<$~Eqe4|@5(9!k@Cb@8CEldRG9nO>DG=3nkOiM&z=
zX-PcptY<8r#mF4lUp(X5Wd5&~2}Yt{GS)RMyxNjA<78EdkLcOPZ66lS@@ci1<+FY<
zvt5gq>g$bszw7iC2S}PMGYv0)c5zQ`i}_=#5Ri3@)^+dP7oKae{q!ev#`RBoo;#iW
zJpE$U+1F2h+Ira9yqdU3P7^_#eq881@6Z3Gc|BE2beh{Ck-W%;=O5FaCfgH1zqfY-
PQyPP(tDnm{r-UW|2a#-A

literal 0
HcmV?d00001

diff --git a/xbmc/GUIInfoManager.cpp b/xbmc/GUIInfoManager.cpp
index 6e4a150df012..e9dde6334787 100644
--- a/xbmc/GUIInfoManager.cpp
+++ b/xbmc/GUIInfoManager.cpp
@@ -5545,6 +5545,7 @@ const infomap container_str[]  = {{ "property",         CONTAINER_PROPERTY },
 ///                  _string_,
 ///     @return The video codec of the currently selected video. Common values:
 ///      - <b>3iv2</b>
+///      - <b>av1</b>
 ///      - <b>avc1</b>
 ///      - <b>div2</b>
 ///      - <b>div3</b>
diff --git a/xbmc/cores/VideoPlayer/DVDDemuxers/DVDDemuxFFmpeg.cpp b/xbmc/cores/VideoPlayer/DVDDemuxers/DVDDemuxFFmpeg.cpp
index a2a1b9e23f03..16a2c634736a 100644
--- a/xbmc/cores/VideoPlayer/DVDDemuxers/DVDDemuxFFmpeg.cpp
+++ b/xbmc/cores/VideoPlayer/DVDDemuxers/DVDDemuxFFmpeg.cpp
@@ -1964,7 +1964,7 @@ std::string CDVDDemuxFFmpeg::GetStreamCodecName(int iStreamId)
 
     AVCodec* codec = avcodec_find_decoder(stream->codec);
     if (codec)
-      strName = codec->name;
+      strName = avcodec_get_name(codec->id);
   }
   return strName;
 }
