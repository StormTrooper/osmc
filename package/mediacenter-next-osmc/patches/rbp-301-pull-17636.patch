From 4b76dd57b8e66e3d2d70ecb703355dbe0ed897a2 Mon Sep 17 00:00:00 2001
From: Jonas Karlman <jonas@kwiboo.se>
Date: Sun, 20 Oct 2019 14:46:04 +0000
Subject: [PATCH] VideoBufferDRMPRIME: rename Map and Unmap

---
 xbmc/cores/VideoPlayer/Buffers/VideoBufferDRMPRIME.h   |  4 ++--
 .../VideoRenderers/HwDecRender/DRMPRIMEEGL.cpp         | 10 ++++++++--
 .../HwDecRender/VideoLayerBridgeDRMPRIME.cpp           |  8 ++++++--
 3 files changed, 16 insertions(+), 6 deletions(-)

diff --git a/xbmc/cores/VideoPlayer/Buffers/VideoBufferDRMPRIME.h b/xbmc/cores/VideoPlayer/Buffers/VideoBufferDRMPRIME.h
index a0e5273b489f..0afd7ff3f161 100644
--- a/xbmc/cores/VideoPlayer/Buffers/VideoBufferDRMPRIME.h
+++ b/xbmc/cores/VideoPlayer/Buffers/VideoBufferDRMPRIME.h
@@ -68,8 +68,8 @@ class CVideoBufferDRMPRIME : public CVideoBuffer
 
   virtual AVDRMFrameDescriptor* GetDescriptor() const = 0;
   virtual bool IsValid() const { return true; }
-  virtual bool Map() { return true; }
-  virtual void Unmap() {}
+  virtual bool AcquireDescriptor() { return true; }
+  virtual void ReleaseDescriptor() {}
 
   uint32_t m_fb_id = 0;
   uint32_t m_handles[AV_DRM_MAX_PLANES] = {};
diff --git a/xbmc/cores/VideoPlayer/VideoRenderers/HwDecRender/DRMPRIMEEGL.cpp b/xbmc/cores/VideoPlayer/VideoRenderers/HwDecRender/DRMPRIMEEGL.cpp
index 1dd75952bbf8..af3dd89f6a3f 100644
--- a/xbmc/cores/VideoPlayer/VideoRenderers/HwDecRender/DRMPRIMEEGL.cpp
+++ b/xbmc/cores/VideoPlayer/VideoRenderers/HwDecRender/DRMPRIMEEGL.cpp
@@ -22,8 +22,11 @@ bool CDRMPRIMETexture::Map(CVideoBufferDRMPRIME* buffer)
   if (m_primebuffer)
     return true;
 
-  if (!buffer->Map())
+  if (!buffer->AcquireDescriptor())
+  {
+    CLog::Log(LOGERROR, "CDRMPRIMETexture::{} - failed to acquire descriptor", __FUNCTION__);
     return false;
+  }
 
   m_texWidth = buffer->GetWidth();
   m_texHeight = buffer->GetHeight();
@@ -52,7 +55,10 @@ bool CDRMPRIMETexture::Map(CVideoBufferDRMPRIME* buffer)
     attribs.planes = planes;
 
     if (!m_eglImage->CreateImage(attribs))
+    {
+      buffer->ReleaseDescriptor();
       return false;
+    }
 
     glGenTextures(1, &m_texture);
     glBindTexture(m_textureTarget, m_texture);
@@ -79,7 +85,7 @@ void CDRMPRIMETexture::Unmap()
 
   glDeleteTextures(1, &m_texture);
 
-  m_primebuffer->Unmap();
+  m_primebuffer->ReleaseDescriptor();
 
   m_primebuffer->Release();
   m_primebuffer = nullptr;
diff --git a/xbmc/cores/VideoPlayer/VideoRenderers/HwDecRender/VideoLayerBridgeDRMPRIME.cpp b/xbmc/cores/VideoPlayer/VideoRenderers/HwDecRender/VideoLayerBridgeDRMPRIME.cpp
index 44801880f4e3..72b584b19d04 100644
--- a/xbmc/cores/VideoPlayer/VideoRenderers/HwDecRender/VideoLayerBridgeDRMPRIME.cpp
+++ b/xbmc/cores/VideoPlayer/VideoRenderers/HwDecRender/VideoLayerBridgeDRMPRIME.cpp
@@ -72,8 +72,12 @@ bool CVideoLayerBridgeDRMPRIME::Map(CVideoBufferDRMPRIME* buffer)
   if (buffer->m_fb_id)
     return true;
 
-  if (!buffer->Map())
+  if (!buffer->AcquireDescriptor())
+  {
+    CLog::Log(LOGERROR, "CVideoLayerBridgeDRMPRIME::{} - failed to acquire descriptor",
+              __FUNCTION__);
     return false;
+  }
 
   AVDRMFrameDescriptor* descriptor = buffer->GetDescriptor();
   uint32_t handles[4] = {0}, pitches[4] = {0}, offsets[4] = {0}, flags = 0;
@@ -146,7 +150,7 @@ void CVideoLayerBridgeDRMPRIME::Unmap(CVideoBufferDRMPRIME* buffer)
     }
   }
 
-  buffer->Unmap();
+  buffer->ReleaseDescriptor();
 }
 
 void CVideoLayerBridgeDRMPRIME::Configure(CVideoBufferDRMPRIME* buffer)
