From ea4dd20b045577d98a1498d278273c170ec93a0d Mon Sep 17 00:00:00 2001
From: Rainer Hochecker <fernetmenta@online.de>
Date: Thu, 12 Jul 2018 12:36:42 +0200
Subject: [PATCH] AE: fix sync for transcoding

---
 xbmc/cores/AudioEngine/Engines/ActiveAE/ActiveAE.cpp | 20 ++++++++++++--------
 1 file changed, 12 insertions(+), 8 deletions(-)

diff --git a/xbmc/cores/AudioEngine/Engines/ActiveAE/ActiveAE.cpp b/xbmc/cores/AudioEngine/Engines/ActiveAE/ActiveAE.cpp
index e980dbc57335..5bd51ed42440 100644
--- a/xbmc/cores/AudioEngine/Engines/ActiveAE/ActiveAE.cpp
+++ b/xbmc/cores/AudioEngine/Engines/ActiveAE/ActiveAE.cpp
@@ -2171,10 +2171,10 @@ bool CActiveAE::RunStages()
       }// for
 
       // finally clamp samples
-      if(out && needClamp)
+      if (out && needClamp)
       {
         int nb_floats = out->pkt->nb_samples * out->pkt->config.channels / out->pkt->planes;
-        for(int i=0; i<out->pkt->planes; i++)
+        for (int i=0; i<out->pkt->planes; i++)
         {
           CAEUtil::ClampArray((float*)out->pkt->data[i], nb_floats);
         }
@@ -2242,13 +2242,17 @@ bool CActiveAE::RunStages()
 
         if (m_mode == MODE_TRANSCODE && m_encoder)
         {
-          CSampleBuffer *buf = m_encoderBuffers->GetFreeBuffer();
-          buf->pkt->nb_samples = m_encoder->Encode(out->pkt->data[0], out->pkt->planes*out->pkt->linesize,
-                                                   buf->pkt->data[0], buf->pkt->planes*buf->pkt->linesize);
+          CSampleBuffer *buf = nullptr;
+          if (out->pkt->nb_samples)
+          {
+            buf = m_encoderBuffers->GetFreeBuffer();
+            buf->pkt->nb_samples = m_encoder->Encode(out->pkt->data[0], out->pkt->planes*out->pkt->linesize,
+                                                     buf->pkt->data[0], buf->pkt->planes*buf->pkt->linesize);
 
-          // set pts of last sample
-          buf->pkt_start_offset = buf->pkt->nb_samples;
-          buf->timestamp = out->timestamp;
+            // set pts of last sample
+            buf->pkt_start_offset = buf->pkt->nb_samples;
+            buf->timestamp = out->timestamp;
+          }
 
           out->Return();
           out = buf;
