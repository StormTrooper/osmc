From d0a6df7de1a9f722ef9f1120c63650b1382f4484 Mon Sep 17 00:00:00 2001
From: Rainer Hochecker <fernetmenta@online.de>
Date: Wed, 18 Jul 2018 12:33:42 +0200
Subject: [PATCH] VideoPlayer: vaapi - fix copy path

---
 .../VideoRenderers/HwDecRender/RendererVAAPIGL.cpp     | 18 +++++++++++-------
 1 file changed, 11 insertions(+), 7 deletions(-)

diff --git a/xbmc/cores/VideoPlayer/VideoRenderers/HwDecRender/RendererVAAPIGL.cpp b/xbmc/cores/VideoPlayer/VideoRenderers/HwDecRender/RendererVAAPIGL.cpp
index 5785f6a3e320..aaeac410e13f 100644
--- a/xbmc/cores/VideoPlayer/VideoRenderers/HwDecRender/RendererVAAPIGL.cpp
+++ b/xbmc/cores/VideoPlayer/VideoRenderers/HwDecRender/RendererVAAPIGL.cpp
@@ -208,13 +208,17 @@ bool CRendererVAAPI::UploadTexture(int index)
 
   if (!m_isVAAPIBuffer)
   {
-    YuvImage &dst = m_buffers[index].image;
-    YuvImage src;
-    pic->GetPlanes(src.plane);
-    pic->GetStrides(src.stride);
-    UnBindPbo(m_buffers[index]);
-    CVideoBuffer::CopyNV12Picture(&dst, &src);
-    BindPbo(m_buffers[index]);
+    if (!m_buffers[index].loaded)
+    {
+      YuvImage &dst = m_buffers[index].image;
+      YuvImage src;
+      pic->GetPlanes(src.plane);
+      pic->GetStrides(src.stride);
+      UnBindPbo(m_buffers[index]);
+      CVideoBuffer::CopyNV12Picture(&dst, &src);
+      BindPbo(m_buffers[index]);
+    }
+    CalculateTextureSourceRects(index, 3);
     return UploadNV12Texture(index);
   }
 
