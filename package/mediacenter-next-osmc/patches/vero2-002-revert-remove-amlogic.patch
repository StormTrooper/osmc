From d4d9d1384168e997c9e3e3e88f7ce57432e97d98 Mon Sep 17 00:00:00 2001
From: Greg McCarthy <greg@gjmccarthy.co.uk>
Date: Thu, 6 Jun 2019 19:13:59 +0100
Subject: [PATCH] Revert "RPProcessInfo: drop method ConfigureRenderSystem"

This reverts commit f56348255e5012e3df799b3a2c13e0d765f2c990.
---
 xbmc/cores/RetroPlayer/process/RPProcessInfo.h       | 8 ++++++++
 xbmc/cores/RetroPlayer/rendering/RPRenderManager.cpp | 5 +++++
 2 files changed, 13 insertions(+)

diff --git a/xbmc/cores/RetroPlayer/process/RPProcessInfo.h b/xbmc/cores/RetroPlayer/process/RPProcessInfo.h
index 997f7628f9..089fcfb38c 100644
--- a/xbmc/cores/RetroPlayer/process/RPProcessInfo.h
+++ b/xbmc/cores/RetroPlayer/process/RPProcessInfo.h
@@ -139,6 +139,14 @@ namespace RETRO
      */
     SCALINGMETHOD GetDefaultScalingMethod() const { return m_defaultScalingMethod; }
 
+    /*!
+     * \brief Configure the render system
+     *
+     * \param format The pixel format of the video stream, or AV_PIX_FMT_NONE
+     *        if the stream has ended
+     */
+    virtual void ConfigureRenderSystem(AVPixelFormat format) { }
+
     ///}
 
     /// @name Player video info
diff --git a/xbmc/cores/RetroPlayer/rendering/RPRenderManager.cpp b/xbmc/cores/RetroPlayer/rendering/RPRenderManager.cpp
index 46a39b9bf0..873d6fd1f2 100644
--- a/xbmc/cores/RetroPlayer/rendering/RPRenderManager.cpp
+++ b/xbmc/cores/RetroPlayer/rendering/RPRenderManager.cpp
@@ -50,6 +50,9 @@ void CRPRenderManager::Deinitialize()
 {
   CLog::Log(LOGDEBUG, "RetroPlayer[RENDER]: Deinitializing render manager");
 
+  // Required to reset Amlogic chip to default state
+  m_processInfo.ConfigureRenderSystem(AV_PIX_FMT_NONE);
+
   for (auto &pixelScaler : m_scalers)
   {
     if (pixelScaler.second != nullptr)
@@ -226,6 +229,8 @@ void CRPRenderManager::FrameMove()
 
     if (m_state == RENDER_STATE::CONFIGURING)
     {
+      m_processInfo.ConfigureRenderSystem(m_format);
+
       m_state = RENDER_STATE::CONFIGURED;
 
       CLog::Log(LOGINFO, "RetroPlayer[RENDER]: Renderer configured on first frame");
-- 
2.16.4

