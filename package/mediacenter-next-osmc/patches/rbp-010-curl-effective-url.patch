From 2df7494c4d9c444adad570f337e712e0783f70b0 Mon Sep 17 00:00:00 2001
From: peak3d <pfau@peak3d.de>
Date: Thu, 23 Nov 2017 21:51:50 +0100
Subject: [PATCH] [CURL] Implement FILE_PROPERTY_EFFECTIVE_URL retrieval

---
 xbmc/addons/kodi-addon-dev-kit/include/kodi/Filesystem.h | 4 +++-
 xbmc/filesystem/CurlFile.cpp                             | 6 ++++++
 xbmc/filesystem/IFileTypes.h                             | 3 ++-
 3 files changed, 11 insertions(+), 2 deletions(-)

diff --git a/xbmc/addons/kodi-addon-dev-kit/include/kodi/Filesystem.h b/xbmc/addons/kodi-addon-dev-kit/include/kodi/Filesystem.h
index 985ff685c5ff..b089da3bda8e 100644
--- a/xbmc/addons/kodi-addon-dev-kit/include/kodi/Filesystem.h
+++ b/xbmc/addons/kodi-addon-dev-kit/include/kodi/Filesystem.h
@@ -241,7 +241,9 @@ typedef enum FilePropertyTypes
   /// Get file content charset
   ADDON_FILE_PROPERTY_CONTENT_CHARSET,
   /// Get file mime type
-  ADDON_FILE_PROPERTY_MIME_TYPE
+  ADDON_FILE_PROPERTY_MIME_TYPE,
+  /// Get file effective URL (last one if redirected)
+  ADDON_FILE_PROPERTY_EFFECTIVE_URL
 } FilePropertyTypes;
 //------------------------------------------------------------------------------
 
diff --git a/xbmc/filesystem/CurlFile.cpp b/xbmc/filesystem/CurlFile.cpp
index c29bbb49e2a1..0366a232e28e 100644
--- a/xbmc/filesystem/CurlFile.cpp
+++ b/xbmc/filesystem/CurlFile.cpp
@@ -1931,6 +1931,12 @@ const std::string CCurlFile::GetProperty(XFILE::FileProperty type, const std::st
     return m_state->m_httpheader.GetCharset();
   case FILE_PROPERTY_MIME_TYPE:
     return m_state->m_httpheader.GetMimeType();
+  case FILE_PROPERTY_EFFECTIVE_URL:
+  {
+    char *url = nullptr;
+    g_curlInterface.easy_getinfo(m_state->m_easyHandle, CURLINFO_EFFECTIVE_URL, &url);
+    return url ? url : "";
+  }
   default:
     return "";
   }
diff --git a/xbmc/filesystem/IFileTypes.h b/xbmc/filesystem/IFileTypes.h
index 8e8f12a2a3a3..a65a178e94e9 100644
--- a/xbmc/filesystem/IFileTypes.h
+++ b/xbmc/filesystem/IFileTypes.h
@@ -107,7 +107,8 @@ enum FileProperty
   FILE_PROPERTY_RESPONSE_HEADER,            /**< Get response Header value  */
   FILE_PROPERTY_CONTENT_TYPE,               /**< Get file content-type  */
   FILE_PROPERTY_CONTENT_CHARSET,            /**< Get file content charset  */
-  FILE_PROPERTY_MIME_TYPE                   /**< Get file mime type  */
+  FILE_PROPERTY_MIME_TYPE,                  /**< Get file mime type  */
+  FILE_PROPERTY_EFFECTIVE_URL               /**< Get effective URL for redirected streams  */
 };
 
 }
