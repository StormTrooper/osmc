From 2a82e5067f0660855bcf9d490bc6569cee25d06f Mon Sep 17 00:00:00 2001
From: Greg McCarthy <greg@gjmccarthy.co.uk>
Date: Fri, 25 Dec 2020 17:02:33 +0000
Subject: [PATCH] Revert "[cmake] only use APP_RENDER_SYSTEM"

This reverts commit d159837cf736c9ba17772ba52e4ce95aa3625528.
---
 cmake/platform/freebsd/x11.cmake    |  1 +
 cmake/platform/linux/gbm.cmake      | 10 ++++++++--
 cmake/platform/linux/wayland.cmake  | 10 ++++++++--
 cmake/platform/linux/x11.cmake      | 10 ++++++++--
 cmake/scripts/common/Platform.cmake | 10 +++-------
 5 files changed, 28 insertions(+), 13 deletions(-)

diff --git a/cmake/platform/freebsd/x11.cmake b/cmake/platform/freebsd/x11.cmake
index 307dac37de..f4e5b6deb0 100644
--- a/cmake/platform/freebsd/x11.cmake
+++ b/cmake/platform/freebsd/x11.cmake
@@ -1,2 +1,3 @@
 list(APPEND PLATFORM_REQUIRED_DEPS OpenGl EGL X XRandR LibDRM)
 list(APPEND PLATFORM_OPTIONAL_DEPS VAAPI VDPAU GLX)
+set(APP_RENDER_SYSTEM gl)
diff --git a/cmake/platform/linux/gbm.cmake b/cmake/platform/linux/gbm.cmake
index 8f17ef672d..dfbe2525ee 100644
--- a/cmake/platform/linux/gbm.cmake
+++ b/cmake/platform/linux/gbm.cmake
@@ -1,8 +1,14 @@
 list(APPEND PLATFORM_REQUIRED_DEPS EGL GBM LibDRM LibInput Xkbcommon)
 list(APPEND PLATFORM_OPTIONAL_DEPS VAAPI)
 
-if(APP_RENDER_SYSTEM STREQUAL "gl")
+set(GBM_RENDER_SYSTEM "" CACHE STRING "Render system to use with GBM: \"gl\" or \"gles\"")
+
+if(GBM_RENDER_SYSTEM STREQUAL "gl")
   list(APPEND PLATFORM_REQUIRED_DEPS OpenGl)
-elseif(APP_RENDER_SYSTEM STREQUAL "gles")
+  set(APP_RENDER_SYSTEM gl)
+elseif(GBM_RENDER_SYSTEM STREQUAL "gles")
   list(APPEND PLATFORM_REQUIRED_DEPS OpenGLES)
+  set(APP_RENDER_SYSTEM gles)
+else()
+  message(SEND_ERROR "You need to decide whether you want to use GL- or GLES-based rendering in combination with the GBM windowing system. Please set GBM_RENDER_SYSTEM to either \"gl\" or \"gles\". For normal desktop systems, you will usually want to use \"gl\".")
 endif()
diff --git a/cmake/platform/linux/wayland.cmake b/cmake/platform/linux/wayland.cmake
index 1adcd8fe77..66dd736299 100644
--- a/cmake/platform/linux/wayland.cmake
+++ b/cmake/platform/linux/wayland.cmake
@@ -1,10 +1,16 @@
 list(APPEND PLATFORM_REQUIRED_DEPS WaylandProtocols>=1.7 Waylandpp>=0.2.2 LibDRM Xkbcommon>=0.4.1)
 list(APPEND PLATFORM_OPTIONAL_DEPS VAAPI)
 
-if(APP_RENDER_SYSTEM STREQUAL "gl")
+set(WAYLAND_RENDER_SYSTEM "" CACHE STRING "Render system to use with Wayland: \"gl\" or \"gles\"")
+
+if(WAYLAND_RENDER_SYSTEM STREQUAL "gl")
   list(APPEND PLATFORM_REQUIRED_DEPS OpenGl EGL)
-elseif(APP_RENDER_SYSTEM STREQUAL "gles")
+  set(APP_RENDER_SYSTEM gl)
+elseif(WAYLAND_RENDER_SYSTEM STREQUAL "gles")
   list(APPEND PLATFORM_REQUIRED_DEPS OpenGLES EGL)
+  set(APP_RENDER_SYSTEM gles)
+else()
+  message(SEND_ERROR "You need to decide whether you want to use GL- or GLES-based rendering in combination with the Wayland windowing system. Please set WAYLAND_RENDER_SYSTEM to either \"gl\" or \"gles\". For normal desktop systems, you will usually want to use \"gl\".")
 endif()
 
 set(PLATFORM_GLOBAL_TARGET_DEPS generate-wayland-extra-protocols)
diff --git a/cmake/platform/linux/x11.cmake b/cmake/platform/linux/x11.cmake
index 5f5b8c2f99..1378bbd5b4 100644
--- a/cmake/platform/linux/x11.cmake
+++ b/cmake/platform/linux/x11.cmake
@@ -1,9 +1,15 @@
 list(APPEND PLATFORM_REQUIRED_DEPS EGL X XRandR LibDRM)
 list(APPEND PLATFORM_OPTIONAL_DEPS VAAPI)
 
-if(APP_RENDER_SYSTEM STREQUAL "gl")
+set(X11_RENDER_SYSTEM "" CACHE STRING "Render system to use with X11: \"gl\" or \"gles\"")
+
+if(X11_RENDER_SYSTEM STREQUAL "gl")
   list(APPEND PLATFORM_REQUIRED_DEPS OpenGl)
   list(APPEND PLATFORM_OPTIONAL_DEPS GLX VDPAU)
-elseif(APP_RENDER_SYSTEM STREQUAL "gles")
+  set(APP_RENDER_SYSTEM gl)
+elseif(X11_RENDER_SYSTEM STREQUAL "gles")
   list(APPEND PLATFORM_REQUIRED_DEPS OpenGLES)
+  set(APP_RENDER_SYSTEM gles)
+else()
+  message(SEND_ERROR "You need to decide whether you want to use GL- or GLES-based rendering in combination with the X11 windowing system. Please set X11_RENDER_SYSTEM to either \"gl\" or \"gles\". For normal desktop systems, you will usually want to use \"gl\".")
 endif()
diff --git a/cmake/scripts/common/Platform.cmake b/cmake/scripts/common/Platform.cmake
index b389745d40..d3e0892149 100644
--- a/cmake/scripts/common/Platform.cmake
+++ b/cmake/scripts/common/Platform.cmake
@@ -3,13 +3,10 @@ if(NOT CORE_SYSTEM_NAME)
 endif()
 
 if(CORE_SYSTEM_NAME STREQUAL linux OR CORE_SYSTEM_NAME STREQUAL freebsd)
-  # Set default CORE_PLATFORM_NAME to X11 WAYLAND GBM
+  # Set default CORE_PLATFORM_NAME to X11
   # This is overridden by user setting -DCORE_PLATFORM_NAME=<platform>
-  set(_DEFAULT_PLATFORM X11 WAYLAND GBM)
-
-  if(NOT APP_RENDER_SYSTEM)
-    message(SEND_ERROR "You need to decide whether you want to use GL- or GLES-based rendering. Please set APP_RENDER_SYSTEM to either \"gl\" or \"gles\". For normal desktop systems, you will usually want to use \"gl\".")
-  endif()
+  set(_DEFAULT_PLATFORM X11)
+  option(ENABLE_APP_AUTONAME    "Enable renaming the binary according to windowing?" ON)
 else()
   string(TOLOWER ${CORE_SYSTEM_NAME} _DEFAULT_PLATFORM)
 endif()
@@ -37,7 +34,6 @@ list(APPEND final_message "Platforms: ${CORE_PLATFORM_STRING}")
 if(CORE_SYSTEM_NAME STREQUAL linux OR CORE_SYSTEM_NAME STREQUAL freebsd) 
   list(LENGTH CORE_PLATFORM_NAME_LC PLATFORM_COUNT)
   if(PLATFORM_COUNT EQUAL 1)
-  option(ENABLE_APP_AUTONAME "Enable renaming the binary according to windowing?" ON)
   if(ENABLE_APP_AUTONAME)
     set(APP_BINARY_SUFFIX "-${CORE_PLATFORM_NAME_LC}")
   endif()
-- 
2.26.2

