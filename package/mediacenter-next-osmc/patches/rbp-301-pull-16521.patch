From f8a083bfb2b8026cac1071c5cfbc0f129ca78c55 Mon Sep 17 00:00:00 2001
From: arucard21 <arucard21@gmail.com>
Date: Thu, 22 Aug 2019 11:14:02 +0200
Subject: [PATCH] Override joystick controls per-keyname (fixes userdata config
 override)

---
 xbmc/input/JoystickMapper.cpp | 18 +++++++++---------
 xbmc/input/WindowKeymap.cpp   |  8 ++++++++
 2 files changed, 17 insertions(+), 9 deletions(-)

diff --git a/xbmc/input/JoystickMapper.cpp b/xbmc/input/JoystickMapper.cpp
index bcee4d30c5e4..b5d3fdd619f4 100644
--- a/xbmc/input/JoystickMapper.cpp
+++ b/xbmc/input/JoystickMapper.cpp
@@ -38,6 +38,15 @@ void CJoystickMapper::MapActions(int windowID, const TiXmlNode *pDevice)
   if (controllerId.empty())
     return;
 
+  // Update Controller IDs
+  if (std::find(m_controllerIds.begin(), m_controllerIds.end(), controllerId) == m_controllerIds.end())
+    m_controllerIds.emplace_back(controllerId);
+
+  // Create/overwrite keymap
+  auto& keymap = m_joystickKeymaps[controllerId];
+  if (!keymap)
+    keymap.reset(new CWindowKeymap(controllerId));
+
   const TiXmlElement *pButton = pDevice->FirstChildElement();
   while (pButton != nullptr)
   {
@@ -48,15 +57,6 @@ void CJoystickMapper::MapActions(int windowID, const TiXmlNode *pDevice)
     std::string actionString;
     if (DeserializeButton(pButton, feature, dir, holdtimeMs, hotkeys, actionString))
     {
-      // Update Controller IDs
-      if (std::find(m_controllerIds.begin(), m_controllerIds.end(), controllerId) == m_controllerIds.end())
-        m_controllerIds.emplace_back(controllerId);
-
-      // Find/create keymap
-      auto &keymap = m_joystickKeymaps[controllerId];
-      if (!keymap)
-        keymap.reset(new CWindowKeymap(controllerId));
-
       // Update keymap
       unsigned int actionId = ACTION_NONE;
       if (CActionTranslator::TranslateString(actionString, actionId))
diff --git a/xbmc/input/WindowKeymap.cpp b/xbmc/input/WindowKeymap.cpp
index 1068895657ed..3250a5eb68b9 100644
--- a/xbmc/input/WindowKeymap.cpp
+++ b/xbmc/input/WindowKeymap.cpp
@@ -22,6 +22,14 @@ void CWindowKeymap::MapAction(int windowId, const std::string &keyName, JOYSTICK
   auto &actionGroup = m_windowKeymap[windowId][keyName];
 
   actionGroup.windowId = windowId;
+  auto it = actionGroup.actions.begin();
+  while (it != actionGroup.actions.end())
+  {
+    if (it->holdTimeMs == action.holdTimeMs && it->hotkeys == action.hotkeys)
+      it = actionGroup.actions.erase(it);
+    else
+      it++;
+  }
   actionGroup.actions.insert(std::move(action));
 }
 
