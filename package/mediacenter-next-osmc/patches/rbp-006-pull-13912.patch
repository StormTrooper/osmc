From 8c64061e39fff323f31c99ac3c94fbc8eacccb63 Mon Sep 17 00:00:00 2001
From: fritsch <fritsch@kodi.tv>
Date: Mon, 21 May 2018 10:43:39 +0200
Subject: [PATCH 1/4] GUIFontTTF: Add missing offset to get limited values
 properly

---
 xbmc/guilib/GUIFontTTF.cpp | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/xbmc/guilib/GUIFontTTF.cpp b/xbmc/guilib/GUIFontTTF.cpp
index 4cddb3c88b5f..7c8c9e36872f 100644
--- a/xbmc/guilib/GUIFontTTF.cpp
+++ b/xbmc/guilib/GUIFontTTF.cpp
@@ -893,9 +893,9 @@ void CGUIFontTTFBase::RenderCharacter(float posX, float posY, const Character *c
 
   if (m_renderSystem->UseLimitedColorRange())
   {
-    r = (235 - 16) * r / 255;
-    g = (235 - 16) * g / 255;
-    b = (235 - 16) * b / 255;
+    r = (235 - 16) * r / 255 + 16;
+    g = (235 - 16) * g / 255 + 16;
+    b = (235 - 16) * b / 255 + 16;
   }
 #endif
 

From 403179c5eb6dee6ba773471446f50f58c4677517 Mon Sep 17 00:00:00 2001
From: fritsch <fritsch@kodi.tv>
Date: Mon, 21 May 2018 10:42:55 +0200
Subject: [PATCH 2/4] GUITexture: Fix transformation to Limited Range

---
 xbmc/guilib/GUITextureGL.cpp   | 6 +++---
 xbmc/guilib/GUITextureGLES.cpp | 6 +++---
 2 files changed, 6 insertions(+), 6 deletions(-)

diff --git a/xbmc/guilib/GUITextureGL.cpp b/xbmc/guilib/GUITextureGL.cpp
index e8eb0ec998d1..590801ccadb8 100644
--- a/xbmc/guilib/GUITextureGL.cpp
+++ b/xbmc/guilib/GUITextureGL.cpp
@@ -53,9 +53,9 @@ void CGUITextureGL::Begin(UTILS::Color color)
 
   if (m_renderSystem->UseLimitedColorRange())
   {
-    m_col[0] = (235 - 16) * m_col[0] / 255 + 16.0f / 255.0f;
-    m_col[1] = (235 - 16) * m_col[1] / 255 + 16.0f / 255.0f;
-    m_col[2] = (235 - 16) * m_col[2] / 255 + 16.0f / 255.0f;
+    m_col[0] = (235 - 16) * m_col[0] / 255 + 16;
+    m_col[1] = (235 - 16) * m_col[1] / 255 + 16;
+    m_col[2] = (235 - 16) * m_col[2] / 255 + 16;
   }
 
   bool hasAlpha = m_texture.m_textures[m_currentFrame]->HasAlpha() || m_col[3] < 255;
diff --git a/xbmc/guilib/GUITextureGLES.cpp b/xbmc/guilib/GUITextureGLES.cpp
index 833741e0cb23..8a84347085c3 100644
--- a/xbmc/guilib/GUITextureGLES.cpp
+++ b/xbmc/guilib/GUITextureGLES.cpp
@@ -54,9 +54,9 @@ void CGUITextureGLES::Begin(UTILS::Color color)
 
   if (CServiceBroker::GetWinSystem()->UseLimitedColor())
   {
-    m_col[0] = (235 - 16) * m_col[0] / 255 + 16.0f / 255.0f;
-    m_col[1] = (235 - 16) * m_col[1] / 255 + 16.0f / 255.0f;
-    m_col[2] = (235 - 16) * m_col[2] / 255 + 16.0f / 255.0f;
+    m_col[0] = (235 - 16) * m_col[0] / 255 + 16;
+    m_col[1] = (235 - 16) * m_col[1] / 255 + 16;
+    m_col[2] = (235 - 16) * m_col[2] / 255 + 16;
   }
 
   bool hasAlpha = m_texture.m_textures[m_currentFrame]->HasAlpha() || m_col[3] < 255;

From fb6da017df4928df152853682db0164c62375c62 Mon Sep 17 00:00:00 2001
From: fritsch <Peter.Fruehberger@gmail.com>
Date: Mon, 21 May 2018 11:05:45 +0200
Subject: [PATCH 3/4] SlideShowPicture: Fixup limited range conversion

---
 xbmc/pictures/SlideShowPicture.cpp | 12 ++++++------
 1 file changed, 6 insertions(+), 6 deletions(-)

diff --git a/xbmc/pictures/SlideShowPicture.cpp b/xbmc/pictures/SlideShowPicture.cpp
index 0feeaa1317b4..efa514071768 100644
--- a/xbmc/pictures/SlideShowPicture.cpp
+++ b/xbmc/pictures/SlideShowPicture.cpp
@@ -925,9 +925,9 @@ void CSlideShowPic::Render(float *x, float *y, CBaseTexture* pTexture, UTILS::Co
 
   if (CServiceBroker::GetWinSystem()->UseLimitedColor())
   {
-    colour[0] = (235 - 16) * colour[0] / 255 + 16.0f / 255.0f;
-    colour[1] = (235 - 16) * colour[1] / 255 + 16.0f / 255.0f;
-    colour[2] = (235 - 16) * colour[2] / 255 + 16.0f / 255.0f;
+    colour[0] = (235 - 16) * colour[0] / 255 + 16;
+    colour[1] = (235 - 16) * colour[1] / 255 + 16;
+    colour[2] = (235 - 16) * colour[2] / 255 + 16;
   }
 
   glUniform4f(uniColLoc,(colour[0] / 255.0f), (colour[1] / 255.0f),
@@ -996,9 +996,9 @@ void CSlideShowPic::Render(float *x, float *y, CBaseTexture* pTexture, UTILS::Co
 
   if (CServiceBroker::GetWinSystem()->UseLimitedColor())
   {
-    col[0] = (235 - 16) * col[0] / 255 + 16.0f / 255.0f;
-    col[1] = (235 - 16) * col[1] / 255 + 16.0f / 255.0f;
-    col[2] = (235 - 16) * col[2] / 255 + 16.0f / 255.0f;
+    col[0] = (235 - 16) * col[0] / 255 + 16;
+    col[1] = (235 - 16) * col[1] / 255 + 16;
+    col[2] = (235 - 16) * col[2] / 255 + 16;
   }
 
   for (int i=0; i<4; i++)

From ba8799ba0512e0ab11a23c188a48002aa442cdb8 Mon Sep 17 00:00:00 2001
From: fritsch <Peter.Fruehberger@gmail.com>
Date: Mon, 21 May 2018 11:11:10 +0200
Subject: [PATCH 4/4] RPRendererGuiTexture: Properly add offset on limited
 range conversion

---
 .../RetroPlayer/rendering/VideoRenderers/RPRendererGuiTexture.cpp   | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/xbmc/cores/RetroPlayer/rendering/VideoRenderers/RPRendererGuiTexture.cpp b/xbmc/cores/RetroPlayer/rendering/VideoRenderers/RPRendererGuiTexture.cpp
index bdac862d59f1..18469e93d205 100644
--- a/xbmc/cores/RetroPlayer/rendering/VideoRenderers/RPRendererGuiTexture.cpp
+++ b/xbmc/cores/RetroPlayer/rendering/VideoRenderers/RPRendererGuiTexture.cpp
@@ -210,9 +210,9 @@ void CRPRendererGuiTexture::RenderInternal(bool clear, uint8_t alpha)
 
   if (m_context.UseLimitedColor())
   {
-    colour[0] = (235 - 16) * colour[0] / 255;
-    colour[1] = (235 - 16) * colour[1] / 255;
-    colour[2] = (235 - 16) * colour[2] / 255;
+    colour[0] = (235 - 16) * colour[0] / 255 + 16;
+    colour[1] = (235 - 16) * colour[1] / 255 + 16;
+    colour[2] = (235 - 16) * colour[2] / 255 + 16;
   }
 
   glUniform4f(uniColLoc, (colour[0] / 255.0f), (colour[1] / 255.0f),
