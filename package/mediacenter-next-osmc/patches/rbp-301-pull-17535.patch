From 8ab755b9215ffd0f2cf41c6580a29a3bff200306 Mon Sep 17 00:00:00 2001
From: DaveTBlake <oak99sky@yahoo.co.uk>
Date: Sat, 21 Mar 2020 18:38:52 +0000
Subject: [PATCH] [JSON]Fix Player.GetProperties return of "currentaudiostream"
 and "audiostreams" data for PAPlayer. Include "sample rate".

---
 xbmc/cores/paplayer/PAPlayer.h                | 3 +++
 xbmc/interfaces/json-rpc/PlayerOperations.cpp | 4 +++-
 xbmc/interfaces/json-rpc/schema/types.json    | 3 ++-
 xbmc/interfaces/json-rpc/schema/version.txt   | 2 +-
 4 files changed, 9 insertions(+), 3 deletions(-)

diff --git a/xbmc/cores/paplayer/PAPlayer.h b/xbmc/cores/paplayer/PAPlayer.h
index 3e1c2c5f8169..98cb14e28ee2 100644
--- a/xbmc/cores/paplayer/PAPlayer.h
+++ b/xbmc/cores/paplayer/PAPlayer.h
@@ -52,6 +52,9 @@ friend class CQueueNextFileJob;
   void SeekTime(int64_t iTime = 0) override;
   void GetAudioCapabilities(std::vector<int> &audioCaps) override {}
 
+  int GetAudioStreamCount() override { return 1; }
+  int GetAudioStream() override { return 0; }
+
   static bool HandlesType(const std::string &type);
 
   // implementation of IJobCallback
diff --git a/xbmc/interfaces/json-rpc/PlayerOperations.cpp b/xbmc/interfaces/json-rpc/PlayerOperations.cpp
index 9ed10d8f88cb..e9249ad7c0b5 100644
--- a/xbmc/interfaces/json-rpc/PlayerOperations.cpp
+++ b/xbmc/interfaces/json-rpc/PlayerOperations.cpp
@@ -1697,6 +1697,7 @@ JSONRPC_STATUS CPlayerOperations::GetPropertyValue(PlayerType player, const std:
             result["codec"] = info.codecName;
             result["bitrate"] = info.bitrate;
             result["channels"] = info.channels;
+            result["samplerate"] = info.samplerate;
             AppendAudioStreamFlagsAsBooleans(result, info.flags);
           }
         }
@@ -1716,6 +1717,7 @@ JSONRPC_STATUS CPlayerOperations::GetPropertyValue(PlayerType player, const std:
     switch (player)
     {
       case Video:
+      case Audio:
         if (g_application.GetAppPlayer().HasPlayer())
         {
           for (int index = 0; index < g_application.GetAppPlayer().GetAudioStreamCount(); index++)
@@ -1730,6 +1732,7 @@ JSONRPC_STATUS CPlayerOperations::GetPropertyValue(PlayerType player, const std:
             audioStream["codec"] = info.codecName;
             audioStream["bitrate"] = info.bitrate;
             audioStream["channels"] = info.channels;
+            audioStream["samplerate"] = info.samplerate;
             AppendAudioStreamFlagsAsBooleans(audioStream, info.flags);
 
             result.append(audioStream);
@@ -1737,7 +1740,6 @@ JSONRPC_STATUS CPlayerOperations::GetPropertyValue(PlayerType player, const std:
         }
         break;
 
-      case Audio:
       case Picture:
       default:
         break;
diff --git a/xbmc/interfaces/json-rpc/schema/types.json b/xbmc/interfaces/json-rpc/schema/types.json
index 18e4e2f3693e..a31f8cc4ff27 100644
--- a/xbmc/interfaces/json-rpc/schema/types.json
+++ b/xbmc/interfaces/json-rpc/schema/types.json
@@ -233,7 +233,8 @@
       "channels": { "type": "integer", "required": true },
       "isdefault": { "type": "boolean", "required": true },
       "isoriginal": { "type": "boolean", "required": true },
-      "isimpaired": { "type": "boolean", "required": true }
+      "isimpaired": { "type": "boolean", "required": true },
+      "samplerate": { "type": "integer", "required": true }
     }
   },
   "Player.Video.Stream": {
diff --git a/xbmc/interfaces/json-rpc/schema/version.txt b/xbmc/interfaces/json-rpc/schema/version.txt
index 2b1b8b02aae4..e3e37900c9db 100644
--- a/xbmc/interfaces/json-rpc/schema/version.txt
+++ b/xbmc/interfaces/json-rpc/schema/version.txt
@@ -1 +1 @@
-JSONRPC_VERSION 11.7.0
+JSONRPC_VERSION 11.8.0
