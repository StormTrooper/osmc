From 7a0cd0b3e88c31726d3c96fed1c88724ff26d194 Mon Sep 17 00:00:00 2001
From: Rainer Hochecker <fernetmenta@online.de>
Date: Sun, 13 May 2018 21:31:22 +0200
Subject: [PATCH] fix getting user input for directory search

---
 xbmc/filesystem/Directory.cpp        |  2 ++
 xbmc/filesystem/VirtualDirectory.cpp |  4 ++--
 xbmc/filesystem/VirtualDirectory.h   |  3 +++
 xbmc/windows/GUIMediaWindow.cpp      | 19 +++++++++++++++++--
 4 files changed, 24 insertions(+), 4 deletions(-)

diff --git a/xbmc/filesystem/Directory.cpp b/xbmc/filesystem/Directory.cpp
index e3fde9ec84b6..6858c9601323 100644
--- a/xbmc/filesystem/Directory.cpp
+++ b/xbmc/filesystem/Directory.cpp
@@ -205,6 +205,8 @@ bool CDirectory::GetDirectory(const CURL& url, std::shared_ptr<IDirectory> pDire
         {
           if (!cancel)
           {
+            // @TODO ProcessRequirements() can bring up the keyboard input dialog
+            // filesystem must not depend on GUI
             if (g_application.IsCurrentThread() && pDirectory->ProcessRequirements())
             {
               authUrl.SetDomain("");
diff --git a/xbmc/filesystem/VirtualDirectory.cpp b/xbmc/filesystem/VirtualDirectory.cpp
index 39f78bf2465b..98ce2f997ae9 100644
--- a/xbmc/filesystem/VirtualDirectory.cpp
+++ b/xbmc/filesystem/VirtualDirectory.cpp
@@ -74,9 +74,9 @@ bool CVirtualDirectory::GetDirectory(const CURL& url, CFileItemList &items, bool
   if (!strPath.empty() && strPath != "files://")
   {
     CURL realURL = URIUtils::SubstitutePath(url);
-    m_pDir.reset(CDirectoryFactory::Create(realURL));
+    if (!m_pDir)
+      m_pDir.reset(CDirectoryFactory::Create(realURL));
     bool ret = CDirectory::GetDirectory(strPath, m_pDir, items, m_strFileMask, flags);
-    m_pDir.reset();
     return ret;
   }
 
diff --git a/xbmc/filesystem/VirtualDirectory.h b/xbmc/filesystem/VirtualDirectory.h
index fb4b71386588..a91f058b0328 100644
--- a/xbmc/filesystem/VirtualDirectory.h
+++ b/xbmc/filesystem/VirtualDirectory.h
@@ -60,6 +60,9 @@ namespace XFILE
 
     void AllowNonLocalSources(bool allow) { m_allowNonLocalSources = allow; };
 
+    std::shared_ptr<IDirectory> GetDirImpl() { return m_pDir; }
+    void ReleaseDirImpl() { m_pDir.reset(); }
+
   protected:
     void CacheThumbs(CFileItemList &items);
 
diff --git a/xbmc/windows/GUIMediaWindow.cpp b/xbmc/windows/GUIMediaWindow.cpp
index d79fb5d4aa4c..7ca6a52a587e 100644
--- a/xbmc/windows/GUIMediaWindow.cpp
+++ b/xbmc/windows/GUIMediaWindow.cpp
@@ -2166,12 +2166,27 @@ bool CGUIMediaWindow::GetDirectoryItems(CURL &url, CFileItemList &items, bool us
 {
   if (m_useBusyDialog)
   {
+    bool ret = true;
     CGetDirectoryItems getItems(m_rootDir, url, items, useDir);
     if (!CGUIDialogBusy::Wait(&getItems, 100, true))
     {
-      return false;
+      // cancelled
+      ret = false;
+    }
+    else if (!getItems.m_result)
+    {
+      if (g_application.IsCurrentThread() && !m_rootDir.GetDirImpl()->ProcessRequirements())
+      {
+        ret = false;
+      }
+      else if (!CGUIDialogBusy::Wait(&getItems, 100, true) || !getItems.m_result)
+      {
+        ret = false;
+      }
     }
-    return getItems.m_result;
+
+    m_rootDir.ReleaseDirImpl();
+    return ret;
   }
   else
   {
