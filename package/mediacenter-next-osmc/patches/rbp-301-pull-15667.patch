From 3767ff396b8867136c684825291402ab7a822568 Mon Sep 17 00:00:00 2001
From: James Hutchinson <jahutchinson99@googlemail.com>
Date: Mon, 18 Mar 2019 12:28:10 +0000
Subject: [PATCH] [AMLCodec] use decoder fps rate to accurately calculate
 video_rate

---
 .../cores/VideoPlayer/DVDCodecs/Video/AMLCodec.cpp | 14 ++++++++++++++
 xbmc/cores/VideoPlayer/DVDCodecs/Video/AMLCodec.h  |  1 +
 2 files changed, 15 insertions(+)

diff --git a/xbmc/cores/VideoPlayer/DVDCodecs/Video/AMLCodec.cpp b/xbmc/cores/VideoPlayer/DVDCodecs/Video/AMLCodec.cpp
index 82bf70596b34..8e199b478a76 100644
--- a/xbmc/cores/VideoPlayer/DVDCodecs/Video/AMLCodec.cpp
+++ b/xbmc/cores/VideoPlayer/DVDCodecs/Video/AMLCodec.cpp
@@ -2250,6 +2250,13 @@ void CAMLCodec::SetVideoRect(const CRect &SrcRect, const CRect &DestRect)
     SetVideoBrightness(brightness);
     m_brightness = brightness;
   }
+  // video rate adjustment.
+  unsigned int video_rate = GetDecoderVideoRate();
+  if (video_rate > 0 && video_rate != am_private->video_rate)
+  {
+    CLog::Log(LOGDEBUG, "CAMLCodec::SetVideoRect: decoder fps has changed, video_rate adjusted from %d to %d", am_private->video_rate, video_rate);
+    am_private->video_rate = video_rate;
+  }
 
   // video view mode
   int view_mode = m_processInfo.GetVideoSettings().m_ViewMode;
@@ -2395,3 +2402,10 @@ void CAMLCodec::SetVideoRate(int videoRate)
   if (am_private)
     am_private->video_rate = videoRate;
 }
+
+unsigned int CAMLCodec::GetDecoderVideoRate()
+{
+  struct vdec_status vs;
+  m_dll->codec_get_vdec_state(&am_private->vcodec, &vs);
+  return static_cast<unsigned int>(0.5 + (static_cast<float>(UNIT_FREQ) / static_cast<float>(vs.fps)));
+}
diff --git a/xbmc/cores/VideoPlayer/DVDCodecs/Video/AMLCodec.h b/xbmc/cores/VideoPlayer/DVDCodecs/Video/AMLCodec.h
index f7ec391a88ff..2f67ed72a6a6 100644
--- a/xbmc/cores/VideoPlayer/DVDCodecs/Video/AMLCodec.h
+++ b/xbmc/cores/VideoPlayer/DVDCodecs/Video/AMLCodec.h
@@ -66,6 +66,7 @@ class CAMLCodec
   void          SetVfmMap(const std::string &name, const std::string &map);
   int           DequeueBuffer();
   float         GetTimeSize();
+  unsigned int  GetDecoderVideoRate();
 
   DllLibAmCodec   *m_dll;
   bool             m_opened;
