From f9de04af3848d32132bc18a217c60efe3764b260 Mon Sep 17 00:00:00 2001
From: wsnipex <wsnipex@a1.net>
Date: Thu, 6 Dec 2018 17:10:41 +0100
Subject: [PATCH] [systeminfo] use timestamp for application build date from
 BUILDATE file, if it exists

---
 CMakeLists.txt                    |  2 ++
 cmake/scripts/common/Macros.cmake |  6 ++++++
 xbmc/Application.cpp              |  2 +-
 xbmc/CompileInfo.cpp.in           | 11 +++++++++++
 xbmc/CompileInfo.h                |  1 +
 xbmc/utils/SystemInfo.cpp         |  2 +-
 6 files changed, 22 insertions(+), 2 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 28024af9fe95..fa2061c2b545 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -227,6 +227,7 @@ add_custom_command(OUTPUT ${CORE_BUILD_DIR}/xbmc/CompileInfo.cpp
                                             -DARCH_DEFINES="${ARCH_DEFINES}"
                                             -DAPP_SCMID=${APP_SCMID}
                                             -DAPP_COPYRIGHT_YEARS=${APP_COPYRIGHT_YEARS}
+                                            -DAPP_BUILD_DATE=${APP_BUILD_DATE}
                                             -Dprefix=${CMAKE_BINARY_DIR}/${CORE_BUILD_DIR}
                                             -P ${CMAKE_SOURCE_DIR}/cmake/scripts/common/GenerateVersionedFiles.cmake
                    DEPENDS ${CMAKE_SOURCE_DIR}/version.txt
@@ -488,6 +489,7 @@ if(VERBOSE)
   message(STATUS "BINARY: ${APP_NAME_LC}${APP_BINARY_SUFFIX}")
   message(STATUS "#---------------------------------------------#")
   message(STATUS "GIT_REV: ${APP_SCMID}")
+  message(STATUS "Build date: ${APP_BUILD_DATE}")
   message(STATUS "#---------------------------------------------#")
   message(STATUS "CPACK_GENERATOR       : ${CPACK_GENERATOR}")
   message(STATUS "CPACK_SOURCE_GENERATOR: ${CPACK_SOURCE_GENERATOR}")
diff --git a/cmake/scripts/common/Macros.cmake b/cmake/scripts/common/Macros.cmake
index cf1f241b3e76..8f457ad8de61 100644
--- a/cmake/scripts/common/Macros.cmake
+++ b/cmake/scripts/common/Macros.cmake
@@ -653,12 +653,18 @@ function(core_find_git_rev stamp)
                       WORKING_DIRECTORY ${CMAKE_SOURCE_DIR})
       string(REPLACE "\"" "" DATE ${DATE})
       string(REPLACE "-" "" DATE ${DATE})
+
+      # build date
+      string(TIMESTAMP APP_BUILD_DATE "%Y%m%d" UTC)
+      set(APP_BUILD_DATE ${APP_BUILD_DATE} PARENT_SCOPE)
     else()
       if(EXISTS ${CMAKE_SOURCE_DIR}/BUILDDATE)
         file(STRINGS ${CMAKE_SOURCE_DIR}/BUILDDATE DATE LIMIT_INPUT 8)
       else()
         string(TIMESTAMP DATE "%Y%m%d" UTC)
       endif()
+      set(APP_BUILD_DATE ${DATE} PARENT_SCOPE)
+
       if(EXISTS ${CMAKE_SOURCE_DIR}/VERSION)
         file(STRINGS ${CMAKE_SOURCE_DIR}/VERSION HASH LIMIT_INPUT 16)
       else()
diff --git a/xbmc/Application.cpp b/xbmc/Application.cpp
index 715c4e616c34..3c7c398987ac 100644
--- a/xbmc/Application.cpp
+++ b/xbmc/Application.cpp
@@ -450,7 +450,7 @@ bool CApplication::Create(const CAppParamParser &params)
 //  specialVersion = " (version for XXXX)";
 #endif
   CLog::Log(LOGNOTICE, "Using %s %s x%d build%s", buildType.c_str(), CSysInfo::GetAppName().c_str(), g_sysinfo.GetXbmcBitness(), specialVersion.c_str());
-  CLog::Log(LOGNOTICE, "%s compiled " __DATE__ " by %s for %s %s %d-bit %s (%s)", CSysInfo::GetAppName().c_str(), g_sysinfo.GetUsedCompilerNameAndVer().c_str(), g_sysinfo.GetBuildTargetPlatformName().c_str(),
+  CLog::Log(LOGNOTICE, "%s compiled %s by %s for %s %s %d-bit %s (%s)", CSysInfo::GetAppName().c_str(), CSysInfo::GetBuildDate(), g_sysinfo.GetUsedCompilerNameAndVer().c_str(), g_sysinfo.GetBuildTargetPlatformName().c_str(),
             g_sysinfo.GetBuildTargetCpuFamily().c_str(), g_sysinfo.GetXbmcBitness(), g_sysinfo.GetBuildTargetPlatformVersionDecoded().c_str(),
             g_sysinfo.GetBuildTargetPlatformVersion().c_str());
 
diff --git a/xbmc/CompileInfo.cpp.in b/xbmc/CompileInfo.cpp.in
index eef78ba052b7..7e4d884ef8d2 100644
--- a/xbmc/CompileInfo.cpp.in
+++ b/xbmc/CompileInfo.cpp.in
@@ -59,3 +59,14 @@ const char* CCompileInfo::GetCopyrightYears()
 {
   return "@APP_COPYRIGHT_YEARS@";
 }
+
+const char* CCompileInfo::GetBuildDate()
+{
+  const std::string bdate = "@APP_BUILD_DATE@";
+  if (!bdate.empty())
+  {
+    std::string datestamp = bdate.substr(0, 4) + "-" + bdate.substr(4, 2) + "-" + bdate.substr(6, 2);
+    return datestamp.c_str();
+  }
+  return "1970-01-01";
+}
diff --git a/xbmc/CompileInfo.h b/xbmc/CompileInfo.h
index 855711e5f7d6..c92d24083a43 100644
--- a/xbmc/CompileInfo.h
+++ b/xbmc/CompileInfo.h
@@ -19,4 +19,5 @@ class CCompileInfo
   static const char *GetSuffix();  // Git "Tag", e.g. alpha1
   static const char* GetSCMID();   // Git Revision
   static const char* GetCopyrightYears();
+  static const char* GetBuildDate();
 };
diff --git a/xbmc/utils/SystemInfo.cpp b/xbmc/utils/SystemInfo.cpp
index cf6519a4eb53..df5e043a3a5a 100644
--- a/xbmc/utils/SystemInfo.cpp
+++ b/xbmc/utils/SystemInfo.cpp
@@ -1243,7 +1243,7 @@ std::string CSysInfo::GetVersion()
 
 std::string CSysInfo::GetBuildDate()
 {
-  return StringUtils::Format("%s", __DATE__);
+  return CCompileInfo::GetBuildDate();
 }
 
 bool CSysInfo::HasVideoToolBoxDecoder()
