From ae0c218ece436ae46673a7470ae46f64c1837f53 Mon Sep 17 00:00:00 2001
From: peak3d <pfau@peak3d.de>
Date: Sun, 5 Jul 2020 12:34:48 +0200
Subject: [PATCH] Bump mariadb connector version from 3.0.3 -> 3.1.9

---
 tools/depends/target/mariadb/01-android.patch | 23 +++++++++----------
 tools/depends/target/mariadb/Makefile         | 11 ++++++---
 2 files changed, 19 insertions(+), 15 deletions(-)

diff --git a/tools/depends/target/mariadb/01-android.patch b/tools/depends/target/mariadb/01-android.patch
index 1087cd5dd8ff..4e397d507968 100644
--- a/tools/depends/target/mariadb/01-android.patch
+++ b/tools/depends/target/mariadb/01-android.patch
@@ -1,10 +1,9 @@
 --- a/cmake/CheckIncludeFiles.cmake
 +++ b/cmake/CheckIncludeFiles.cmake
-@@ -74,3 +74,12 @@
- CHECK_INCLUDE_FILES (unistd.h HAVE_UNISTD_H)
- CHECK_INCLUDE_FILES (utime.h HAVE_UTIME_H)
- CHECK_INCLUDE_FILES (ucontext.h HAVE_UCONTEXT_H)
-+IF(HAVE_UCONTEXT_H)
+@@ -50,4 +50,11 @@
+ CHECK_INCLUDE_FILES (ucontext.h HAVE_FILE_UCONTEXT_H)
+ IF(NOT HAVE_FILE_UCONTEXT_H)
+   CHECK_INCLUDE_FILES (sys/ucontext.h HAVE_FILE_UCONTEXT_H)
 +  CHECK_FUNCTION_EXISTS (getcontext HAVE_GETCONTEXT)
 +  CHECK_FUNCTION_EXISTS (makecontext HAVE_MAKECONTEXT)
 +  CHECK_FUNCTION_EXISTS (setcontext HAVE_SETCONTEXT)
@@ -12,11 +11,11 @@
 +  IF(NOT HAVE_GETCONTEXT OR NOT HAVE_MAKECONTEXT OR NOT HAVE_SETCONTEXT OR NOT HAVE_SWAPCONTEXT)
 +    SET(HAVE_UCONTEXT_H 0 CACHE INTERNAL "")
 +  ENDIF()
-+ENDIF(HAVE_UCONTEXT_H)
+ ENDIF()
 --- a/cmake/CheckTypes.cmake
 +++ b/cmake/CheckTypes.cmake
-@@ -25,6 +25,7 @@
- CHECK_TYPE_SIZE(off_t SIZEOF_OFF_T)
+@@ -22,6 +22,7 @@
+ SET(CMAKE_EXTRA_INCLUDE_FILES sys/types.h)
  CHECK_TYPE_SIZE(uchar SIZEOF_UCHAR)
  CHECK_TYPE_SIZE(uint SIZEOF_UINT)
 +CHECK_TYPE_SIZE(ushort SIZEOF_USHORT)
@@ -25,7 +24,7 @@
  CHECK_TYPE_SIZE(uint8 SIZEOF_UINT8)
 --- a/include/ma_config.h.in
 +++ b/include/ma_config.h.in
-@@ -217,6 +217,11 @@
+@@ -85,6 +85,11 @@
  # define HAVE_UINT 1
  #endif
  
@@ -35,11 +34,11 @@
 +#endif
 +
  #cmakedefine SIZEOF_ULONG @SIZEOF_ULONG@
- #if SIZEOF_ULONG
+ #if defined(SIZEOF_ULONG)
  # define HAVE_ULONG 1
 --- a/include/ma_global.h
 +++ b/include/ma_global.h
-@@ -272,6 +272,8 @@
+@@ -268,6 +268,8 @@
  
  #if defined(__EMX__) || !defined(HAVE_UINT)
  typedef unsigned int uint;
@@ -50,7 +49,7 @@
  
 --- a/libmariadb/CMakeLists.txt
 +++ b/libmariadb/CMakeLists.txt
-@@ -291,7 +291,6 @@
+@@ -311,7 +311,6 @@
    IF(ICONV_INCLUDE_DIR)
       INCLUDE_DIRECTORIES(BEFORE ${ICONV_INCLUDE_DIR}) 
    ENDIF()
diff --git a/tools/depends/target/mariadb/Makefile b/tools/depends/target/mariadb/Makefile
index ff810583c105..a16124932327 100644
--- a/tools/depends/target/mariadb/Makefile
+++ b/tools/depends/target/mariadb/Makefile
@@ -2,11 +2,17 @@ include ../../Makefile.include
 DEPS= ../../Makefile.include Makefile 01-android.patch
 
 LIBNAME=mariadb
-VERSION=3.0.3
+VERSION=3.1.9
 ARCHIVE=$(LIBNAME)-connector-c-$(VERSION)-src.tar.gz
 
 LIBDYLIB=$(PLATFORM)/build/lib$(LIBNAME)/lib$(LIBNAME)client.a
 
+# build all plugins as static
+PLUGIN_BUILD_FLAGS=-DCLIENT_PLUGIN_DIALOG=STATIC -DAUTH_GSSAPI_PLUGIN_TYPE=OFF
+PLUGIN_BUILD_FLAGS+=-DCLIENT_PLUGIN_SHA256_PASSWORD=STATIC -DCLIENT_PLUGIN_CACHING_SHA2_PASSWORD=STATIC
+PLUGIN_BUILD_FLAGS+=-DCLIENT_PLUGIN_MYSQL_CLEAR_PASSWORD=STATIC -DCLIENT_PLUGIN_MYSQL_OLD_PASSWORD=STATIC
+PLUGIN_BUILD_FLAGS+=-DCLIENT_PLUGIN_CLIENT_ED25519=OFF
+
 all: .installed-$(PLATFORM)
 
 $(TARBALLS_LOCATION)/$(ARCHIVE):
@@ -16,8 +22,7 @@ $(PLATFORM): $(TARBALLS_LOCATION)/$(ARCHIVE) $(DEPS)
 	rm -rf $(PLATFORM); mkdir -p $(PLATFORM)/build
 	cd $(PLATFORM); $(ARCHIVE_TOOL) $(ARCHIVE_TOOL_FLAGS) $(TARBALLS_LOCATION)/$(ARCHIVE)
 	cd $(PLATFORM); patch -p1 -i ../01-android.patch
-	sed -ie 's| "DYNAMIC" | "STATIC" |' $(PLATFORM)/cmake/plugins.cmake
-	cd $(PLATFORM)/build; $(CMAKE) -DAUTH_GSSAPI=OFF -DWITH_UNITTEST:BOOL=OFF -DWITH_EXTERNAL_ZLIB:BOOL=ON -DWITH_CURL:BOOL=OFF ..
+	cd $(PLATFORM)/build; $(CMAKE) $(PLUGIN_BUILD_FLAGS) -DWITH_UNIT_TESTS:BOOL=OFF -DWITH_EXTERNAL_ZLIB:BOOL=ON -DWITH_CURL:BOOL=OFF ..
 
 $(LIBDYLIB): $(PLATFORM)
 	$(MAKE) -C $(PLATFORM)/build
